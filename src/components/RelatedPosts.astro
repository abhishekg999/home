---
import { getCollection, type CollectionEntry } from "astro:content";
import { formatDate, getReadingTime } from "../utils/blog";

interface Props {
  currentPost: CollectionEntry<"blog">;
}

const { currentPost } = Astro.props;

const allPosts = (await getCollection("blog")).filter(
  (post) => post.slug !== currentPost.slug,
);

const getRelatedPosts = () => {
  const currentTags = currentPost.data.tags || [];

  const postsWithScore = allPosts.map((post) => {
    let score = 0;
    const postTags = post.data.tags || [];

    postTags.forEach((tag) => {
      if (currentTags.includes(tag)) {
        score += 3;
      }
    });

    const daysDiff = Math.abs(
      (post.data.date.getTime() - currentPost.data.date.getTime()) /
        (1000 * 60 * 60 * 24),
    );
    if (daysDiff < 90) {
      score += 1;
    }

    return { post, score };
  });

  postsWithScore.sort((a, b) => {
    if (b.score !== a.score) return b.score - a.score;
    return b.post.data.date.getTime() - a.post.data.date.getTime();
  });

  return postsWithScore.slice(0, 3).map((item) => item.post);
};

const relatedPosts = getRelatedPosts();
---

{
  relatedPosts.length > 0 && (
    <section class="mt-14 pt-10 border-t border-white/10">
      <h2 class="text-sm font-medium text-white/40 mb-6 uppercase tracking-wider">
        Related
      </h2>
      <div class="space-y-0">
        {relatedPosts.map((post) => {
          const year = post.data.date.getFullYear().toString();
          return (
            <a href={`/blog/${post.slug}`} class="group block relative">
              <div class="border-t border-white/10 py-5 transition-all duration-300 hover:bg-white/[0.02]">
                <div class="flex items-center gap-4">
                  <div class="w-10 h-10 flex items-center justify-center flex-shrink-0 bg-white/5 border border-white/10 group-hover:border-accent/30 transition-all duration-300">
                    <span class="text-xs font-medium text-white/60 font-mono">
                      '{year.slice(-2)}
                    </span>
                  </div>

                  <div class="flex-grow min-w-0">
                    <h3 class="text-sm font-medium text-white/80 group-hover:text-accent transition-colors mb-1">
                      {post.data.title}
                    </h3>

                    <div class="flex items-center gap-3 text-[10px] font-mono text-white/30">
                      <time>{formatDate(post.data.date)}</time>
                      <span>{getReadingTime(post.body)}</span>
                    </div>
                  </div>

                  <svg
                    class="w-3 h-3 text-white/20 group-hover:text-white/50 group-hover:translate-x-1 transition-all flex-shrink-0"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="square"
                      stroke-linejoin="miter"
                      stroke-width={2}
                      d="M17 8l4 4m0 0l-4 4m4-4H3"
                    />
                  </svg>
                </div>

                <div class="absolute left-0 top-0 w-0.5 h-0 group-hover:h-full transition-all duration-300 bg-accent" />
              </div>
            </a>
          );
        })}
        <div class="border-t border-white/10" />
      </div>
    </section>
  )
}
