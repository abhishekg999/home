---
import { getCollection, type CollectionEntry } from "astro:content";
import { formatDate, getReadingTime } from "../utils/blog";

interface Props {
  currentPost: CollectionEntry<"blog">;
}

const { currentPost } = Astro.props;

const allPosts = (await getCollection("blog")).filter(
  (post) => post.slug !== currentPost.slug,
);

const getRelatedPosts = () => {
  const currentTags = currentPost.data.tags || [];

  const postsWithScore = allPosts.map((post) => {
    let score = 0;
    const postTags = post.data.tags || [];

    postTags.forEach((tag) => {
      if (currentTags.includes(tag)) {
        score += 3;
      }
    });

    const daysDiff = Math.abs(
      (post.data.date.getTime() - currentPost.data.date.getTime()) /
        (1000 * 60 * 60 * 24),
    );
    if (daysDiff < 90) {
      score += 1;
    }

    return { post, score };
  });

  postsWithScore.sort((a, b) => {
    if (b.score !== a.score) return b.score - a.score;
    return b.post.data.date.getTime() - a.post.data.date.getTime();
  });

  return postsWithScore.slice(0, 3).map((item) => item.post);
};

const relatedPosts = getRelatedPosts();
---

{
  relatedPosts.length > 0 && (
    <section class="mt-12 md:mt-16 pt-8 md:pt-12 border-t border-white/10">
      <h2 class="text-lg md:text-2xl font-bold text-white mb-6 md:mb-8">
        Related Articles
      </h2>
      <div class="space-y-0">
        {relatedPosts.map((post) => {
          const year = post.data.date.getFullYear().toString();
          return (
            <a href={`/blog/${post.slug}`} class="group block relative">
              <div class="border-t border-white/10 py-4 md:py-6 transition-all duration-300 hover:bg-white/[0.02]">
                <div class="flex items-start lg:items-center gap-3 md:gap-4 lg:gap-8">
                  <div class="w-10 h-10 md:w-12 md:h-12 lg:w-14 lg:h-14 flex items-center justify-center flex-shrink-0 bg-white/5 border border-white/10 group-hover:bg-white/10 group-hover:border-[#67d78e]/30 transition-all duration-300">
                    <span class="text-xs md:text-sm lg:text-base font-semibold text-white/90 font-mono">
                      '{year.slice(-2)}
                    </span>
                  </div>

                  <div class="flex-grow min-w-0">
                    <h3 class="text-sm md:text-lg lg:text-xl font-semibold text-white group-hover:text-[#67d78e] transition-colors mb-1.5 md:mb-2">
                      {post.data.title}
                    </h3>

                    <div class="flex items-center gap-2 md:gap-3 text-xs font-mono text-white/40">
                      <time>{formatDate(post.data.date)}</time>
                      <span>{getReadingTime(post.body)}</span>
                    </div>
                  </div>

                  <svg
                    class="hidden lg:block w-4 h-4 text-white/30 group-hover:text-white/60 group-hover:translate-x-1 transition-all flex-shrink-0"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="square"
                      stroke-linejoin="miter"
                      stroke-width={2}
                      d="M17 8l4 4m0 0l-4 4m4-4H3"
                    />
                  </svg>
                </div>

                <div class="absolute left-0 top-0 w-1 h-0 group-hover:h-full transition-all duration-300 bg-[#67d78e]" />
              </div>
            </a>
          );
        })}
        <div class="border-t border-white/10" />
      </div>
    </section>
  )
}
